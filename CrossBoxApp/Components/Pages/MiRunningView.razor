@page "/mi-running"
@using CrossBoxApp.Models
@using CrossBoxApp.Models.Services
@inject NavigationManager Nav
@inject HttpClient Http
@inject SesionService Sesion

<div class="main-layout">

    <div class="navbar-container">
        <div class="nav-left" @onclick="Volver">
            <i class="fas fa-arrow-left"></i> VOLVER
        </div>
        <div class="nav-title">MI BITÁCORA</div>
        <div class="nav-right"></div>
    </div>

    <div class="scrollable-content">
        
        @* CONTROLES DEL MES *@
        <div class="month-control fade-in">
            <button class="btn-nav" @onclick="MesAnterior"><i class="fas fa-chevron-left"></i></button>
            <span class="month-label">@fechaActual.ToString("MMMM yyyy").ToUpper()</span>
            <button class="btn-nav" @onclick="MesSiguiente"><i class="fas fa-chevron-right"></i></button>
        </div>

        @* CALENDARIO *@
        <div class="calendar-grid fade-in">
            <div class="day-name">DOM</div> <div class="day-name">LUN</div> <div class="day-name">MAR</div>
            <div class="day-name">MIE</div> <div class="day-name">JUE</div> <div class="day-name">VIE</div>
            <div class="day-name">SAB</div>

            @for (int i = 0; i < diasVaciosInicio; i++)
            {
                <div class="calendar-day empty"></div>
            }

            @for (int dia = 1; dia <= diasEnMes; dia++)
            {
                int diaActual = dia;
                var log = ObtenerLog(diaActual);
                bool hayPlan = log != null;
                bool estaHecho = hayPlan && (log.Realizado == true);

                // Colores dinámicos
                string colorBorde = hayPlan ? ObtenerColorTipo(log.Tipo) : "#333";
                string bgDia = hayPlan ? "rgba(30,30,30,0.9)" : "#1a1a1a";
                string opacidad = hayPlan ? "1" : "0.5";

                <div class="calendar-day"
                     style="border-color: @colorBorde; background: @bgDia; opacity: @opacidad"
                     @onclick="() => AbrirModal(diaActual)">

                    <span class="day-number">@dia</span>

                    @if (hayPlan)
                    {
                        <div class="day-content">
                            @if (estaHecho)
                            {
                                <i class="fas fa-check-circle" style="color:#28a745; font-size:1.4rem;"></i>
                                <span class="day-status" style="color:#28a745">HECHO</span>
                            }
                            else
                            {
                                <i class="fas fa-running" style="color: @colorBorde; font-size:1.4rem;"></i>
                                <span class="day-status" style="color: @colorBorde">@log.Tipo</span>
                            }
                        </div>
                    }
                </div>
            }
        </div>
        
        <div style="height: 40px;"></div>
    </div>
</div>

@* --- MODAL REDISEÑADO --- *@
@if (mostrarModal && logSeleccionado != null)
{
    <div class="modal-overlay fade-in">
        <div class="modal-content custom-modal slide-up">
            
            @* HEADER CON COLOR DEL TIPO DE ENTRENO *@
            <div class="modal-header" style="background: @ObtenerColorTipo(logSeleccionado.Tipo)">
                <div class="header-info">
                    <span class="header-date">@fechaSeleccionada.ToString("dd MMMM").ToUpper()</span>
                    <span class="header-type">@logSeleccionado.Tipo</span>
                </div>
                <button class="btn-close-custom" @onclick="CerrarModal"><i class="fas fa-times"></i></button>
            </div>

            <div class="modal-body">
                
                @* TARJETA DEL PLAN DEL COACH *@
                <div class="coach-card">
                    <div class="card-label"><i class="fas fa-clipboard-list"></i> PLAN DEL COACH</div>
                    <h4 class="plan-title">@logSeleccionado.Titulo</h4>
                    <p class="plan-desc">@logSeleccionado.Descripcion</p>
                </div>

                <div class="action-divider"></div>

                @* SECCIÓN DE FEEDBACK DEL ATLETA *@
                <div class="feedback-section">
                    
                    <div class="status-toggle-row">
                        <label class="section-label">ESTADO:</label>
                        <div class="status-pill @(logSeleccionado.Realizado == true ? "done" : "pending")" @onclick="ToggleRealizado">
                            @if (logSeleccionado.Realizado == true)
                            {
                                <i class="fas fa-check-circle"></i> <span>ENTRENAMIENTO COMPLETADO</span>
                            }
                            else
                            {
                                <i class="far fa-circle"></i> <span>NO REALIZADO</span>
                            }
                        </div>
                    </div>

                    @if (logSeleccionado.Realizado == true)
                    {
                        <div class="fade-in mt-3">
                            <label class="section-label">INTENSIDAD (RPE 1-10):</label>
                            <div class="rpe-container">
                                @for (int i = 1; i <= 10; i++)
                                {
                                    int val = i;
                                    <div class="rpe-btn @(logSeleccionado.RPE == val ? "active" : "")"
                                         style="--rpe-color: @ObtenerColorRPE(val)"
                                         @onclick="() => SeleccionarRPE(val)">
                                        @val
                                    </div>
                                }
                            </div>
                            <div class="rpe-legend">
                                <span>Suave</span>
                                <span>Máximo</span>
                            </div>

                            <label class="section-label mt-3">TUS SENSACIONES:</label>
                            <textarea @bind="logSeleccionado.ComentariosAtleta" 
                                      class="feedback-textarea" 
                                      placeholder="Ej: Me sentí fuerte en las subidas..."></textarea>
                        </div>
                    }
                </div>

            </div>

            <div class="modal-footer">
                <button class="btn-cancel" @onclick="CerrarModal">CERRAR</button>
                @if (logSeleccionado.Realizado == true)
                {
                    <button class="btn-save" @onclick="GuardarFeedback">GUARDAR REPORTE</button>
                }
            </div>
        </div>
    </div>
}

<style>
    /* --- ESTRUCTURA BASE --- */
    .main-layout {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background-color: #0d0d0d; display: flex; flex-direction: column; z-index: 1;
    }

    .navbar-container {
        flex-shrink: 0; padding-top: calc(env(safe-area-inset-top) + 5px);
        padding-bottom: 10px; padding-left: 20px; padding-right: 20px;
        background-color: #0d0d0d; border-bottom: 1px solid #F8C545;
        color: white; display: flex; justify-content: space-between; align-items: center;
        z-index: 100; font-family: 'Oswald'; min-height: 60px;
    }

    .nav-left { color: #F8C545; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }
    .nav-title { font-weight: bold; font-size: 1.1rem; color: white; letter-spacing: 1px; }
    .nav-right { width: 60px; }

    .scrollable-content {
        flex-grow: 1; overflow-y: auto; padding: 15px;
        display: flex; flex-direction: column; align-items: center;
        -webkit-overflow-scrolling: touch; padding-bottom: 40px;
    }

    /* --- CALENDARIO (Mantenido igual, funciona bien) --- */
    .month-control {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 15px; background: #1a1a1a; padding: 10px;
        border-radius: 8px; border: 1px solid #333; width: 100%; max-width: 500px;
    }
    .month-label { font-family: 'Oswald'; font-size: 1.2rem; color: #F8C545; }
    .btn-nav { background: none; border: none; color: white; font-size: 1.5rem; width: 40px; }

    .calendar-grid {
        display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px;
        width: 100%; max-width: 500px;
    }
    .day-name { text-align: center; color: #666; font-size: 0.7rem; font-weight: bold; margin-bottom: 5px; }
    .calendar-day {
        background: #1a1a1a; border: 1px solid #333; border-radius: 6px;
        min-height: 75px; padding: 4px; position: relative; cursor: pointer;
        display: flex; flex-direction: column; justify-content: space-between;
    }
    .calendar-day.empty { background: transparent; border: none; cursor: default; }
    .day-number { font-size: 0.8rem; font-weight: bold; align-self: flex-end; color: #aaa; }
    .day-content { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; margin-top: -15px; }
    .day-status { font-size: 0.5rem; font-weight: bold; margin-top: 2px; text-transform: uppercase; text-align: center; line-height: 1; }

    /* --- MODAL ESTILO PREMIUM --- */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
    .custom-modal { 
        background: #121212; width: 90%; max-width: 400px; 
        border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; 
        max-height: 90vh; border: 1px solid #333;
        box-shadow: 0 20px 50px rgba(0,0,0,0.8);
    }
    
    .modal-header { 
        padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; 
        /* El background se pone inline dinámico */
    }
    .header-info { display: flex; flex-direction: column; }
    .header-date { font-family: 'Oswald'; font-size: 1.2rem; font-weight: bold; color: black; line-height: 1; }
    .header-type { font-family: 'Roboto'; font-size: 0.8rem; font-weight: 900; color: rgba(0,0,0,0.7); text-transform: uppercase; }
    .btn-close-custom { background: rgba(0,0,0,0.1); border: none; font-size: 1.2rem; width: 35px; height: 35px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; }

    .modal-body { padding: 20px; color: white; overflow-y: auto; background-color: #121212; }

    /* TARJETA DEL PLAN (COACH) */
    .coach-card {
        background: linear-gradient(145deg, #1e1e1e, #252525);
        border-left: 4px solid #F8C545;
        border-radius: 8px; padding: 15px; margin-bottom: 20px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    .card-label { color: #F8C545; font-size: 0.75rem; font-weight: bold; margin-bottom: 5px; font-family: 'Oswald'; letter-spacing: 1px; }
    .plan-title { font-family: 'Oswald'; font-size: 1.3rem; color: white; margin-bottom: 8px; line-height: 1.2; }
    .plan-desc { font-size: 0.95rem; color: #ccc; white-space: pre-line; font-family: 'Roboto'; line-height: 1.5; }

    .action-divider { height: 1px; background: #333; margin-bottom: 20px; }

    /* SECCIÓN FEEDBACK */
    .section-label { color: #888; font-size: 0.8rem; font-weight: bold; display: block; margin-bottom: 8px; font-family: 'Roboto'; letter-spacing: 0.5px; }

    /* Status Pill (Botón Grande) */
    .status-pill {
        background: #222; border: 1px solid #444; border-radius: 50px;
        padding: 12px 20px; cursor: pointer; display: flex; align-items: center; gap: 10px;
        transition: all 0.3s;
    }
    .status-pill i { font-size: 1.2rem; }
    .status-pill span { font-weight: bold; font-family: 'Oswald'; font-size: 1rem; letter-spacing: 0.5px; }
    
    .status-pill.pending { color: #aaa; }
    .status-pill.pending:active { transform: scale(0.98); background: #333; }
    
    .status-pill.done { 
        background: rgba(40, 167, 69, 0.2); border-color: #28a745; color: #28a745; 
        box-shadow: 0 0 15px rgba(40, 167, 69, 0.1);
    }

    /* RPE Selector Estilizado */
    .rpe-container { display: flex; justify-content: space-between; gap: 4px; margin-bottom: 5px; }
    .rpe-btn {
        flex: 1; height: 35px; border-radius: 4px; background: #222; border: 1px solid #333;
        color: #666; font-weight: bold; display: flex; align-items: center; justify-content: center;
        font-size: 0.9rem; cursor: pointer; transition: all 0.2s;
    }
    .rpe-btn.active {
        background: var(--rpe-color); color: black; border-color: var(--rpe-color);
        transform: scale(1.1); box-shadow: 0 0 10px var(--rpe-color); z-index: 10;
    }
    .rpe-legend { display: flex; justify-content: space-between; font-size: 0.7rem; color: #555; margin-bottom: 15px; }

    /* Textarea */
    .feedback-textarea {
        width: 100%; background: #1a1a1a; border: 1px solid #333; color: white;
        border-radius: 8px; padding: 12px; font-family: 'Roboto'; font-size: 0.95rem;
        outline: none; resize: none; min-height: 80px;
    }
    .feedback-textarea:focus { border-color: #F8C545; background: #222; }

    /* Footer */
    .modal-footer { padding: 15px 20px; display: flex; gap: 15px; background: #1a1a1a; border-top: 1px solid #2a2a2a; }
    .btn-save { 
        background: #F8C545; color: black; border: none; padding: 12px; font-weight: bold; flex: 2; 
        border-radius: 8px; font-family: 'Oswald'; text-transform: uppercase; letter-spacing: 1px;
        box-shadow: 0 4px 15px rgba(248, 197, 69, 0.2);
    }
    .btn-cancel { 
        background: transparent; color: #888; border: 1px solid #444; padding: 12px; 
        font-weight: bold; flex: 1; border-radius: 8px; font-family: 'Oswald'; 
    }

    .fade-in { animation: fadeIn 0.4s ease; }
    .slide-up { animation: slideUp 0.3s ease; }
    @@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @@keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
</style>

@code {
    private DateTime fechaActual = DateTime.Today;
    private List<RunningLogs> logsDelMes = new List<RunningLogs>();
    private int diasEnMes;
    private int diasVaciosInicio;

    // Modal
    private bool mostrarModal = false;
    private RunningLogs logSeleccionado;
    private DateTime fechaSeleccionada;

    class TipoEntreno { public string Nombre { get; set; } public string Color { get; set; } }

    private List<TipoEntreno> TiposEntreno = new List<TipoEntreno>
    {
        new TipoEntreno { Nombre = "Acumulativo", Color = "#00BFFF" },
        new TipoEntreno { Nombre = "Intensidad", Color = "#FF4500" },
        new TipoEntreno { Nombre = "Tempo", Color = "#FF8C00" },
        new TipoEntreno { Nombre = "Cuestas", Color = "#9370DB" },
        new TipoEntreno { Nombre = "Fuerza", Color = "#808080" },
        new TipoEntreno { Nombre = "Regenerativo", Color = "#32CD32" },
        new TipoEntreno { Nombre = "Otro", Color = "#FFFFFF" }
    };

    protected override async Task OnInitializedAsync()
    {
        await CargarCalendario();
    }

    private async Task CargarCalendario()
    {
        if (Sesion.Usuario == null) return;

        diasEnMes = DateTime.DaysInMonth(fechaActual.Year, fechaActual.Month);
        var primerDiaMes = new DateTime(fechaActual.Year, fechaActual.Month, 1);
        diasVaciosInicio = (int)primerDiaMes.DayOfWeek;

        try
        {
            logsDelMes = await Http.GetFromJsonAsync<List<RunningLogs>>($"https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/runningapi/plan/{Sesion.Usuario.UsuarioID}/{fechaActual.Month}/{fechaActual.Year}");
        }
        catch { logsDelMes = new List<RunningLogs>(); }
    }

    private RunningLogs ObtenerLog(int dia) => logsDelMes.FirstOrDefault(l => l.Fecha.Day == dia);

    private string ObtenerColorTipo(string tipo)
    {
        var t = TiposEntreno.FirstOrDefault(x => x.Nombre == tipo);
        return t != null ? t.Color : "#F8C545";
    }

    private async Task MesAnterior() { fechaActual = fechaActual.AddMonths(-1); await CargarCalendario(); }
    private async Task MesSiguiente() { fechaActual = fechaActual.AddMonths(1); await CargarCalendario(); }

    private void AbrirModal(int dia)
    {
        var log = ObtenerLog(dia);
        if (log != null)
        {
            logSeleccionado = log;
            if (logSeleccionado.Realizado == null) logSeleccionado.Realizado = false;
            fechaSeleccionada = new DateTime(fechaActual.Year, fechaActual.Month, dia);
            mostrarModal = true;
        }
    }

    private void ToggleRealizado()
    {
        bool estadoActual = logSeleccionado.Realizado ?? false;
        logSeleccionado.Realizado = !estadoActual;
    }

    private void SeleccionarRPE(int valor) => logSeleccionado.RPE = valor;

    private async Task GuardarFeedback()
    {
        try
        {
            var resp = await Http.PostAsJsonAsync("https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/runningapi/guardar-feedback", logSeleccionado);
            if (resp.IsSuccessStatusCode)
            {
                mostrarModal = false;
                await App.Current.MainPage.DisplayAlert("¡Excelente!", "Reporte guardado correctamente.", "OK");
                await CargarCalendario();
            }
        }
        catch (Exception ex) { await App.Current.MainPage.DisplayAlert("Error", ex.Message, "OK"); }
    }

    private string ObtenerColorRPE(int valor)
    {
        if (valor <= 2) return "#32CD32"; // Verde
        if (valor <= 4) return "#ADFF2F"; // Verde claro
        if (valor <= 6) return "#FFD700"; // Amarillo
        if (valor <= 8) return "#FF8C00"; // Naranja
        return "#FF0000";                 // Rojo
    }

    private void CerrarModal() => mostrarModal = false;
    private void Volver() => Nav.NavigateTo("/home");
}