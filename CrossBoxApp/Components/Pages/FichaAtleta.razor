@page "/ficha-atleta"
@using System.Net.Http.Json
@using System.Net.Http.Headers
@using CrossBoxApp.Models.Services
@inject NavigationManager Nav
@inject HttpClient Http
@inject SesionService Sesion
@inject IJSRuntime JS

<div class="main-layout">
    @* NAVBAR *@
    <div class="navbar-container">
        <div class="nav-left" @onclick='() => Nav.NavigateTo("/home")'>
            <i class="fas fa-arrow-left"></i> VOLVER
        </div>
        <div class="nav-title">MI FICHA</div>
        <div class="nav-right text-end">
            @if (ficha != null && !string.IsNullOrEmpty(ficha.FotoUrl))
            {
                <i class="fas fa-palette nav-icon me-3" @onclick="AbrirModalColores"></i>
                <i class="fas fa-tags nav-icon me-3" @onclick="AbrirModalSubtitulos"></i>
                <i class="fas fa-camera nav-icon" @onclick="ActivarCambioFoto"></i>
            }
        </div>
    </div>

    <div class="content-area">
        @if (cargando)
        {
            <div class="spinner-border text-warning mt-5"></div>
        }
        else if (string.IsNullOrEmpty(ficha?.FotoUrl) || solicitandoFoto)
        {
            <div class="upload-photo-section slide-in">
                <i class="fas fa-user-astronaut empty-avatar-icon"></i>
                <h2>¡PREPARA TU CARTA!</h2>
                <p>Sube tu foto principal.</p>
                <div class="upload-box">
                    <i class="fas fa-upload mb-2" style="font-size:2rem; color:#F8C545;"></i>
                    <button class="btn-subir mt-2" @onclick="IrAPerfil">IR A MI PERFIL</button>
                </div>
                @if (solicitandoFoto && !string.IsNullOrEmpty(ficha?.FotoUrl))
                {
                    <button class="btn-cancelar mt-3" @onclick="() => solicitandoFoto = false">CANCELAR</button>
                }
            </div>
        }
        else
        {
            @* CARTA ESTÁTICA *@
            <div class="card-scene fade-in"
                 style="--c-main: @(ficha.ColorPrimario); --c-accent: @(ficha.ColorTexto); --c-nums: @(ficha.ColorNumeros); --c-detalles: @(ficha.ColorDetalles); --c-bg1: @(ficha.ColorFondo1); --c-bg2: @(ficha.ColorFondo2); --bg-custom: url('@(ficha.FondoCustomUrl)'); --m-opacity: @(ficha.OpacidadMedallas.ToString(System.Globalization.CultureInfo.InvariantCulture));">
                 
                <div class="esports-card @(ficha.Textura ?? "")">
                    
                    @if (!string.IsNullOrEmpty(ficha.FondoCustomUrl))
                    {
                        <div class="custom-bg-layer" 
                             style="background-image: url('@(ficha.FondoCustomUrl)'); 
                                    filter: @ficha.FiltroFondo; 
                                    opacity: @(ficha.OpacidadFondo.ToString(System.Globalization.CultureInfo.InvariantCulture));">
                        </div>
                    }

                    <div class="holo-overlay"></div>
                    
                    @* CABECERA *@
                    <div class="card-top">
                        <div class="stats-left">
                            @* NUEVA MATEMÁTICA DE OVR: Incluye Intermedio (+2) y Principiante (+1) *@
                            @{ int ovr = (ficha.Rx * 4) + (ficha.Avanzado * 3) + (ficha.Intermedio * 2) + (ficha.Principiante * 1) + 70; }
                            
                            @* OVR CON NUEVO ESTILO (Sin text-stroke, con doble sombra) *@
                            <span class="rating">@ovr</span>
                            <span class="position">OVR <i class="fas fa-info-circle info-btn" @onclick="AbrirModalInfo"></i></span>
                            
                            <div class="level-badge @ObtenerClaseMedalla(ovr)">
                                @if (ovr >= 370) { <span><i class="fas fa-fire"></i> ÉLITE</span> }
                                else if (ovr >= 300) { <span><i class="fas fa-medal"></i> PRO</span> }
                                else if (ovr >= 225) { <span><i class="fas fa-star"></i> AVANZADO</span> }
                                else if (ovr >= 150) { <span><i class="fas fa-shield-alt"></i> INTERMEDIO</span> }
                                else { <span><i class="fas fa-seedling"></i> NOVATO</span> }
                            </div>

                            @if (!string.IsNullOrEmpty(ficha.LogoBoxUrl))
                            {
                                <img src="@ficha.LogoBoxUrl" class="card-box-logo mt-3" />
                            }
                        </div>
                        <div class="photo-right">
                            <div class="card-photo-wrapper">
                                <img src="@ficha.FotoUrl" class="player-photo" style="filter: @ficha.FiltroFoto;" />
                            </div>
                        </div>
                    </div>

                    @* NOMBRE Y STATS *@
                    <div class="card-name-plate">
                        <h1>@ficha.Nombre</h1>
                        <span class="card-quote">"@ficha.Subtitulo"</span>
                        <div class="divider-line"></div>
                    </div>

                    <div class="middle-stats-container">
                        <div class="stat-column">
                            <span class="stat-value">@ficha.DiasEntrenadosAnio</span>
                            <span class="stat-title">ASISTENCIAS @DateTime.Now.Year</span>
                        </div>
                        <div class="middle-divider"></div>
                        <div class="stat-column medals-column">
                            @if(ficha.Rx == 0 && ficha.Avanzado == 0 && ficha.Intermedio == 0 && ficha.Principiante == 0)
                            {
                                <span class="stat-value">0</span>
                                <span class="stat-title">MEDALLAS</span>
                            }
                            else
                            {
                                <div class="medals-badges-container">
                                    @if (ficha.Rx > 0) { <span class="m-tag rx">RX @ficha.Rx</span> }
                                    @if (ficha.Avanzado > 0) { <span class="m-tag av">AV @ficha.Avanzado</span> }
                                    @if (ficha.Intermedio > 0) { <span class="m-tag in">IN @ficha.Intermedio</span> }
                                    @if (ficha.Principiante > 0) { <span class="m-tag pr">PR @ficha.Principiante</span> }
                                </div>
                                <span class="stat-title" style="margin-top: 4px;">COLECCIÓN</span>
                            }
                        </div>
                    </div>

                    <div class="divider-line mb-2 mt-1"></div>

                    @* PRS *@
                    <div class="prs-grid">
                        @foreach (var pr in ficha.PRs)
                        {
                            <div class="pr-item">
                                <div class="pr-val">@pr.Marca.ToString("0.##") <span class="pr-unit">@pr.Unidad</span></div>
                                <span class="pr-lbl">@pr.Ejercicio</span>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@* --- MODAL INFO RANGOS --- *@
@if (mostrarModalInfo)
{
    <div class="modal-overlay fade-in" @onclick="() => mostrarModalInfo = false">
        <div class="modal-content custom-modal" style="height: auto; max-height: 80vh;" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h5>SISTEMA DE RANGOS</h5>
                <button class="btn-icon-header" @onclick="() => mostrarModalInfo = false"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body scroll-custom">
                <p style="color:#aaa; font-size:0.85rem; text-align:center; margin-bottom: 20px; line-height: 1.4;">
                    Empiezas con <strong style="color:white;">70 Puntos (OVR)</strong>.<br>
                    Cada medalla que ganes te acerca a ser Élite:<br>
                    <strong style="color:#ff4d4d;">RX: +4 pts</strong> | <strong style="color:#FFD700;">AVANZADO: +3 pts</strong><br>
                    <strong style="color:#B0C4DE;">INTERMEDIO: +2 pts</strong> | <strong style="color:#CD7F32;">PRINCIPIANTE: +1 pt</strong>
                </p>

                <div class="rank-list">
                    <div class="rank-item">
                        <div class="level-badge badge-elite" style="font-size: 0.9rem; padding: 5px 15px;"><span><i class="fas fa-fire"></i> ÉLITE</span></div>
                        <span class="rank-pts">370+ PTS</span>
                    </div>
                    <div class="rank-item">
                        <div class="level-badge badge-pro" style="font-size: 0.9rem; padding: 5px 15px;"><span><i class="fas fa-medal"></i> PRO</span></div>
                        <span class="rank-pts">300 - 369 PTS</span>
                    </div>
                    <div class="rank-item">
                        <div class="level-badge badge-avanzado" style="font-size: 0.9rem; padding: 5px 15px;"><span><i class="fas fa-star"></i> AVANZADO</span></div>
                        <span class="rank-pts">225 - 299 PTS</span>
                    </div>
                    <div class="rank-item">
                        <div class="level-badge badge-intermedio" style="font-size: 0.9rem; padding: 5px 15px;"><span><i class="fas fa-shield-alt"></i> INTERMEDIO</span></div>
                        <span class="rank-pts">150 - 224 PTS</span>
                    </div>
                    <div class="rank-item">
                        <div class="level-badge badge-novato" style="font-size: 0.9rem; padding: 5px 15px;"><span><i class="fas fa-seedling"></i> NOVATO</span></div>
                        <span class="rank-pts">70 - 149 PTS</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@* --- MODAL DE SUBTÍTULOS (ESTILOS RESTAURADOS) --- *@
@if (mostrarModalSubtitulos)
{
    <div class="modal-overlay fade-in" @onclick="CerrarModalSubtitulos">
        <div class="modal-content custom-modal" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h5>ELIGE TU LEMA</h5>
                <button class="btn-icon-header" @onclick="CerrarModalSubtitulos"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-tabs">
                <div class="tab-btn @(tabActiva == "Comedia" ? "active" : "")" @onclick='() => tabActiva = "Comedia"'>Divertidos</div>
                <div class="tab-btn @(tabActiva == "Motivacional" ? "active" : "")" @onclick='() => tabActiva = "Motivacional"'>Motivacionales</div>
            </div>
            <div class="modal-body scroll-custom">
                <div class="frases-grid">
                    @foreach(var frase in listaSubtitulos.Where(f => f.Categoria == tabActiva))
                    {
                        <div class="frase-item @(ficha?.Subtitulo == frase.Texto ? "selected" : "")" @onclick="() => SeleccionarFrase(frase.Texto)">
                            <i class="fas fa-quote-left quote-mark"></i> <span>@frase.Texto</span>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}

@* --- MODAL DE DISEÑO --- *@
@if (mostrarModalColores)
{
    <div class="modal-overlay fade-in" @onclick="IntentoCerrarModalColores">
        <div class="modal-content custom-modal" style="height: auto; max-height: 90vh;" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h5>PERSONALIZAR</h5>
                <button class="btn-icon-header" @onclick="CerrarModalColores"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body scroll-custom">
                
                @* 1. FOTO DE PERFIL *@
                <div class="color-picker-group">
                    <label><i class="fas fa-user-circle"></i> FILTRO FOTO PERFIL</label>
                    <div class="filters-row">
                        <button class="btn-filter @(ficha.FiltroFoto == "none" ? "active" : "")" @onclick='() => ficha.FiltroFoto = "none"'>Normal</button>
                        <button class="btn-filter @(ficha.FiltroFoto == "grayscale(100%)" ? "active" : "")" @onclick='() => ficha.FiltroFoto = "grayscale(100%)"'>B&N</button>
                        <button class="btn-filter @(ficha.FiltroFoto == "sepia(80%)" ? "active" : "")" @onclick='() => ficha.FiltroFoto = "sepia(80%)"'>Sepia</button>
                        <button class="btn-filter @(ficha.FiltroFoto == "contrast(120%) saturate(150%)" ? "active" : "")" @onclick='() => ficha.FiltroFoto = "contrast(120%) saturate(150%)"'>Épico</button>
                    </div>
                </div>

                @* 2. IMAGEN DE FONDO CUSTOM *@
                <div class="color-picker-group mt-3">
                    <label><i class="fas fa-image"></i> IMAGEN DE FONDO</label>
                    
                    <div class="upload-bg-box">
                        <InputFile OnChange="SubirFondoCustom" accept="image/*" id="bg-upload" style="display:none;" />
                        <label for="bg-upload" class="btn-upload-bg">
                            @if(subiendoFondo) { <i class="fas fa-spinner fa-spin"></i> <span>SUBIENDO...</span> }
                            else { <i class="fas fa-upload"></i> <span>CARGAR FONDO PROPIO</span> }
                        </label>
                        @if (!string.IsNullOrEmpty(ficha.FondoCustomUrl))
                        {
                            <button class="btn-quitar-bg mt-2" @onclick="QuitarFondoCustom"><i class="fas fa-trash"></i> QUITAR FONDO</button>
                            
                            <div class="bg-controls fade-in mt-3">
                                <label style="font-size: 0.8rem;"><i class="fas fa-adjust"></i> FILTRO DEL FONDO</label>
                                <div class="filters-row mt-1 mb-3">
                                    <button class="btn-filter @(ficha.FiltroFondo == "none" ? "active" : "")" @onclick='() => ficha.FiltroFondo = "none"'>Normal</button>
                                    <button class="btn-filter @(ficha.FiltroFondo == "grayscale(100%)" ? "active" : "")" @onclick='() => ficha.FiltroFondo = "grayscale(100%)"'>B&N</button>
                                    <button class="btn-filter @(ficha.FiltroFondo == "sepia(80%)" ? "active" : "")" @onclick='() => ficha.FiltroFondo = "sepia(80%)"'>Sepia</button>
                                    <button class="btn-filter @(ficha.FiltroFondo == "blur(3px)" ? "active" : "")" @onclick='() => ficha.FiltroFondo = "blur(3px)"'>Borrosito</button>
                                </div>

                                <label style="font-size: 0.8rem;"><i class="fas fa-eye"></i> OPACIDAD (TRANSPARENCIA)</label>
                                <div class="range-container">
                                    <span style="color:#888; font-size: 0.8rem;">Suave</span>
                                    <input type="range" class="custom-range" min="0.1" max="1" step="0.05" @bind="ficha.OpacidadFondo" @bind:event="oninput" />
                                    <span style="color:#888; font-size: 0.8rem;">Sólido</span>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                @* 3. COLORES DE TEXTO *@
                <div class="color-picker-group mt-3">
                    <label><i class="fas fa-font"></i> COLOR DE TEXTO (Nombres y Títulos)</label>
                    <input type="color" @bind="ficha.ColorTexto" class="color-input" />
                </div>

                <div class="color-picker-group mt-3">
                    <label><i class="fas fa-sort-numeric-up-alt"></i> COLOR DE NÚMEROS (Stats y PRs)</label>
                    <input type="color" @bind="ficha.ColorNumeros" class="color-input" />
                </div>
                <div class="color-picker-group mt-3">
                    <label><i class="fas fa-paint-brush"></i> COLOR DE DETALLES (Frase y Unidades)</label>
                    <input type="color" @bind="ficha.ColorDetalles" class="color-input" />
                </div>

                @* 4. COLORES BASE *@
                <div class="color-picker-group mt-3">
                    <label><i class="fas fa-bolt"></i> COLOR PRINCIPAL (Bordes)</label>
                    <input type="color" @bind="ficha.ColorPrimario" class="color-input" />
                </div>
                
                <div class="color-picker-group mt-3">
                    <label><i class="fas fa-fill-drip"></i> COLOR DE FONDO 1</label>
                    <input type="color" @bind="ficha.ColorFondo1" class="color-input" />
                </div>
                <div class="color-picker-group mt-3">
                    <label><i class="fas fa-fill"></i> COLOR DE FONDO 2</label>
                    <input type="color" @bind="ficha.ColorFondo2" class="color-input" />
                </div>
                <div class="color-picker-group mt-3">
                    <label style="font-size: 0.9rem;"><i class="fas fa-medal"></i> OPACIDAD FONDO MEDALLAS</label>
                    <div class="range-container">
                        <span style="color:#888; font-size: 0.8rem;">0%</span>
                        <input type="range" class="custom-range" min="0" max="1" step="0.05" @bind="ficha.OpacidadMedallas" @bind:event="oninput" />
                        <span style="color:#888; font-size: 0.8rem;">100%</span>
                    </div>
                </div>

                @* 5. TEXTURAS *@
                <div class="color-picker-group mt-3">
                    <label><i class="fas fa-layer-group"></i> TEXTURA BASE</label>
                    <div class="texture-grid">
                        <div class="texture-item @(ficha.Textura == "" ? "selected" : "")" @onclick='() => ficha.Textura = ""'><span>LISA</span></div>
                        <div class="texture-item carbon @(ficha.Textura == "carbon" ? "selected" : "")" @onclick='() => ficha.Textura = "carbon"'><span>CARBONO</span></div>
                        <div class="texture-item metal @(ficha.Textura == "metal" ? "selected" : "")" @onclick='() => ficha.Textura = "metal"'><span>METAL</span></div>
                        <div class="texture-item geo @(ficha.Textura == "geo" ? "selected" : "")" @onclick='() => ficha.Textura = "geo"'><span>PUNTOS</span></div>
                    </div>
                </div>

                <div class="botones-colores mt-4 mb-3">
                    <button class="btn-restaurar" @onclick="RestaurarColores">
                        <i class="fas fa-undo"></i> ORIGINAL
                    </button>
                    <button class="btn-guardar-colores" @onclick="GuardarColores">
                        @if (guardandoColores) { <i class="fas fa-spinner fa-spin"></i> } else { <span>GUARDAR</span> }
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .main-layout { position: fixed; top:0; left:0; width:100vw; height:100vh; background:#050505; display:flex; flex-direction:column; z-index:1; }
    .navbar-container { flex-shrink:0; padding-top: calc(env(safe-area-inset-top) + 10px); padding-bottom:10px; padding-left:20px; padding-right:20px; background:#111; border-bottom:1px solid #F8C545; display:flex; justify-content:space-between; align-items:center; z-index:100; font-family:'Oswald'; color:white; }
    .nav-icon { color:#F8C545; font-size:1.4rem; cursor:pointer; transition:0.2s; }
    .nav-icon:active { transform:scale(0.9); }
    .content-area { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; overflow:hidden; background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%); }

    /* ESTILOS PARA LA PANTALLA DE SUBIR FOTO ARREGLADOS */
    .upload-photo-section { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; width: 100%; text-align: center; padding: 20px; z-index: 10; position: relative; }
    .empty-avatar-icon { font-size: 4rem; color: #444; margin-bottom: 20px; }
    .upload-photo-section h2 { font-family: 'Oswald'; color: #fff; font-size: 2rem; margin-bottom: 10px; text-transform: uppercase; }
    .upload-photo-section p { color: #aaa; font-size: 1rem; margin-bottom: 30px; }
    .upload-box { background: rgba(255,255,255,0.05); border: 2px dashed #444; border-radius: 15px; padding: 30px; width: 100%; max-width: 300px; display: flex; flex-direction: column; align-items: center; }
    .btn-subir { background: #F8C545; color: #000; font-family: 'Oswald'; font-weight: bold; font-size: 1.1rem; padding: 12px 25px; border: none; border-radius: 50px; cursor: pointer; width: 100%; box-shadow: 0 5px 15px rgba(248,197,69,0.3); transition: 0.2s; }
    .btn-subir:active { transform: scale(0.95); }
    .btn-cancelar { background: transparent; color: #ff4d4d; border: 1px solid #ff4d4d; padding: 10px 20px; border-radius: 50px; font-family: 'Oswald'; font-weight: bold; width: 100%; max-width: 300px; cursor: pointer; transition: 0.2s; }
    .btn-cancelar:active { background: rgba(255,77,77,0.1); }

    /* CARTA ESTÁTICA */
    .card-scene { display:flex; flex-direction:column; justify-content:center; align-items:center; width:100%; height: 100%; position:relative; }
    .esports-card {
        width: 88vw; max-width: 420px; height: 72vh; max-height: 650px;
        background: linear-gradient(145deg, var(--c-bg1) 0%, var(--c-bg2) 100%);
        border: 3px solid var(--c-main);
        box-shadow: 0 20px 40px rgba(0,0,0,0.8), inset 0 0 20px rgba(0,0,0,0.5);
        border-radius: 20px; position: relative; overflow: hidden;
    }
    
    .custom-bg-layer {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background-size: cover; background-position: center; background-repeat: no-repeat;
        z-index: 1; pointer-events: none;
    }

    .esports-card.carbon::before { content:''; position:absolute; top:0; left:0; width:100%; height:100%; background: repeating-linear-gradient(45deg, rgba(255,255,255,0.06) 0px, rgba(255,255,255,0.06) 3px, transparent 3px, transparent 6px); z-index: 2; pointer-events: none; }
    .esports-card.metal::before { content:''; position:absolute; top:0; left:0; width:100%; height:100%; background: linear-gradient(90deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 20%, rgba(255,255,255,0.1) 40%, rgba(255,255,255,0) 60%, rgba(255,255,255,0.1) 80%); z-index: 2; pointer-events: none; }
    .esports-card.geo::before { content:''; position:absolute; top:0; left:0; width:100%; height:100%; background-image: radial-gradient(rgba(255,255,255,0.15) 1.5px, transparent 1.5px); background-size: 12px 12px; z-index: 2; pointer-events: none; }

    .holo-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: linear-gradient(105deg, transparent 20%, var(--c-main) 25%, transparent 30%); background-size: 200% 200%; mix-blend-mode: color-dodge; opacity: 0.5; pointer-events: none; z-index: 10; animation: holoSweep 4s infinite linear; }

    .card-top, .card-name-plate, .middle-stats-container, .prs-grid, .divider-line { position:relative; z-index:3; }

    .card-top { display:flex; height:45%; padding:20px; }
    .stats-left { width: 35%; display:flex; flex-direction:column; align-items:flex-start; justify-content:flex-start; padding-top:10px; border-right:2px solid rgba(255,255,255,0.1); }
    
    /* OVR CORREGIDO: DOBLE SOMBRA PARA MAXIMA LEGIBILIDAD SIN CONTORNO FEO */
    .rating { 
        font-family:'Oswald'; font-size:4.5rem; font-weight:900; line-height:0.9; 
        color:var(--c-nums); 
        text-shadow: 
            2px 2px 0 #000, 
            -1px -1px 0 #000, 
            1px -1px 0 #000, 
            -1px 1px 0 #000, 
            4px 4px 10px rgba(0,0,0,0.9);
    }
    .position { font-family:'Oswald'; font-size:1.4rem; color:var(--c-accent); font-weight:bold; margin-bottom:15px; text-shadow: 1px 1px 3px #000;}
    .info-btn { font-size: 0.9rem; color: #aaa; cursor: pointer; margin-left: 5px; transition: 0.2s; }
    .info-btn:active { color: #fff; }
    
    .card-box-logo { width:55px; height:55px; border-radius:50%; border:2px solid var(--c-main); background:#000; object-fit:contain; padding:2px; }
    
    /* MEDALLAS DE RANGO INDEPENDIENTES */
    .level-badge { 
        color: #fff; 
        padding: 4px 10px; 
        border-radius: 6px; 
        font-family: 'Oswald'; 
        font-weight: bold; 
        font-size: 0.75rem; 
        display: inline-flex; 
        align-items: center; 
        gap: 5px; 
        text-transform: uppercase; 
        box-shadow: 0 4px 8px rgba(0,0,0,0.6); 
        position: relative; 
        overflow: hidden;
        border: 1px solid rgba(255,255,255,0.2);
        text-shadow: 1px 1px 2px #000;
    }
    
    .badge-novato { background: linear-gradient(135deg, #8E5A34, #5C3A21); }
    .badge-intermedio { background: linear-gradient(135deg, #B0C4DE, #778899); }
    .badge-avanzado { background: linear-gradient(135deg, #FFD700, #B8860B); color: #000; text-shadow: none; border-color: #fff; }
    .badge-pro { background: linear-gradient(135deg, #6f2da8, #301934); border-color: #9370DB; }
    .badge-elite { 
        background: linear-gradient(135deg, #ff0000, #ff7f00); 
        animation: fireBorder 1s infinite alternate; 
        border: 2px solid #fff;
    }

    .level-badge::after {
        content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
        transform: skewX(-20deg); animation: shineBadge 3s infinite;
    }

    .photo-right { width: 65%; display:flex; justify-content:center; align-items:center; }
    .card-photo-wrapper { width: 100%; height: 100%; max-height:220px; max-width: 170px; border: 3px solid var(--c-main); border-radius: 12px; background: #000; overflow: hidden; box-shadow: 0 10px 20px rgba(0,0,0,0.8); }
    .player-photo { width: 100%; height: 100%; object-fit: cover; object-position: center; transition: filter 0.3s; }

    .card-name-plate { text-align:center; padding: 0 15px; margin-top: 15px; }
    .card-name-plate h1 { font-family:'Oswald'; font-size:2.4rem; font-weight:900; color:var(--c-accent); text-transform:uppercase; margin:0; line-height:1.1; text-shadow: 2px 2px 5px #000; letter-spacing:1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    
    /* FRASE CORREGIDA: MÁS GRUESA Y VISIBLE */
    .card-quote { font-family:'Roboto'; font-style:italic; font-weight: bold; font-size:0.95rem; color: var(--c-detalles); display:block; margin-bottom:5px; text-shadow: 1px 1px 3px #000; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .divider-line { height:2px; background: linear-gradient(90deg, transparent, var(--c-accent), transparent); margin: 10px auto; width: 85%; }

    .middle-stats-container { display: flex; justify-content: center; align-items: center; padding: 10px 15px; gap: 20px; }
    .stat-column { display: flex; flex-direction: column; align-items: center; flex: 1; }
    .middle-divider { width: 2px; height: 40px; background: rgba(255,255,255,0.2); }
    .stat-value { font-family: 'Oswald'; font-size: 1.8rem; font-weight: bold; color: var(--c-nums); line-height: 1; text-shadow: 1px 1px 3px #000; }
    .stat-title { font-family: 'Roboto'; font-size: 0.75rem; color: var(--c-detalles); font-weight: bold; letter-spacing: 1px; margin-top: 4px; text-transform: uppercase; text-align:center; text-shadow: 1px 1px 2px #000; }
    
    .medals-badges-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; }
    .m-tag { font-family: 'Oswald'; font-size: 0.75rem; padding: 3px 6px; border-radius: 4px; font-weight: bold; position: relative; overflow: hidden; z-index: 1; text-shadow: 1px 1px 2px #000; }
    .m-tag::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: var(--m-opacity); z-index: -1; }

    .m-tag.rx { color: #ff4d4d; border: 1px solid #ff4d4d; }
    .m-tag.rx::before { background: #ff4d4d; }
    .m-tag.av { color: #FFD700; border: 1px solid #FFD700; }
    .m-tag.av::before { background: #FFD700; }
    .m-tag.in { color: #B0C4DE; border: 1px solid #B0C4DE; }
    .m-tag.in::before { background: #B0C4DE; }
    .m-tag.pr { color: #CD7F32; border: 1px solid #CD7F32; }
    .m-tag.pr::before { background: #CD7F32; }

    .prs-grid { display:grid; grid-template-columns: repeat(3, 1fr); gap:15px 5px; padding: 15px; }
    .pr-item { display:flex; flex-direction:column; align-items:center; width: 100%; overflow: hidden; }
    .pr-val { font-family:'Oswald'; font-size:1.5rem; font-weight:bold; color:var(--c-nums); line-height:1; display:flex; align-items:baseline; gap: 3px; text-shadow: 1px 1px 3px #000; }
    .pr-unit { font-family:'Roboto'; font-size:0.75rem; color: var(--c-detalles); font-weight:normal; }
    .pr-lbl { font-family:'Roboto'; font-size:0.75rem; color:var(--c-accent); font-weight:bold; text-transform:uppercase; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; text-align: center; text-shadow: 1px 1px 2px #000; }

    /* MODALES ESTILOS COMUNES */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.85); z-index: 5000; display: flex; justify-content: center; align-items: flex-end; padding-bottom: calc(env(safe-area-inset-bottom) + 0px); }
    .custom-modal { background: #1a1a1a; width: 100%; height: 70vh; border-top-left-radius: 25px; border-top-right-radius: 25px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 -10px 40px rgba(0,0,0,0.9); animation: slideUp 0.3s ease-out; }
    .modal-header { padding: 20px 25px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; background:#111; }
    .modal-header h5 { margin:0; color:#F8C545; font-family:'Oswald'; letter-spacing:1px; font-size: 1.2rem; }
    .btn-icon-header { background: none; border: none; color: #888; font-size: 1.4rem; cursor: pointer; padding: 5px; }
    .modal-body { padding: 20px; overflow-y: auto; flex: 1; -webkit-overflow-scrolling: touch; }

    /* ESTILOS DEL MODAL DE SUBTITULOS ARREGLADOS */
    .modal-tabs { display:flex; border-bottom:1px solid #333; background:#111; }
    .tab-btn { flex:1; text-align:center; padding:15px; color:#888; font-family:'Oswald'; font-size:1rem; cursor:pointer; border-bottom: 3px solid transparent; transition:0.3s;}
    .tab-btn.active { color:#F8C545; border-bottom: 3px solid #F8C545; font-weight:bold; background:rgba(255,255,255,0.02);}
    .frases-grid { display:flex; flex-direction:column; gap:12px; padding-bottom:30px; }
    .frase-item { background:#222; border:1px solid #333; padding:18px; border-radius:12px; color:#ddd; font-style:italic; font-size:1rem; cursor:pointer; display:flex; align-items:center; gap:15px; transition:0.2s;}
    .frase-item.selected { border-color:#F8C545; background:rgba(248, 197, 69, 0.15); color:white; font-weight:bold;}
    .quote-mark { color:#555; font-size:1.4rem; }
    .selected .quote-mark { color:#F8C545; }
    
    /* MODAL COLORES Y DEMÁS */
    .color-picker-group { display: flex; flex-direction: column; gap: 8px; background: #222; padding: 15px; border-radius: 12px; border: 1px solid #333; }
    .color-picker-group label { color: white; font-family: 'Oswald'; font-size: 0.9rem; letter-spacing: 1px; }
    .color-input { width: 100%; height: 50px; border: none; border-radius: 8px; cursor: pointer; padding: 0; background: none; }
    .color-input::-webkit-color-swatch-wrapper { padding: 0; }
    .color-input::-webkit-color-swatch { border: 2px solid #444; border-radius: 8px; }
    
    .filters-row { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; -webkit-overflow-scrolling: touch; }
    .btn-filter { flex-shrink: 0; background: #111; color: #aaa; border: 1px solid #444; padding: 8px 15px; border-radius: 50px; font-family: 'Oswald'; font-size: 0.9rem; cursor: pointer; transition: 0.2s; }
    .btn-filter.active { background: #F8C545; color: #000; border-color: #F8C545; font-weight: bold; }

    .upload-bg-box { display: flex; flex-direction: column; gap: 10px; }
    .btn-upload-bg { width: 100%; background: #28a745; color: white; border: none; padding: 12px; border-radius: 8px; font-family: 'Oswald'; font-size: 1rem; text-align: center; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; box-shadow: 0 4px 10px rgba(40,167,69,0.3); }
    .btn-quitar-bg { width: 100%; background: transparent; color: #ff4d4d; border: 1px solid #ff4d4d; padding: 10px; border-radius: 8px; font-family: 'Oswald'; font-size: 0.9rem; text-align: center; }
    
    .bg-controls { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; }
    .range-container { display: flex; align-items: center; gap: 10px; }
    .custom-range { flex: 1; -webkit-appearance: none; height: 5px; border-radius: 5px; background: #444; outline: none; }
    .custom-range::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 50%; background: #F8C545; cursor: pointer; }

    .texture-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
    .texture-item { aspect-ratio: 1/1; background: #333; border: 2px solid #444; border-radius: 8px; cursor: pointer; display: flex; justify-content: center; align-items: center; font-family: 'Oswald'; font-size: 0.7rem; color: #aaa; position: relative; overflow: hidden; transition: 0.2s; }
    .texture-item span { position: relative; z-index: 2; }
    .texture-item.selected { border-color: #F8C545; color: #F8C545; font-weight: bold; }
    .texture-item.carbon::before { content:''; position:absolute; top:0; left:0; width:100%; height:100%; background: repeating-linear-gradient(45deg, rgba(255,255,255,0.1) 0px, rgba(255,255,255,0.1) 3px, transparent 3px, transparent 6px); z-index: 1; }
    .texture-item.metal::before { content:''; position:absolute; top:0; left:0; width:100%; height:100%; background: linear-gradient(90deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 50%, rgba(255,255,255,0.2) 100%); z-index: 1; }
    .texture-item.geo::before { content:''; position:absolute; top:0; left:0; width:100%; height:100%; background-image: radial-gradient(rgba(255,255,255,0.2) 1.5px, transparent 1.5px); background-size: 8px 8px; z-index: 1; }

    .botones-colores { display: flex; gap: 10px; width: 100%; }
    .btn-restaurar { background: transparent; color: #888; border: 1px solid #444; padding: 15px; border-radius: 50px; font-family: 'Oswald'; font-weight: bold; font-size: 1rem; width: 40%; cursor: pointer; transition: 0.2s; }
    .btn-guardar-colores { flex: 1; background: #F8C545; color: black; border: none; padding: 15px; border-radius: 50px; font-family: 'Oswald'; font-weight: bold; font-size: 1.2rem; cursor: pointer; box-shadow: 0 5px 15px rgba(248,197,69,0.3); transition: 0.2s; }

    /* ESTILOS INFO RANGOS */
    .rank-list { display: flex; flex-direction: column; gap: 15px; }
    .rank-item { display: flex; justify-content: space-between; align-items: center; background: #222; padding: 15px; border-radius: 10px; border: 1px solid #333; }
    .rank-pts { color: #fff; font-family: 'Oswald'; font-weight: bold; font-size: 1.1rem; }

    .fade-in { animation: fadeIn 0.4s ease; }
    .slide-in { animation: slideIn 0.4s ease; }
    @@keyframes holoSweep { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    @@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    @@keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
    @@keyframes shineBadge { 0% { left: -100%; } 20% { left: 200%; } 100% { left: 200%; } }
    @@keyframes fireBorder { 0% { box-shadow: 0 0 5px #ff0000, inset 0 0 5px #ff0000; } 100% { box-shadow: 0 0 15px #ff7f00, inset 0 0 10px #ff7f00; } }
</style>

@code {
    private bool cargando = true;
    private bool solicitandoFoto = false;
    private FichaAtletaDto ficha;
    
    private bool mostrarModalSubtitulos = false;
    private string tabActiva = "Comedia";
    private List<SubtituloDto> listaSubtitulos = new();
    
    private bool mostrarModalColores = false;
    private bool guardandoColores = false;
    private bool subiendoFondo = false;
    private bool mostrarModalInfo = false;

    public class FichaAtletaDto {
        public string Nombre { get; set; } public string Apellidos { get; set; }
        public string FotoUrl { get; set; } public string BoxNombre { get; set; } public string LogoBoxUrl { get; set; }
        public int DiasEntrenadosAnio { get; set; } public int Rx { get; set; } public int Avanzado { get; set; }
        public int Intermedio { get; set; } public int Principiante { get; set; }
        public string Subtitulo { get; set; }
        
        public string ColorPrimario { get; set; }
        public string ColorTexto { get; set; } 
        public string ColorNumeros { get; set; } 
        public string ColorFondo1 { get; set; } 
        public string ColorFondo2 { get; set; }
        public string Textura { get; set; } 
        public string FiltroFoto { get; set; } 
        public string FiltroFondo { get; set; }
        public double OpacidadFondo { get; set; }
        public string FondoCustomUrl { get; set; } 
        public string ColorDetalles { get; set; }
        public double OpacidadMedallas { get; set; }
        
        public List<FichaPRDto> PRs { get; set; } = new();
    }
    public class FichaPRDto { public string Ejercicio { get; set; } public decimal Marca { get; set; } public string Unidad { get; set; } }
    public class SubtituloDto { public int SubtituloID { get; set; } public string Texto { get; set; } public string Categoria { get; set; } }

    protected override async Task OnInitializedAsync()
    {
        if (Sesion.Usuario == null) { Nav.NavigateTo("/"); return; }
        try {
            var url = $"https://api-aftrack-mx-fphnazfmahdedtcj.canadacentral-01.azurewebsites.net/api/fichaapi/{Sesion.Usuario.UsuarioID}";
            ficha = await Http.GetFromJsonAsync<FichaAtletaDto>(url);
            if (string.IsNullOrEmpty(ficha.ColorDetalles)) ficha.ColorDetalles = "#aaaaaa";
            if (string.IsNullOrEmpty(ficha.ColorTexto)) ficha.ColorTexto = "#FFFFFF";
            if (string.IsNullOrEmpty(ficha.ColorNumeros)) ficha.ColorNumeros = "#FFFFFF";
            if (string.IsNullOrEmpty(ficha.Textura)) ficha.Textura = "";
            if (string.IsNullOrEmpty(ficha.FiltroFoto)) ficha.FiltroFoto = "none";
            if (string.IsNullOrEmpty(ficha.FiltroFondo)) ficha.FiltroFondo = "none";
            if (ficha.OpacidadFondo <= 0) ficha.OpacidadFondo = 1.0;
        } catch { } finally { cargando = false; }
    }

    private void ActivarCambioFoto() => solicitandoFoto = true;
    private void IrAPerfil() => Nav.NavigateTo("/mi-perfil"); 

    private string ObtenerClaseMedalla(int ovr)
    {
        if (ovr >= 370) return "badge-elite";
        if (ovr >= 300) return "badge-pro";
        if (ovr >= 225) return "badge-avanzado";
        if (ovr >= 150) return "badge-intermedio";
        return "badge-novato";
    }
    
    private void AbrirModalInfo() => mostrarModalInfo = true;

    private async Task AbrirModalSubtitulos()
    {
        mostrarModalSubtitulos = true;
        if(listaSubtitulos.Count == 0) {
            try { 
                listaSubtitulos = await Http.GetFromJsonAsync<List<SubtituloDto>>("https://api-aftrack-mx-fphnazfmahdedtcj.canadacentral-01.azurewebsites.net/api/fichaapi/catalogo-subtitulos"); 
            } catch { }
        }
    }
    private void CerrarModalSubtitulos() => mostrarModalSubtitulos = false;

    private async Task SeleccionarFrase(string textoFrase)
    {
        ficha.Subtitulo = textoFrase;
        mostrarModalSubtitulos = false;
        try {
            var payload = new { UsuarioId = Sesion.Usuario.UsuarioID, Subtitulo = textoFrase };
            await Http.PostAsJsonAsync("https://api-aftrack-mx-fphnazfmahdedtcj.canadacentral-01.azurewebsites.net/api/fichaapi/guardar-subtitulo", payload);
        } catch { }
    }

    private string backupColorPrimario;
    private string backupColorTexto;
    private string backupColorNumeros;
    private string backupColorDetalles;
    private string backupColorFondo1;
    private string backupColorFondo2;
    private string backupTextura;
    private string backupFiltroFoto;
    private string backupFiltroFondo;
    private double backupOpacidadFondo;
    private string backupFondoCustomUrl;
    private double backupOpacidadMedallas;

    private void AbrirModalColores()
    {
        backupColorPrimario = ficha.ColorPrimario;
        backupColorTexto = ficha.ColorTexto;
        backupColorNumeros = ficha.ColorNumeros;
        backupColorDetalles = ficha.ColorDetalles;
        backupColorFondo1 = ficha.ColorFondo1;
        backupColorFondo2 = ficha.ColorFondo2;
        backupTextura = ficha.Textura;
        backupFiltroFoto = ficha.FiltroFoto;
        backupFiltroFondo = ficha.FiltroFondo;
        backupOpacidadFondo = ficha.OpacidadFondo;
        backupFondoCustomUrl = ficha.FondoCustomUrl;
        backupOpacidadMedallas = ficha.OpacidadMedallas;
        mostrarModalColores = true;
    }

    private async Task IntentoCerrarModalColores()
    {
        bool hayCambios = (
            backupColorPrimario != ficha.ColorPrimario ||
            backupColorTexto != ficha.ColorTexto ||
            backupColorNumeros != ficha.ColorNumeros ||
            backupColorDetalles != ficha.ColorDetalles ||
            backupColorFondo1 != ficha.ColorFondo1 ||
            backupColorFondo2 != ficha.ColorFondo2 ||
            backupTextura != ficha.Textura ||
            backupFiltroFoto != ficha.FiltroFoto ||
            backupFiltroFondo != ficha.FiltroFondo ||
            backupOpacidadFondo != ficha.OpacidadFondo ||
            backupFondoCustomUrl != ficha.FondoCustomUrl ||
            backupOpacidadMedallas != ficha.OpacidadMedallas
        );

        if (hayCambios)
        {
            bool descartar = await App.Current.MainPage.DisplayAlert(
                "Cambios sin guardar",
                "Hiciste modificaciones en tu diseño. ¿Estás seguro de que quieres salir y descartarlos?",
                "Sí, descartar",
                "No, seguir editando"
            );

            if (descartar)
            {
                ficha.ColorPrimario = backupColorPrimario;
                ficha.ColorTexto = backupColorTexto;
                ficha.ColorNumeros = backupColorNumeros;
                ficha.ColorDetalles = backupColorDetalles;
                ficha.ColorFondo1 = backupColorFondo1;
                ficha.ColorFondo2 = backupColorFondo2;
                ficha.Textura = backupTextura;
                ficha.FiltroFoto = backupFiltroFoto;
                ficha.FiltroFondo = backupFiltroFondo;
                ficha.OpacidadFondo = backupOpacidadFondo;
                ficha.FondoCustomUrl = backupFondoCustomUrl;
                ficha.OpacidadMedallas = backupOpacidadMedallas;
                mostrarModalColores = false;
            }
        }
        else
        {
            mostrarModalColores = false;
        }
    }
    private void CerrarModalColores() => mostrarModalColores = false;

    private void RestaurarColores()
    {
        if (ficha != null)
        {
            ficha.ColorPrimario = "#FFD700"; 
            ficha.ColorTexto = "#FFFFFF";    
            ficha.ColorNumeros = "#FFFFFF";  
            ficha.ColorFondo1 = "#111111";   
            ficha.ColorFondo2 = "#2a2a2a";   
            ficha.Textura = "";              
            ficha.FiltroFoto = "none";
            ficha.FiltroFondo = "none";
            ficha.OpacidadFondo = 1.0;
            ficha.FondoCustomUrl = ""; 
            ficha.ColorDetalles = "#aaaaaa";
            ficha.OpacidadMedallas = 0.2;
        }
    }

    private void QuitarFondoCustom()
    {
        ficha.FondoCustomUrl = "";
    }

    private async Task SubirFondoCustom(InputFileChangeEventArgs e)
    {
        var archivo = e.File;
        if (archivo == null) return;
        
        subiendoFondo = true;
        try
        {
            using var form = new MultipartFormDataContent();
            using var fileStream = archivo.OpenReadStream(maxAllowedSize: 5120000);
            using var streamContent = new StreamContent(fileStream);
            
            streamContent.Headers.ContentType = new MediaTypeHeaderValue(archivo.ContentType);
            form.Add(streamContent, "archivo", archivo.Name);
            form.Add(new StringContent(Sesion.Usuario.UsuarioID.ToString()), "usuarioId");

            var response = await Http.PostAsync("https://api-aftrack-mx-fphnazfmahdedtcj.canadacentral-01.azurewebsites.net/api/fichaapi/subir-fondo", form);
            
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<RespuestaFondoDto>();
                if (result != null) {
                    ficha.FondoCustomUrl = result.url;
                    ficha.OpacidadFondo = 0.6; 
                }
            }
        }
        catch { }
        finally { subiendoFondo = false; }
    }

    public class RespuestaFondoDto { public string url { get; set; } }

    private async Task GuardarColores()
    {
        guardandoColores = true;
        try {
            var payload = new { 
                UsuarioId = Sesion.Usuario.UsuarioID, 
                ColorPrimario = ficha.ColorPrimario, 
                ColorTexto = ficha.ColorTexto, 
                ColorNumeros = ficha.ColorNumeros,
                ColorFondo1 = ficha.ColorFondo1, 
                ColorFondo2 = ficha.ColorFondo2,
                Textura = ficha.Textura,
                FiltroFoto = ficha.FiltroFoto,
                ColorDetalles = ficha.ColorDetalles,
                FiltroFondo = ficha.FiltroFondo,
                OpacidadFondo = ficha.OpacidadFondo,
                OpacidadMedallas = ficha.OpacidadMedallas
            };
            await Http.PostAsJsonAsync("https://api-aftrack-mx-fphnazfmahdedtcj.canadacentral-01.azurewebsites.net/api/fichaapi/guardar-colores", payload);
            mostrarModalColores = false;
        } catch { } finally { guardandoColores = false; }
    }
}