@page "/mi-perfil"
@using CrossBoxApp.Models
@using CrossBoxApp.Models.Services
@using System.Net.Http.Headers
@inject NavigationManager Nav
@inject HttpClient Http
@inject SesionService Sesion

<div class="main-layout">

    <div class="navbar-container">
        <div class="nav-left" @onclick="Volver">
            <i class="fas fa-arrow-left"></i> VOLVER
        </div>
        <div class="nav-title">MI PERFIL</div>
        <div class="nav-right"></div>
    </div>

    <div class="scrollable-content">
        
        <div class="profile-wrapper fade-in">
            
            <div class="photo-section">
                <div class="image-wrapper" @onclick="SeleccionarFotoNativa">
                    
                    @if (abriendoGaleria)
                    {
                        <div class="loading-overlay">
                            <div class="spinner-border text-warning" role="status"></div>
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(previewImagen))
                    {
                        <img src="@previewImagen" class="profile-img" />
                    }
                    else
                    {
                        <img src="https://via.placeholder.com/150/000000/F8C545?text=FOTO" class="profile-img" />
                    }
                    
                    <div class="upload-btn">
                        <i class="fas fa-camera"></i>
                    </div>
                </div>
                <p class="username">@(Sesion.Usuario?.Nombre + " " + Sesion.Usuario?.Apellidos ?? "ATLETA")</p>
                <small class="text-muted">Toca el círculo para cambiar foto</small>
            </div>

            <div class="form-section">
                <label class="lbl-input">Acerca de mí (Descripción)</label>
                <textarea @bind="miPerfil.Descripcion" class="input-dark text-area" placeholder="Ej: Gymrat, Crossfitero, Runner, RX en proceso..."></textarea>

                <label class="lbl-input">WhatsApp de Contacto</label>
                <div class="wrapper-ws">
                    <i class="fas fa-comment-dots icono-input"></i>

                    <input type="text"
                           @bind="miPerfil.Whatsapp"
                           class="input-dark input-con-icono"
                           placeholder="Ej: 961 123 4567" />
                </div>
                <button class="btn-save" @onclick="GuardarPerfil" disabled="@guardando">
                    @if (guardando)
                    {
                        <span><i class="fas fa-spinner fa-spin"></i> GUARDANDO...</span>
                    }
                    else if (esEdicion)
                    {
                        <span><i class="fas fa-edit"></i> ACTUALIZAR DATOS</span>
                    }
                    else
                    {
                        <span>GUARDAR PERFIL</span>
                    }
                </button>
            </div>

        </div>
        
        <div style="height: 40px;"></div>
    </div>
</div>

<style>
    /* --- ESTRUCTURA BASE --- */
    .main-layout {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background-color: #0d0d0d;
        display: flex;
        flex-direction: column;
        z-index: 1;
    }

    .navbar-container {
        flex-shrink: 0;
        padding-top: calc(env(safe-area-inset-top) + 5px);
        padding-bottom: 10px;
        padding-left: 20px;
        padding-right: 20px;
        background-color: #0d0d0d;
        border-bottom: 1px solid #F8C545;
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 100;
        font-family: 'Oswald';
        min-height: 60px;
    }

    .nav-left {
        color: #F8C545;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
    }

    .nav-title {
        font-weight: bold;
        font-size: 1.1rem;
        color: white;
        letter-spacing: 1px;
    }

    .nav-right { width: 60px; }

    .scrollable-content {
        flex-grow: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        -webkit-overflow-scrolling: touch;
        padding-bottom: 40px;
    }

    /* --- ESTILOS DE PERFIL --- */
    
    .profile-wrapper {
        width: 100%;
        max-width: 500px; /* Limitamos el ancho para que se vea bien en tablets */
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .photo-section { 
        text-align: center; 
        margin-bottom: 30px; 
        margin-top: 20px;
    }

    .image-wrapper {
        position: relative;
        width: 150px;
        height: 150px;
        margin: 0 auto 10px auto;
        cursor: pointer;
        border-radius: 50%;
        transition: transform 0.1s;
    }
    .image-wrapper:active { transform: scale(0.95); opacity: 0.8; }

    .profile-img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid #F8C545;
        background-color: #222;
        box-shadow: 0 0 20px rgba(248,197,69,0.2);
    }

    .upload-btn {
        position: absolute;
        bottom: 5px;
        right: 5px;
        background-color: #F8C545;
        color: black;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: 0 4px 6px rgba(0,0,0,0.5);
        pointer-events: none;
    }

    .loading-overlay {
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.7);
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10;
        backdrop-filter: blur(2px);
    }

    .username { 
        font-family: 'Oswald'; 
        font-size: 1.5rem; 
        color: #F8C545; 
        margin: 0; 
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .form-section { width: 100%; }

    .lbl-input { 
        color: #F8C545; 
        font-size: 0.9rem; 
        margin-bottom: 5px; 
        display: block; 
        font-weight: bold;
        font-family: 'Oswald';
        letter-spacing: 0.5px;
    }

    .input-dark { 
        width: 100%; 
        background-color: #1a1a1a; 
        border: 1px solid #444; 
        color: white; 
        padding: 12px; 
        border-radius: 8px; 
        margin-bottom: 20px; 
        outline: none; 
        font-family: 'Roboto';
    }
    .input-dark:focus { border-color: #F8C545; box-shadow: 0 0 10px rgba(248,197,69,0.1); }
    
    .text-area { height: 100px; resize: none; }
    
    .wrapper-ws { position: relative; width: 100%; margin-bottom: 20px; }
    .icono-ws { 
        position: absolute; 
        left: 15px; 
        top: 50%; 
        transform: translateY(-50%); 
        color: #25D366; 
        font-size: 1.4rem; 
        z-index: 10; 
        pointer-events: none; 
    }
    .input-con-icono { padding-left: 50px !important; }

    .btn-save { 
        width: 100%; 
        background: linear-gradient(45deg, #F8C545, #e0a800);
        color: black; 
        font-family: 'Oswald'; 
        font-size: 1.1rem; 
        border: none; 
        padding: 14px; 
        border-radius: 8px; 
        font-weight: bold; 
        margin-top: 10px; 
        letter-spacing: 1px;
        box-shadow: 0 4px 15px rgba(248,197,69,0.3);
    }
    .btn-save:disabled { background: #333; color: #666; box-shadow: none; }
    .btn-save:active { transform: scale(0.98); }

    .fade-in { animation: fadeIn 0.5s ease; }
    @@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .wrapper-ws {
        position: relative;
        width: 100%;
        margin-bottom: 20px; /* Espacio debajo */
    }

    /* 2. El icono flota sobre el input */
    .icono-input {
        position: absolute;
        left: 15px; /* Distancia desde la izquierda */
        top: 50%; /* Centrado verticalmente */
        transform: translateY(-50%); /* Ajuste fino del centro */
        color: #F8C545; /* Tu color amarillo/dorado */
        font-size: 1.2rem; /* Tamaño del icono */
        pointer-events: none; /* Importante: permite hacer clic en el input a través del icono */
        z-index: 10; /* Asegura que esté encima del fondo del input */
    }

    /* 3. El input debe tener espacio a la izquierda */
    .input-con-icono {
        width: 100%;
        padding-left: 45px !important; /* Espacio para que el texto no toque el icono */
        height: 50px; /* Altura cómoda */
        /* Tus estilos base (mantenlos) */
        background: #333 !important;
        color: white !important;
        border: 1px solid #555;
        border-radius: 8px;
    }

        .input-con-icono:focus {
            border-color: #F8C545;
            outline: none;
        }
</style>

@code {
    private PerfilDto miPerfil = new PerfilDto();
    private string previewImagen = "";
    private bool guardando = false;
    private bool esEdicion = false;
    private FileResult archivoSeleccionadoNativo;
    
    private bool abriendoGaleria = false; 

    protected override async Task OnInitializedAsync()
    {
        if (Sesion.Usuario == null) { Nav.NavigateTo("/"); return; }
        await CargarPerfilExistente();
    }

    private async Task SeleccionarFotoNativa()
    {
        if (abriendoGaleria) return;
        
        abriendoGaleria = true;
        StateHasChanged(); 
        
        await Task.Delay(100); 

        if (DeviceInfo.Platform != DevicePlatform.WinUI)
        {
            if (!await VerificarPermisosGaleria()) 
            {
                abriendoGaleria = false;
                StateHasChanged();
                return;
            }
        }

        try
        {
            FileResult resultado = null;

            if (DeviceInfo.Platform == DevicePlatform.WinUI)
            {
                var opciones = new PickOptions { PickerTitle = "Selecciona una imagen", FileTypes = FilePickerFileType.Images };
                await MainThread.InvokeOnMainThreadAsync(async () => { 
                    try { resultado = await FilePicker.Default.PickAsync(opciones); } catch {} 
                });
            }
            else
            {
                resultado = await MediaPicker.Default.PickPhotoAsync();
            }

            if (resultado != null)
            {
                using var stream = await resultado.OpenReadAsync();
                using var memoryStream = new MemoryStream();
                await stream.CopyToAsync(memoryStream);
                memoryStream.Position = 0;
                var buffer = memoryStream.ToArray();
                previewImagen = $"data:image/png;base64,{Convert.ToBase64String(buffer)}";
                archivoSeleccionadoNativo = resultado;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error foto: " + ex.Message);
        }
        finally
        {
            abriendoGaleria = false;
            StateHasChanged();
        }
    }

    private async Task<bool> VerificarPermisosGaleria()
    {
        var estado = await Permissions.CheckStatusAsync<Permissions.Photos>();
        if (estado != PermissionStatus.Granted) estado = await Permissions.RequestAsync<Permissions.Photos>();
        if (estado != PermissionStatus.Granted)
        {
            await App.Current.MainPage.DisplayAlert("Permiso Requerido", "Necesitamos acceso a tus fotos.", "Entendido");
            return false;
        }
        return true;
    }

    private async Task CargarPerfilExistente()
    {
        try
        {
            var userId = Sesion.Usuario.UsuarioID;
            var response = await Http.GetAsync($"https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/PerfilApi/obtener/{userId}");
            if (response.IsSuccessStatusCode)
            {
                var perfilEncontrado = await response.Content.ReadFromJsonAsync<PerfilDto>();
                if (perfilEncontrado != null)
                {
                    miPerfil = perfilEncontrado;
                    esEdicion = true;
                    if (!string.IsNullOrEmpty(miPerfil.FotoPerfil)) previewImagen = miPerfil.FotoPerfil;
                }
            }
        }
        catch { }
    }

    private async Task GuardarPerfil()
    {
        if (string.IsNullOrWhiteSpace(miPerfil.Descripcion) || string.IsNullOrWhiteSpace(miPerfil.Whatsapp))
        {
            await App.Current.MainPage.DisplayAlert("Faltan Datos", "Descripción y WhatsApp obligatorios.", "OK");
            return;
        }

        guardando = true;
        StateHasChanged();

        try
        {
            var contenido = new MultipartFormDataContent();
            contenido.Add(new StringContent(Sesion.Usuario.UsuarioID.ToString()), "UsuarioID");
            contenido.Add(new StringContent(miPerfil.Descripcion), "Descripcion");
            contenido.Add(new StringContent(miPerfil.Whatsapp), "Whatsapp");

            if (archivoSeleccionadoNativo != null)
            {
                using var stream = await archivoSeleccionadoNativo.OpenReadAsync();
                using var memoryStream = new MemoryStream();
                await stream.CopyToAsync(memoryStream);
                memoryStream.Position = 0;
                var fileContent = new ByteArrayContent(memoryStream.ToArray());
                fileContent.Headers.ContentType = new MediaTypeHeaderValue(archivoSeleccionadoNativo.ContentType ?? "image/jpeg");
                contenido.Add(fileContent, "archivoFoto", archivoSeleccionadoNativo.FileName);
            }

            var response = await Http.PostAsync("https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/PerfilApi/guardar", contenido);

            if (response.IsSuccessStatusCode)
            {
                await App.Current.MainPage.DisplayAlert("¡Listo!", "Perfil actualizado.", "OK");
                await CargarPerfilExistente();
                archivoSeleccionadoNativo = null;
            }
            else
            {
                string errorMsg = await response.Content.ReadAsStringAsync();
                await App.Current.MainPage.DisplayAlert("Error", errorMsg, "OK");
            }
        }
        catch (Exception ex)
        {
            await App.Current.MainPage.DisplayAlert("Error", ex.Message, "OK");
        }
        finally
        {
            guardando = false;
            StateHasChanged();
        }
    }

    private void Volver() => Nav.NavigateTo("/home");
}