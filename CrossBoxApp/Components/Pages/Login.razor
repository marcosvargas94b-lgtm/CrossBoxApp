@page "/"
@using System.Net.Http.Json
@using Microsoft.Maui.Storage
@inject NavigationManager Nav
@inject HttpClient Http
@inject CrossBoxApp.Models.Services.SesionService Sesion
@using CrossBoxApp.Models
@using Microsoft.Maui.Devices

<div class="login-container-fullscreen">
    <div class="background-overlay"></div>
    
  @*   <div class="brand-header fade-in-down">
        <strong>@DateTime.Now.ToString("dd/MM/yyyy")</strong><br />
        <span style="color: #F8C545; letter-spacing: 2px;">BY ALFAFIT</span>
    </div> *@

    <div class="login-wrapper glass-panel fade-in-up">
        <div class="logo-area">
            <h1 class="title-main">AFTRACK</h1>
            <div class="title-bar"></div>
            <h2 class="title-sub">TU LUGAR DE ENTRENAMIENTO EN TUS MANOS</h2>
        </div>

        @if (cargando)
        {
            <div class="loading-container">
                <div class="spinner-border text-warning" style="width: 3rem; height: 3rem; border-width: 0.2em;" role="status"></div>
                <p class="mt-3 text-white tracking-text">INICIANDO SESIÓN...</p>
            </div>
        }
        else
        {
            <div class="input-group-animated">
                <i class="fas fa-user input-icon"></i>
                <input type="text" @bind="loginUsername" class="input-custom" placeholder="Email" />
            </div>
            
            <div class="input-group-animated">
                <i class="fas fa-lock input-icon"></i>
                <input type="password" @bind="loginPassword" class="input-custom" placeholder="Contraseña" />
            </div>

            @if (!string.IsNullOrEmpty(loginError))
            {
                <div class="alert-error shake-animation">
                    <i class="fas fa-exclamation-circle"></i> @loginError
                </div>
            }

            <div class="actions-row">
                <a class="forgot-pass" @onclick="AbrirModalRecuperar">¿Olvidaste tu contraseña?</a>
            </div>

            <button class="btn-login glow-effect" @onclick="IniciarSesion">
                INGRESAR <i class="fas fa-arrow-right" style="margin-left:10px;"></i>
            </button>

            <div class="divider">
                <span>O</span>
            </div>

            <button class="btn-register-link" @onclick="AbrirModalRegistro">
                CREAR CUENTA DE ATLETA
            </button>

            <div class="mt-4 text-center box-register-area">
                <p class="small-text">¿Eres dueño de un Gimnasio?</p>
                <button class="btn-link-gold pulse-animation" @onclick="AbrirModalRegistroBox">
                    <i class="fas fa-store-alt"></i> REGISTRA TU LUGAR AQUÍ
                </button>
            </div>
        }
    </div>
</div>

@* --- MODAL RECUPERAR CONTRASEÑA (CORREGIDO) --- *@
@if (mostrarModalRecuperar)
{
    <div class="modal-overlay fade-in">
        <div class="modal-content custom-modal slide-in-up" style="max-height: 450px;">
            <div class="modal-header">
                <h5 class="modal-title-custom">RECUPERAR ACCESO</h5>
                <button class="btn-close-custom" @onclick="() => mostrarModalRecuperar = false"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <i class="fas fa-comment-dots fa-3x" style="color: #25D366;"></i>
                    <p style="color: #ccc; margin-top: 10px; font-size: 0.9rem;">
                        Ingresa tu número de celular registrado. Te enviaremos tu contraseña por WhatsApp.
                    </p>
                </div>

                <div class="input-group-animated">
                    <input type="tel"
                           @bind="telefonoRecuperar"
                           class="input-dark"
                           placeholder="Número (10 dígitos)"
                           maxlength="10"
                           oninput="this.value = this.value.replace(/[^0-9]/g, '');" />
                </div>

                @if (!string.IsNullOrEmpty(mensajeRecuperacion))
                {
                    <div class="alert-error mt-3" style="@(esExitoRecuperacion ? "border-color: #25D366; background-color: rgba(37, 211, 102, 0.1); color: #25D366;" : "")">
                        @if(esExitoRecuperacion) { <i class="fas fa-check-circle mr-2"></i> } else { <i class="fas fa-times-circle mr-2"></i> }
                        @mensajeRecuperacion
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" @onclick="() => mostrarModalRecuperar = false">Cancelar</button>
                <button class="btn-confirm" @onclick="EnviarRecuperacion" disabled="@enviandoRecuperacion">
                    @if(enviandoRecuperacion){ <span><i class="fas fa-spinner fa-spin"></i> ENVIANDO...</span> } else { <span>ENVIAR MENSAJE</span> }
                </button>
            </div>
        </div>
    </div>
}

@* --- MODAL REGISTRO DE BOX (DUEÑO) --- *@
@if (mostrarModalBox)
{
    <div class="modal-overlay fade-in">
        <div class="modal-content custom-modal slide-in-up">
            <div class="modal-header">
                <h5 class="modal-title-custom">REGISTRA TU LUGAR</h5>
                <button class="btn-close-custom" @onclick="() => mostrarModalBox = false"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="modal-body">
                <div class="trial-banner mb-4">
                    <i class="fas fa-gift fa-2x mb-2"></i>
                    <h4>¡COMIENZA GRATIS!</h4>
                    <p>Disfruta de <strong>1 MES COMPLETO</strong> de prueba.</p>
                    <small style="color:black">Sin cobros el día de hoy.</small>
                </div>

                <div class="form-section-label">DATOS DEL NEGOCIO</div>
                <input type="text" @bind="registroBox.NombreBox" class="form-control input-dark mb-2" placeholder="Nombre del Box" />
                <input type="text" @bind="registroBox.Ciudad" class="form-control input-dark mb-2" placeholder="Ciudad" />
                <input type="text" @bind="registroBox.Direccion" class="form-control input-dark mb-4" placeholder="Dirección" />
                
                <div class="form-section-label">DATOS DEL ADMIN</div>
                <div class="row">
                    <div class="col-6"><input type="text" @bind="registroBox.NombreAdmin" class="form-control input-dark mb-2" placeholder="Nombre" /></div>
                    <div class="col-6"><input type="text" @bind="registroBox.ApellidosAdmin" class="form-control input-dark mb-2" placeholder="Apellidos" /></div>
                </div>
                <input type="tel"
                       @bind="registroBox.Telefono"
                       class="form-control input-dark mb-2"
                       placeholder="Teléfono (10 dígitos)"
                       maxlength="10"
                       oninput="this.value = this.value.replace(/[^0-9]/g, '');" />
                <input type="email" @bind="registroBox.Email" class="form-control input-dark mb-2" placeholder="Email (Usuario)" />
                <input type="password" @bind="registroBox.Password" class="form-control input-dark mb-2" placeholder="Contraseña" />
                <input type="password" @bind="confirmarPass" class="form-control input-dark mb-2" placeholder="Confirmar Contraseña" />
                
                @if (DeviceInfo.Platform != DevicePlatform.iOS)
                {
                    <div style="margin-top: 20px;">
                        <div class="section-title-small"><i class="fas fa-info-circle"></i> PRECIOS FUTUROS:</div>
                        @if (listaPlanesSistema != null && listaPlanesSistema.Count > 0)
                        {
                            <div class="planes-grid">
                                @foreach (var plan in listaPlanesSistema)
                                {
                                    <div class="plan-card info-only">
                                        <div class="plan-name">@plan.Nombre.ToUpper()</div>
                                        <div class="plan-price">$@plan.Precio.ToString("N2")</div>
                                        <div class="plan-desc" style="color:#F8C545; font-size: 0.65rem;">*Al finalizar el mes de prueba.</div>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
                else
                {
                    @* MENSAJE SEGURO PARA iOS *@
                    <div style="margin-top: 20px; text-align: center;">
                        <p style="color:#ccc; font-size: 0.8rem;">
                            <i class="fas fa-info-circle"></i> Al registrarte obtienes <strong>1 MES GRATIS</strong>.
                            <br>La gestión de tu cuenta se realizará vía web.
                        </p>
                    </div>
                }
            </div>
            
            <div class="modal-footer">
                <button class="btn-cancel" @onclick="() => mostrarModalBox = false">Cancelar</button>
                <button class="btn-confirm" @onclick="GuardarNuevoBox">INICIAR PRUEBA GRATIS</button>
            </div>
        </div>
    </div>
}

@* MODAL ATLETA *@
@if (mostrarModalRegistro)
{
    <div class="modal-overlay fade-in">
        <div class="modal-content custom-modal slide-in-up">
            <div class="modal-header">
                <h5 class="modal-title-custom">NUEVO ATLETA</h5>
                <button class="btn-close-custom" @onclick="CerrarModalRegistro"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="modal-body">
                <input type="text" @bind="regNombre" class="input-dark mb-2" placeholder="Nombre" />
                <input type="text" @bind="regApellidos" class="input-dark mb-2" placeholder="Apellidos" />
                <input type="tel"
                       @bind="regTelefono"
                       class="input-dark mb-2"
                       placeholder="Teléfono (10 dígitos)"
                       maxlength="10"
                       oninput="this.value = this.value.replace(/[^0-9]/g, '');" />
                <input type="email" @bind="regEmail" class="input-dark mb-2" placeholder="Email" />                    
                <select class="input-dark mb-2" @onchange="AlSeleccionarBox">
                    <option value="">-- Selecciona tu Box --</option>
                    @foreach (var box in listaBoxes) { <option value="@box.BoxID.ToString()">@box.Nombre</option> }
                </select>

                @if (boxSeleccionado != null && boxSeleccionado.CostoInscripcion > 0)
                {
                    <div class="costo-alert fade-in">
                        <i class="fas fa-gift"></i>
                        <div>
                            <strong style="font-size: 1rem;">¡TU PRIMER MES ES GRATIS!</strong>
                            <div class="small-text-costo text-white mt-1">
                                Inscripción futura, único pago: <span class="precio">$@boxSeleccionado.CostoInscripcion</span>
                            </div>
                        </div>
                    </div>
                }
                <input type="password" @bind="regPass" class="input-dark mb-2" placeholder="Contraseña" />
                <input type="password" @bind="regConfirmPass" class="input-dark mb-2" placeholder="Confirmar" />
                @if (!string.IsNullOrEmpty(registroError)) { <div class="alert-error shake-animation">@registroError</div> }
            </div>
            
            <div class="modal-footer">
                <button class="btn-cancel" @onclick="CerrarModalRegistro">Cancelar</button>
                <button class="btn-confirm" @onclick="RegistrarUsuario">REGISTRARME GRATIS</button>
            </div>
        </div>
    </div>
}

<style>
    /* ESTILOS BASE */
    .login-container-fullscreen { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: url('imagenes/TIMER.png') no-repeat center center; background-size: cover; display: flex; justify-content: center; align-items: center; z-index: 10; overflow: hidden; animation: bgMove 20s infinite alternate linear; }
    @@keyframes bgMove { from { background-size: 100%; } to { background-size: 110%; } }
    .background-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0.9) 90%); z-index: 1; }
    .brand-header { position: absolute; top: 40px; left: 30px; color: #fff; z-index: 5; font-family: 'Oswald'; font-size: 1.2rem; }

    /* TARJETA GLASS */
    .login-wrapper { position: relative; z-index: 10; width: 90%; max-width: 420px; padding: 40px 30px; border-radius: 20px; background: rgba(20, 20, 20, 0.65); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 20px 50px rgba(0,0,0,0.8); text-align: center; }
    .logo-area { margin-bottom: 30px; }
    .title-main { font-family: 'Oswald', sans-serif; font-size: 4rem; font-weight: 700; color: white; margin: 0; line-height: 0.9; letter-spacing: -2px; text-transform: uppercase; background: -webkit-linear-gradient(#fff, #bbb); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 5px 15px rgba(0,0,0,0.5); }
    .title-bar { width: 60px; height: 4px; background: #F8C545; margin: 5px auto 10px auto; border-radius: 2px; box-shadow: 0 0 10px #F8C545; }
    .title-sub { font-family: 'Roboto', sans-serif; font-size: 0.9rem; color: #aaa; letter-spacing: 4px; text-transform: uppercase; font-weight: 300; margin: 0; }

    /* INPUTS Y BOTONES */
    .input-group-animated { position: relative; margin-bottom: 20px; }
    .input-icon { position: absolute; left: 20px; top: 50%; transform: translateY(-50%); color: #F8C545; font-size: 1.1rem; z-index: 2; }
    .input-custom { width: 100%; background: rgba(0, 0, 0, 0.5); border: 1px solid #444; border-radius: 50px; padding: 15px 15px 15px 50px; color: #fff; font-size: 1rem; transition: all 0.3s ease; }
    .input-custom:focus { border-color: #F8C545; background: rgba(0, 0, 0, 0.8); box-shadow: 0 0 15px rgba(248, 197, 69, 0.3); outline: none; }
    .input-dark { width: 100%; background: #222; border: 1px solid #444; color: white; padding: 15px; border-radius: 8px; font-size: 1rem; }
    .input-dark:focus { border-color: #F8C545; outline:none; }
    .btn-login { width: 100%; background: linear-gradient(90deg, #F8C545, #dcb03d); color: #000; font-weight: 900; border: none; padding: 15px; border-radius: 50px; font-size: 1.1rem; font-family: 'Oswald', sans-serif; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; margin-top: 20px; text-transform: uppercase; }
    .btn-login:active { transform: scale(0.98); }
    .glow-effect { box-shadow: 0 0 20px rgba(248, 197, 69, 0.4); }
    .actions-row { margin-top: 15px; text-align: right; }
    .forgot-pass { color: #888; font-size: 0.85rem; text-decoration: none; transition: color 0.3s; cursor: pointer; }
    .forgot-pass:hover { color: #F8C545; text-decoration: underline; }
    .divider { margin: 25px 0; position: relative; text-align: center; }
    .divider::before { content: ''; position: absolute; top: 50%; left: 0; width: 100%; height: 1px; background: #333; z-index: 1; }
    .divider span { background: #151515; padding: 0 10px; color: #666; font-size: 0.8rem; position: relative; z-index: 2; }
    .btn-register-link { background: transparent; border: 1px solid #666; color: white; width: 100%; padding: 12px; border-radius: 50px; font-weight: bold; font-size: 0.9rem; transition: all 0.3s; }
    .btn-register-link:hover { border-color: white; background: rgba(255,255,255,0.1); }
    .box-register-area { margin-top: 30px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); }
    .small-text { color: #888; font-size: 0.8rem; margin-bottom: 5px; }
    .btn-link-gold { background: none; border: none; color: #F8C545; font-weight: bold; font-family: 'Oswald'; font-size: 1rem; text-decoration: none; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; }

    /* ANIMACIONES */
    .fade-in-up { animation: fadeInUp 0.8s ease-out; }
    .fade-in-down { animation: fadeInDown 0.8s ease-out; }
    .slide-in-up { animation: slideInUp 0.4s ease-out; }
    .pulse-animation { animation: pulse 2s infinite; }
    .shake-animation { animation: shake 0.5s; }
    @@keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    @@keyframes fadeInDown { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
    @@keyframes slideInUp { from { opacity: 0; transform: translateY(100px); } to { opacity: 1; transform: translateY(0); } }
    @@keyframes pulse { 0% { transform: scale(1); text-shadow: 0 0 0 rgba(248, 197, 69, 0); } 50% { transform: scale(1.05); text-shadow: 0 0 10px rgba(248, 197, 69, 0.5); } 100% { transform: scale(1); text-shadow: 0 0 0 rgba(248, 197, 69, 0); } }
    @@keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); } 20%, 40%, 60%, 80% { transform: translateX(5px); } }

    /* MODALES */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 5000; display: flex; justify-content: center; align-items: center; }
    .custom-modal { background: #1a1a1a; width: 95%; max-width: 500px; border: 1px solid #333; border-radius: 15px; display: flex; flex-direction: column; max-height: 85vh; box-shadow: 0 0 40px rgba(0,0,0,1); }
    .modal-header { padding: 20px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
    .modal-body { padding: 20px; overflow-y: auto; flex: 1; -webkit-overflow-scrolling: touch; }
    .modal-footer { padding: 20px; background: #111; border-top: 1px solid #333; display: flex; gap: 10px; flex-shrink: 0; }
    .modal-title-custom { color: #F8C545; font-family: 'Oswald'; margin: 0; font-size: 1.5rem; letter-spacing: 1px; }
    .btn-close-custom { background: none; border: none; color: #fff; font-size: 1.5rem; }
    .btn-confirm { flex: 1; background: #F8C545; color: black; border: none; padding: 12px; border-radius: 8px; font-weight: bold; display: flex; justify-content: center; align-items: center; gap: 10px;}
    .btn-confirm:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-cancel { flex: 1; background: #333; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; }
    .form-section-label { color: #888; font-size: 0.75rem; font-weight: bold; margin: 15px 0 5px 0; letter-spacing: 1px; border-bottom: 1px solid #333; padding-bottom: 5px; }
    .section-title-small { font-size: 0.8rem; color: #ccc; margin-bottom: 10px; font-weight: bold; }
    .alert-error { background: rgba(220, 53, 69, 0.2); color: #ff6b6b; padding: 10px; border-radius: 8px; border: 1px solid #ff6b6b; margin-top: 15px; font-size: 0.9rem; text-align: left; display: flex; align-items: center; }
    .mr-2 { margin-right: 0.5rem; }
    .trial-banner { background: linear-gradient(135deg, #F8C545, #b8860b); color: black; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    .trial-banner h4 { font-family: 'Oswald'; font-weight: bold; margin: 0; }
    .planes-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .plan-card { background: #222; border: 1px solid #333; padding: 10px; border-radius: 8px; text-align: center; }
    .plan-price { color: #F8C545; font-family: 'Oswald'; font-size: 1.2rem; }
    .plan-name { color: white; font-weight: bold; font-size: 0.8rem; }
    .costo-alert { background: rgba(40, 167, 69, 0.2); border: 2px solid #28a745; border-radius: 10px; padding: 15px; margin: 15px 0; display: flex; align-items: flex-start; gap: 15px; color: white; animation: fadeIn 0.5s; }
    .costo-alert i { font-size: 2rem; color: #28a745; margin-top: 5px; }
    .precio { color: #F8C545; font-weight: bold; font-size: 1.1rem; font-family: 'Oswald'; }
    .small-text-costo { font-size: 0.8rem; color: #ccc; }
    .tracking-text { letter-spacing: 3px; font-size: 0.8rem; animation: pulse 1.5s infinite; }
</style>

@code {
    // ---------------- LOGIC: INICIO DE SESIÓN ----------------
    private string loginUsername;
    private string loginPassword;
    private string loginError;
    private bool cargando = true;

    protected override async Task OnInitializedAsync()
    {
        // Carga inicial
        try {
            var response = await Http.GetAsync("https://api-aftrack-mx-fphnazfmahdedtcj.canadacentral-01.azurewebsites.net/api/authapi/boxes");
            if (response.IsSuccessStatusCode) listaBoxes = await response.Content.ReadFromJsonAsync<List<Boxes>>();
        } catch { }
        
        try {
            var resPlanes = await Http.GetAsync("https://api-aftrack-mx-fphnazfmahdedtcj.canadacentral-01.azurewebsites.net/api/boxesAPI/planes-sistema");
            if (resPlanes.IsSuccessStatusCode) listaPlanesSistema = await resPlanes.Content.ReadFromJsonAsync<List<PlanSistemaDto>>();
        } catch { }

        await IntentarLoginAutomatico();
    }

    private async Task IntentarLoginAutomatico()
    {
        try
        {
            var guardado = await SecureStorage.Default.GetAsync("auth_token");
            if (!string.IsNullOrEmpty(guardado))
            {
                var response = await Http.GetAsync($"https://api-aftrack-mx-fphnazfmahdedtcj.canadacentral-01.azurewebsites.net/api/authapi/login-por-id/{guardado}");
                if (response.IsSuccessStatusCode)
                {
                    var usuario = await response.Content.ReadFromJsonAsync<UsuarioSesionDto>();
                    if (usuario != null)
                    {
                        Sesion.Usuario = usuario;
                        Nav.NavigateTo("/home");
                        return;
                    }
                }
            }
        }
        catch { SecureStorage.Default.Remove("auth_token"); }
        cargando = false;
    }


    private async Task IniciarSesion()
    {
        cargando = true; loginError = "";
        try
        {
            var loginData = new { Username = loginUsername, Password = loginPassword };
            var response = await Http.PostAsJsonAsync("https://api-aftrack-mx-fphnazfmahdedtcj.canadacentral-01.azurewebsites.net/api/authapi/login", loginData);

            if (response.IsSuccessStatusCode)
            {
                var usuarioRecibido = await response.Content.ReadFromJsonAsync<UsuarioSesionDto>();
                Sesion.Usuario = usuarioRecibido;
                try { await SecureStorage.Default.SetAsync("auth_token", usuarioRecibido.UsuarioID.ToString());} catch {}
                Nav.NavigateTo("/home");
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.PaymentRequired)
            {
                loginError = "⛔ El servicio de tu Gimnasio está suspendido temporalmente.";
                cargando = false;
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.Forbidden)
            {
                cargando = false;
                await App.Current.MainPage.DisplayAlert("⏳ CUENTA EN ESPERA", "Espera a que tu admin acepte tu solicitud.", "Entendido");
            }
            else
            {
                cargando = false;
                loginError = "Credenciales incorrectas.";
            }
        }
        catch (Exception ex)
        {
            cargando = false;
            loginError = "Error de conexión: " + ex.Message;
        }
    }

    // ---------------- LOGIC: RECUPERAR PASSWORD (NUEVO) ----------------
    private bool mostrarModalRecuperar = false;
    private string telefonoRecuperar;
    private string mensajeRecuperacion;
    private bool enviandoRecuperacion = false;
    private bool esExitoRecuperacion = false;

    private void AbrirModalRecuperar()
    {
        telefonoRecuperar = "";
        mensajeRecuperacion = "";
        esExitoRecuperacion = false;
        mostrarModalRecuperar = true;
    }

    private async Task EnviarRecuperacion()
    {
        // --- VALIDACIÓN BLINDADA ---
        if (string.IsNullOrEmpty(telefonoRecuperar) || telefonoRecuperar.Length != 10 || !long.TryParse(telefonoRecuperar, out _))
        {
            mensajeRecuperacion = "El número debe ser de 10 dígitos exactos.";
            esExitoRecuperacion = false;
            return;
        }
        // ---------------------------

        enviandoRecuperacion = true;
        mensajeRecuperacion = "";

        try
        {
            var data = new { Telefono = telefonoRecuperar };
            var response = await Http.PostAsJsonAsync("https://api-aftrack-mx-fphnazfmahdedtcj.canadacentral-01.azurewebsites.net/api/authapi/recuperar-password", data);

            if (response.IsSuccessStatusCode)
            {
                mensajeRecuperacion = "¡Listo! Te hemos enviado tu contraseña por WhatsApp.";
                esExitoRecuperacion = true;
            }
            else
            {
                var errorMsg = await response.Content.ReadAsStringAsync();
                mensajeRecuperacion = !string.IsNullOrEmpty(errorMsg) ? errorMsg.Replace("\"", "") : "No pudimos enviar el mensaje.";
                esExitoRecuperacion = false;
            }
        }
        catch (Exception)
        {
            mensajeRecuperacion = "Error de conexión.";
            esExitoRecuperacion = false;
        }
        finally
        {
            enviandoRecuperacion = false;
        }
    }

    // ---------------- LOGIC: REGISTRO ATLETA ----------------
    private bool mostrarModalRegistro = false;
    private string regNombre; private string regApellidos; private string regEmail; private string regTelefono;
    private string regPass; private string regConfirmPass; private string registroError;
    private List<Boxes> listaBoxes = new List<Boxes>();
    private Boxes boxSeleccionado;
    private Guid regBoxId;

    private void AbrirModalRegistro() => mostrarModalRegistro = true;
    private void CerrarModalRegistro() { mostrarModalRegistro = false; registroError = ""; boxSeleccionado = null; }

    private void AlSeleccionarBox(ChangeEventArgs e)
    {
        boxSeleccionado = null;
        regBoxId = Guid.Empty;
        string idStr = e.Value?.ToString();
        if (!string.IsNullOrEmpty(idStr) && Guid.TryParse(idStr, out Guid id))
        {
            regBoxId = id;
            var encontrado = listaBoxes.FirstOrDefault(b => b.BoxID == id);
            if (encontrado != null) boxSeleccionado = encontrado;
        }
        StateHasChanged();
    }

    private async Task RegistrarUsuario()
    {
        registroError = "";
        if (regBoxId == Guid.Empty) { registroError = "Por favor selecciona un lugar de entrenamiento"; return; }

        // --- VALIDACIÓN BLINDADA ---
        if (string.IsNullOrEmpty(regTelefono) || regTelefono.Length != 10 || !long.TryParse(regTelefono, out _))
        {
            registroError = "El teléfono debe tener 10 dígitos exactos.";
            return;
        }
        // ---------------------------

        if (regPass != regConfirmPass) { registroError = "Las contraseñas no coinciden."; return; }
        if (string.IsNullOrEmpty(regEmail) || string.IsNullOrEmpty(regPass)) { registroError = "Campos obligatorios."; return; }

        try
        {
            var nuevoUsuario = new { Nombre = regNombre, Apellidos = regApellidos, CorreoElectronico = regEmail, Telefono = regTelefono, Password = regPass, ConfirmPass = regConfirmPass, BoxID = regBoxId };
            var response = await Http.PostAsJsonAsync("https://api-aftrack-mx-fphnazfmahdedtcj.canadacentral-01.azurewebsites.net/api/authapi/registrar", nuevoUsuario);

            if (response.IsSuccessStatusCode)
            {
                mostrarModalRegistro = false;
                await App.Current.MainPage.DisplayAlert("¡Registro Exitoso!", "Tu cuenta ha sido creada. Disfruta tu mes de prueba.", "OK");
            }
            else
            {
                var errorJson = await response.Content.ReadFromJsonAsync<ErrorResponse>();
                registroError = errorJson?.mensaje ?? "No se pudo registrar.";
            }
        }
        catch { registroError = "Error al conectar con la API."; }
    }

    // ---------------- LOGIC: REGISTRO BOX (DUEÑO) ----------------
    private bool mostrarModalBox = false;
    private RegistroBoxes registroBox = new RegistroBoxes { PlanSeleccionadoID = 1 };
    private string confirmarPass = "";
    
    public class PlanSistemaDto { public int PlanID { get; set; } public string Nombre { get; set; } public decimal Precio { get; set; } }
    private List<PlanSistemaDto> listaPlanesSistema = new List<PlanSistemaDto>();

    public class RegistroBoxes
    {
        public string NombreBox { get; set; } public string Ciudad { get; set; } public string Direccion { get; set; }
        public string NombreAdmin { get; set; } public string ApellidosAdmin { get; set; } public string Telefono { get; set; }
        public string Email { get; set; } public string Password { get; set; } public int PlanSeleccionadoID { get; set; }
    }

    private void AbrirModalRegistroBox()
    {
        registroBox = new RegistroBoxes { PlanSeleccionadoID = 1 }; 
        confirmarPass = "";
        mostrarModalBox = true;
    }

    private async Task GuardarNuevoBox()
    {
        if (string.IsNullOrEmpty(registroBox.NombreBox) || string.IsNullOrEmpty(registroBox.Email))
        {
            await App.Current.MainPage.DisplayAlert("Error", "Llena los campos obligatorios.", "OK"); return;
        }

        // --- VALIDACIÓN BLINDADA ---
        if (string.IsNullOrEmpty(registroBox.Telefono) || registroBox.Telefono.Length != 10 || !long.TryParse(registroBox.Telefono, out _))
        {
            await App.Current.MainPage.DisplayAlert("Teléfono Inválido", "El teléfono debe tener 10 dígitos numéricos.", "OK");
            return;
        }
        // ---------------------------

        if (registroBox.Password != confirmarPass) { await App.Current.MainPage.DisplayAlert("Error", "Contraseñas no coinciden.", "OK"); return; }

        try
        {
            var response = await Http.PostAsJsonAsync("https://api-aftrack-mx-fphnazfmahdedtcj.canadacentral-01.azurewebsites.net/api/boxesAPI/registrar-nuevo", registroBox);
            if (response.IsSuccessStatusCode)
            {
                await App.Current.MainPage.DisplayAlert("¡Bienvenido!", "Tu lugar de entrenamiento ha sido registrado. Tienes 1 MES DE PRUEBA GRATIS.", "OK");
                mostrarModalBox = false;
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                await App.Current.MainPage.DisplayAlert("Error", error, "OK");
            }
        }
        catch (Exception ex) { await App.Current.MainPage.DisplayAlert("Error", ex.Message, "OK"); }
    }

    public class ErrorResponse { public string mensaje { get; set; } }
}