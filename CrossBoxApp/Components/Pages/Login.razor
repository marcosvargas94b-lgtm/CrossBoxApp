@page "/"
@using System.Net.Http.Json
@inject NavigationManager Nav
@inject HttpClient Http
@inject CrossBoxApp.Models.Services.SesionService Sesion
@using CrossBoxApp.Models

<div class="login-container-fullscreen">
    <div class="brand-header">
        <strong>@DateTime.Now.ToString("dd/MM/yyyy")</strong><br />
        By ALFAFIT
    </div>

    <div class="login-wrapper">
        <h1 class="title-main">MY CROSSBOX</h1>
        <h2 class="title-sub">INICIO DE SESIÓN</h2>

        <div class="form-group">
            <input type="text" @bind="loginUsername" class="input-custom" placeholder="Username (Email)" />
        </div>
        <div class="form-group">
            <input type="password" @bind="loginPassword" class="input-custom" placeholder="Password" />
        </div>

        @if (!string.IsNullOrEmpty(loginError))
        {
            <div class="alert-error">@loginError</div>
        }

        <a href="#" class="forgot-pass">Forgot Password?</a>
        <button class="btn-login" @onclick="IniciarSesion">Login</button>

        <a href="#" class="forgot-pass" style="margin-top: 30px; color: #F8C545; font-weight: bold;"
           @onclick="AbrirModalRegistro">
            ¿No tienes cuenta? ¡Regístrate aquí!
        </a>

        <div class="mt-4 text-center">
            <button class="btn-link-gold" @onclick="AbrirModalRegistroBox">
                <i class="fas fa-store-alt"></i> ¡Registra tu lugar de entrenamiento!
            </button>
        </div>
    </div>
    
</div>

@if (mostrarModalBox)
{
    <div class="modal-overlay">
        <div class="modal-content custom-modal">
            <div class="modal-header">
                <h5 style="color:#F8C545; font-family:'Oswald'; margin:0;">REGISTRA TU LUGAR</h5>
                <button class="btn-close-custom" @onclick="() => mostrarModalBox = false">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-body scrollable-body">

                <div class="section-title"><i class="fas fa-building"></i> DATOS DEL LUGAR</div>

                <input type="text" @bind="registroBox.NombreBox" class="form-control input-dark mb-2" placeholder="Nombre del Box / Gym" />
                <input type="text" @bind="registroBox.Ciudad" class="form-control input-dark mb-2" placeholder="Ciudad" />
                <input type="text" @bind="registroBox.Direccion" class="form-control input-dark mb-4" placeholder="Dirección Completa" />

                <hr class="divider" />

                <div class="section-title"><i class="fas fa-user-shield"></i> DATOS DEL ADMINISTRADOR</div>
                <p class="small-text">Esta cuenta tendrá acceso total al sistema.</p>

                <div class="row">
                    <div class="col-6">
                        <input type="text" @bind="registroBox.NombreAdmin" class="form-control input-dark mb-2" placeholder="Nombre" />
                    </div>
                    <div class="col-6">
                        <input type="text" @bind="registroBox.ApellidosAdmin" class="form-control input-dark mb-2" placeholder="Apellidos" />
                    </div>
                </div>

                <input type="email" @bind="registroBox.Email" class="form-control input-dark mb-2" placeholder="Correo Electrónico (Usuario)" />

                <input type="password" @bind="registroBox.Password" class="form-control input-dark mb-2" placeholder="Contraseña" />
                <input type="password" @bind="confirmarPass" class="form-control input-dark mb-2" placeholder="Confirmar Contraseña" />

            </div>

            <div class="modal-footer">
                <button class="btn-cancel" @onclick="() => mostrarModalBox = false">Cancelar</button>
                <button class="btn-confirm" @onclick="GuardarNuevoBox">REGISTRAR LUGAR</button>
            </div>
        </div>
    </div>
}


@if (mostrarModalRegistro)
{
    <div class="modal fade show" style="display: block; background-color: rgba(0, 0, 0, 0.85); z-index: 10000;" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="background-color: #1a1a1a; border: 1px solid #F8C545; color: white;">

                <div class="modal-header" style="border-bottom: 1px solid #444;">
                    <h5 class="modal-title" style="font-family:'Oswald'; color: #F8C545;">NUEVO ATLETA</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarModalRegistro"></button>
                </div>

                <div class="modal-body">
                    <input type="text" @bind="regNombre" class="input-custom" placeholder="Nombre" />
                    <input type="text" @bind="regApellidos" class="input-custom" placeholder="Apellidos" />
                    <input type="email" @bind="regEmail" class="input-custom" placeholder="Email" />
                    <select @bind="regBoxId" class="input-custom" style="background-color: #333; color: white;">
                        <option value="">-- Selecciona tu lugar de entrenamiento --</option>
                        @foreach (var box in listaBoxes)
                        {
                            <option value="@box.Id">@box.Nombre</option>
                        }
                    </select>
                    <input type="password" @bind="regPass" class="input-custom" placeholder="Contraseña" />
                    <input type="password" @bind="regConfirmPass" class="input-custom" placeholder="Confirmar Contraseña" />

                    @if (!string.IsNullOrEmpty(registroError))
                    {
                        <div class="alert-error">@registroError</div>
                    }
                </div>

                <div class="modal-footer" style="border-top: none; justify-content: space-between;">
                    <button type="button" class="btn btn-secondary" @onclick="CerrarModalRegistro">Cancelar</button>
                    <button type="button" class="btn btn-warning" style="background-color:#F8C545; font-weight:bold;" @onclick="RegistrarUsuario">Guardar</button>
                </div>

            </div>
        </div>
    </div>
}
<style>

    .btn-link-gold {
        background: none; border: none; 
        color: #F8C545; text-decoration: underline; 
        font-size: 0.9rem; cursor: pointer;
        transition: color 0.3s;
    }
    .btn-link-gold:hover { color: white; }

    .section-title {
        color: white; font-weight: bold; font-family: 'Oswald';
        border-bottom: 1px solid #F8C545; padding-bottom: 5px; margin-bottom: 10px;
        font-size: 1.1rem;
    }
    
    .divider { border-color: #333; margin: 15px 0; }
    .small-text { color: #888; font-size: 0.8rem; margin-bottom: 10px; }
    
    /* Scroll si el formulario es muy largo en móviles */
    .scrollable-body { max-height: 70vh; overflow-y: auto; padding: 20px; }

    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; display: flex; justify-content: center; align-items: center; }
    .custom-modal { background: #1a1a1a; width: 95%; max-width: 500px; border: 1px solid #F8C545; border-radius: 12px; display: flex; flex-direction: column; }
    .input-dark { background: #333 !important; color: white !important; border: 1px solid #666; }
    .btn-confirm { background: #F8C545; color: black; border: none; padding: 10px; font-weight: bold; flex: 1; border-radius: 5px; }
    .btn-cancel { background: #333; color: white; border: none; padding: 10px; font-weight: bold; flex: 1; border-radius: 5px; }
    .btn-close-custom { background: none; border: none; color: white; font-size: 1.2rem; }
    .modal-header, .modal-footer { padding: 15px; }

    .login-container-fullscreen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: url('imagenes/TIMER.png') no-repeat center center;
        background-size: cover;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10;
    }

        .login-container-fullscreen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: -1;
        }

    .login-wrapper {
        text-align: center;
        width: 90%;
        max-width: 400px;
        padding: 20px;
        color: white;
    }

    .title-main {
        font-family: 'Oswald', sans-serif;
        font-size: 3rem;
        color: #F8C545;
        margin: 0;
        line-height: 1;
    }

    .title-sub {
        font-family: 'Oswald', sans-serif;
        font-size: 2rem;
        color: white;
        margin-bottom: 30px;
    }

    .input-custom {
        width: 100%;
        background: rgba(255, 255, 255, 0.15);
        border: 2px solid #fff;
        border-radius: 30px;
        padding: 12px 20px;
        color: #fff;
        margin-bottom: 10px;
        text-align: center;
        outline: none;
    }

        .input-custom:focus {
            border-color: #F8C545;
            background: rgba(255, 255, 255, 0.25);
        }

    .btn-login {
        background-color: #928453;
        color: #fff;
        border: none;
        padding: 10px 50px;
        border-radius: 30px;
        font-size: 1.2rem;
        font-family: 'Oswald', sans-serif;
        margin-top: 20px;
        width: 100%;
    }

    .brand-header {
        position: absolute;
        top: 30px;
        left: 30px;
        color: #fff;
        text-align: left;
    }

    .alert-error {
        color: #ff6b6b;
        background: rgba(0,0,0,0.8);
        padding: 5px;
        border-radius: 5px;
        margin-bottom: 10px;
    }

    .forgot-pass {
        color: #ccc;
        text-decoration: none;
        display: block;
        margin-top: 10px;
        cursor: pointer;
    }

    /* Asegura que los inputs sean visibles y escribibles */
    .modal-body .input-custom {
        background-color: #333333 !important; /* Fondo gris oscuro, no transparente */
        color: white !important; /* Texto blanco */
        border: 1px solid #666;
        z-index: 10001; /* Asegura que esté por encima del fondo */
        position: relative; /* Necesario para que el z-index funcione */
    }

        .modal-body .input-custom:focus {
            border-color: #F8C545;
            background-color: #444 !important;
        }

</style>

@code {
    // --- VARIABLES DE LOGIN ---
    private string loginUsername;
    private string loginPassword;
    private string loginError;

    // --- VARIABLES DE REGISTRO ---
    private bool mostrarModalRegistro = false;
    private string regNombre;
    private string regApellidos;
    private string regEmail;
    private string regPass;
    private string regConfirmPass;
    private string registroError;
    private Guid regBoxId; 
    private List<BoxDto> listaBoxes = new List<BoxDto>();

    private bool mostrarModalBox = false;
    private RegistroBoxDto registroBox = new RegistroBoxDto();
    private string confirmarPass = "";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var response = await Http.GetAsync("https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/authapi/boxes");
            if (response.IsSuccessStatusCode)
            {
                listaBoxes = await response.Content.ReadFromJsonAsync<List<BoxDto>>();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error cargando boxes: " + ex.Message);
        }
    }

    private void AbrirModalRegistroBox()
    {
        registroBox = new RegistroBoxDto(); // Limpiar
        confirmarPass = "";
        mostrarModalBox = true;
    }

    private void AbrirModalRegistro() => mostrarModalRegistro = true;
    private void CerrarModalRegistro()
    {
        mostrarModalRegistro = false;
        registroError = ""; // Limpiar errores al cerrar
    }

    // --- LÓGICA LOGIN ---
    private async Task IniciarSesion()
    {
        loginError = "";
        try
        {
            var loginData = new { Username = loginUsername, Password = loginPassword };

           
            var response = await Http.PostAsJsonAsync("https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/authapi/login", loginData);

            if (response.IsSuccessStatusCode)
            {
               
                var usuarioRecibido = await response.Content.ReadFromJsonAsync<UsuarioSesionDto>();

               
                Sesion.Usuario = usuarioRecibido;

              
                Nav.NavigateTo("/home");
            }
            else
            {
                loginError = "Credenciales incorrectas.";
            }
        }
        catch (Exception ex)
        {
            loginError = "Error de conexión con el servidor.";
        }
    }

    // --- LÓGICA REGISTRO ---
    private async Task RegistrarUsuario()
    {
        registroError = "";

        if (regBoxId == Guid.Empty)
        {
            registroError = "Por favor selecciona un Box.";
            return;
        }
        
        if (regPass != regConfirmPass)
        {
            registroError = "Las contraseñas no coinciden.";
            return;
        }
        if (string.IsNullOrEmpty(regEmail) || string.IsNullOrEmpty(regPass))
        {
            registroError = "Todos los campos son obligatorios.";
            return;
        }

       

        try
        {
          
            var nuevoUsuario = new
            {
                Nombre = regNombre,
                Apellidos = regApellidos,
                CorreoElectronico = regEmail,
                Password = regPass,
                ConfirmPass = regConfirmPass,
                BoxID = regBoxId
            };

            // 3. Llamar a la API
            var response = await Http.PostAsJsonAsync("https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/authapi/registrar", nuevoUsuario);

            if (response.IsSuccessStatusCode)
            {
                // Éxito: Cerrar modal y avisar
                mostrarModalRegistro = false;
                await App.Current.MainPage.DisplayAlert("¡Éxito!", "Usuario creado correctamente. Ahora puedes iniciar sesión.", "OK");
            }
            else
            {
                // Error que viene de la API (ej: "El correo ya existe")
                var errorJson = await response.Content.ReadFromJsonAsync<ErrorResponse>();
                registroError = errorJson?.mensaje ?? "No se pudo registrar.";
            }
        }
        catch (Exception ex)
        {
            registroError = "Error al conectar con la API.";
        }
    }

    private async Task GuardarNuevoBox()
    {
        // 1. Validaciones
        if (string.IsNullOrEmpty(registroBox.NombreBox) || string.IsNullOrEmpty(registroBox.NombreAdmin) || string.IsNullOrEmpty(registroBox.Email))
        {
            await App.Current.MainPage.DisplayAlert("Error", "Por favor llena los campos obligatorios.", "OK");
            return;
        }

        if (registroBox.Password != confirmarPass)
        {
            await App.Current.MainPage.DisplayAlert("Error", "Las contraseñas no coinciden.", "OK");
            return;
        }

        try
        {
            // 2. Enviar a la API
            var response = await Http.PostAsJsonAsync("https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/boxesAPI/registrar-nuevo", registroBox);

            if (response.IsSuccessStatusCode)
            {
                await App.Current.MainPage.DisplayAlert("¡Bienvenido!", "Tu lugar de entrenamiento y tu cuenta de Administrador han sido creados. Ya puedes iniciar sesión.", "OK");
                mostrarModalBox = false;
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                await App.Current.MainPage.DisplayAlert("Error", $"No se pudo registrar: {error}", "OK");
            }
        }
        catch (Exception ex)
        {
            await App.Current.MainPage.DisplayAlert("Error", ex.Message, "OK");
        }
    }

    // Clase auxiliar para leer errores simples
    public class ErrorResponse { public string mensaje { get; set; } }
}