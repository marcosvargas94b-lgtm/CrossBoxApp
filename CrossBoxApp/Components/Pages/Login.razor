@page "/"
@using System.Net.Http.Json
@inject NavigationManager Nav
@inject HttpClient Http
@inject CrossBoxApp.Models.Services.SesionService Sesion
@using CrossBoxApp.Models

<div class="login-container-fullscreen">
    <div class="brand-header">
        <strong>@DateTime.Now.ToString("dd/MM/yyyy")</strong><br />
        By ALFAFIT
    </div>

    <div class="login-wrapper">
        <h1 class="title-main">MY CROSSBOX</h1>
        <h2 class="title-sub">INICIO DE SESIÓN</h2>

        <div class="form-group">
            <input type="text" @bind="loginUsername" class="input-custom" placeholder="Username (Email)" />
        </div>
        <div class="form-group">
            <input type="password" @bind="loginPassword" class="input-custom" placeholder="Password" />
        </div>

        @if (!string.IsNullOrEmpty(loginError))
        {
            <div class="alert-error">@loginError</div>
        }

        <a href="#" class="forgot-pass">Forgot Password?</a>
        <button class="btn-login" @onclick="IniciarSesion">Login</button>

        <a href="#" class="forgot-pass" style="margin-top: 30px; color: #F8C545; font-weight: bold;"
           @onclick="AbrirModalRegistro">
            ¿No tienes cuenta? ¡Regístrate aquí!
        </a>

        <div class="mt-4 text-center">
            <button class="btn-link-gold" @onclick="AbrirModalRegistroBox">
                <i class="fas fa-store-alt"></i> ¡Registra tu lugar de entrenamiento!
            </button>
        </div>
    </div>
</div>

@if (mostrarModalBox)
{
    <div class="modal-overlay">
        <div class="modal-content custom-modal">
            <div class="modal-header">
                <h5 style="color:#F8C545; font-family:'Oswald'; margin:0;">REGISTRA TU LUGAR</h5>
                <button class="btn-close-custom" @onclick="() => mostrarModalBox = false"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body scrollable-body">
                <div class="section-title"><i class="fas fa-building"></i> DATOS DEL LUGAR</div>
                <input type="text" @bind="registroBox.NombreBox" class="form-control input-dark mb-2" placeholder="Nombre del Box / Gym" />
                <input type="text" @bind="registroBox.Ciudad" class="form-control input-dark mb-2" placeholder="Ciudad" />
                <input type="text" @bind="registroBox.Direccion" class="form-control input-dark mb-4" placeholder="Dirección Completa" />
                <hr class="divider" />
                <div class="section-title"><i class="fas fa-user-shield"></i> DATOS DEL ADMINISTRADOR</div>
                <p class="small-text">Esta cuenta tendrá acceso total al sistema.</p>
                <div class="row">
                    <div class="col-6"><input type="text" @bind="registroBox.NombreAdmin" class="form-control input-dark mb-2" placeholder="Nombre" /></div>
                    <div class="col-6"><input type="text" @bind="registroBox.ApellidosAdmin" class="form-control input-dark mb-2" placeholder="Apellidos" /></div>
                </div>
                <input type="email" @bind="registroBox.Email" class="form-control input-dark mb-2" placeholder="Correo Electrónico (Usuario)" />
                <input type="password" @bind="registroBox.Password" class="form-control input-dark mb-2" placeholder="Contraseña" />
                <input type="password" @bind="confirmarPass" class="form-control input-dark mb-2" placeholder="Confirmar Contraseña" />
            </div>
            <div class="section-title"><i class="fas fa-gem"></i> ELIGE TU PLAN</div>
            <div class="planes-grid mb-4">
                <div class="plan-card @(registroBox.PlanSeleccionadoID == 1 ? "selected" : "")" @onclick="() => registroBox.PlanSeleccionadoID = 1">
                    <div class="plan-name">MENSUAL</div><div class="plan-price">$250.00</div><div class="plan-desc">Pago mes a mes</div>
                    @if (registroBox.PlanSeleccionadoID == 1)
                    {
                        <i class="fas fa-check-circle check-icon"></i>
                    }
                </div>
                <div class="plan-card @(registroBox.PlanSeleccionadoID == 2 ? "selected" : "")" @onclick="() => registroBox.PlanSeleccionadoID = 2">
                    <div class="plan-badge">AHORRA 6 MESES</div><div class="plan-name">ANUAL</div><div class="plan-price">$1,600.00</div><div class="plan-desc">Un solo pago al año</div>
                    @if (registroBox.PlanSeleccionadoID == 2)
                    {
                        <i class="fas fa-check-circle check-icon"></i>
                    }
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" @onclick="() => mostrarModalBox = false">Cancelar</button>
                <button class="btn-confirm" @onclick="GuardarNuevoBox">REGISTRAR LUGAR</button>
            </div>
        </div>
    </div>
}

@if (mostrarModalRegistro)
{
    <div class="modal fade show" style="display: block; background-color: rgba(0, 0, 0, 0.85); z-index: 10000;" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="background-color: #1a1a1a; border: 1px solid #F8C545; color: white;">

                <div class="modal-header" style="border-bottom: 1px solid #444;">
                    <h5 class="modal-title" style="font-family:'Oswald'; color: #F8C545;">NUEVO ATLETA</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarModalRegistro"></button>
                </div>

                <div class="modal-body">
                    <input type="text" @bind="regNombre" class="input-custom" placeholder="Nombre" />
                    <input type="text" @bind="regApellidos" class="input-custom" placeholder="Apellidos" />
                    <input type="email" @bind="regEmail" class="input-custom" placeholder="Email" />                  
                    <select class="input-custom" style="background-color: #333; color: white;" @onchange="AlSeleccionarBox">
                        <option value="">-- Selecciona tu lugar de entrenamiento --</option>
                        @foreach (var box in listaBoxes)
                        {
                            <option value="@box.BoxID.ToString()">@box.Nombre</option>
                        }
                    </select>

                    @if (boxSeleccionado != null && boxSeleccionado.CostoInscripcion != null && boxSeleccionado.CostoInscripcion > 0)
                    {
                        <div class="costo-alert fade-in">
                            <i class="fas fa-ticket-alt"></i>
                            <div>
                                <strong>COSTO DE INSCRIPCIÓN:</strong>
                                <span class="precio">$@boxSeleccionado.CostoInscripcion</span>
                                <div class="small-text-costo">Pago único permanente para @boxSeleccionado.Nombre</div>
                            </div>
                        </div>
                    }

                    <input type="password" @bind="regPass" class="input-custom" placeholder="Contraseña" />
                    <input type="password" @bind="regConfirmPass" class="input-custom" placeholder="Confirmar Contraseña" />

                    @if (!string.IsNullOrEmpty(registroError))
                    {
                        <div class="alert-error">@registroError</div>
                    }
                </div>

                <div class="modal-footer" style="border-top: none; justify-content: space-between;">
                    <button type="button" class="btn btn-secondary" @onclick="CerrarModalRegistro">Cancelar</button>
                    <button type="button" class="btn btn-warning" style="background-color:#F8C545; font-weight:bold;" @onclick="RegistrarUsuario">Guardar</button>
                </div>

            </div>
        </div>
    </div>
}

<style>
    /* Estilos Generales Login */
    .login-container-fullscreen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: url('imagenes/TIMER.png') no-repeat center center;
        background-size: cover;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10;
    }

        .login-container-fullscreen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: -1;
        }

    .login-wrapper {
        text-align: center;
        width: 90%;
        max-width: 400px;
        padding: 20px;
        color: white;
    }

    .title-main {
        font-family: 'Oswald', sans-serif;
        font-size: 3rem;
        color: #F8C545;
        margin: 0;
        line-height: 1;
    }

    .title-sub {
        font-family: 'Oswald', sans-serif;
        font-size: 2rem;
        color: white;
        margin-bottom: 30px;
    }

    .input-custom {
        width: 100%;
        background: rgba(255, 255, 255, 0.15);
        border: 2px solid #fff;
        border-radius: 30px;
        padding: 12px 20px;
        color: #fff;
        margin-bottom: 10px;
        text-align: center;
        outline: none;
    }

        .input-custom:focus {
            border-color: #F8C545;
            background: rgba(255, 255, 255, 0.25);
        }

    .btn-login {
        background-color: #928453;
        color: #fff;
        border: none;
        padding: 10px 50px;
        border-radius: 30px;
        font-size: 1.2rem;
        font-family: 'Oswald', sans-serif;
        margin-top: 20px;
        width: 100%;
    }

    .brand-header {
        position: absolute;
        top: 30px;
        left: 30px;
        color: #fff;
        text-align: left;
    }

    .alert-error {
        color: #ff6b6b;
        background: rgba(0,0,0,0.8);
        padding: 5px;
        border-radius: 5px;
        margin-bottom: 10px;
    }

    .forgot-pass {
        color: #ccc;
        text-decoration: none;
        display: block;
        margin-top: 10px;
        cursor: pointer;
    }

    .btn-link-gold {
        background: none;
        border: none;
        color: #F8C545;
        text-decoration: underline;
        font-size: 0.9rem;
        cursor: pointer;
        transition: color 0.3s;
    }

        .btn-link-gold:hover {
            color: white;
        }

    /* Modales */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.9);
        z-index: 3000;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .custom-modal {
        background: #1a1a1a;
        width: 95%;
        max-width: 500px;
        border: 1px solid #F8C545;
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        max-height: 90vh;
        overflow: hidden;
    }

    .scrollable-body {
        padding: 20px;
        overflow-y: auto;
        flex: 1;
    }

    .section-title {
        color: white;
        font-weight: bold;
        font-family: 'Oswald';
        border-bottom: 1px solid #F8C545;
        padding-bottom: 5px;
        margin-bottom: 10px;
        font-size: 1.1rem;
    }

    .divider {
        border-color: #333;
        margin: 15px 0;
    }

    .small-text {
        color: #888;
        font-size: 0.8rem;
        margin-bottom: 10px;
    }

    .input-dark {
        background: #333 !important;
        color: white !important;
        border: 1px solid #666;
    }

    .btn-confirm {
        background: #F8C545;
        color: black;
        border: none;
        padding: 10px;
        font-weight: bold;
        flex: 1;
        border-radius: 5px;
    }

    .btn-cancel {
        background: #333;
        color: white;
        border: none;
        padding: 10px;
        font-weight: bold;
        flex: 1;
        border-radius: 5px;
    }

    .btn-close-custom {
        background: none;
        border: none;
        color: white;
        font-size: 1.2rem;
    }

    .modal-header, .modal-footer {
        padding: 15px;
    }

    .modal-footer {
        border-top: 1px solid #333;
        background: #1a1a1a;
        flex-shrink: 0;
    }

    /* Planes Grid */
    .planes-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }

    .plan-card {
        background: #222;
        border: 1px solid #444;
        border-radius: 10px;
        padding: 15px;
        text-align: center;
        cursor: pointer;
        position: relative;
        transition: all 0.3s;
    }

        .plan-card:hover {
            border-color: #F8C545;
        }

        .plan-card.selected {
            background: rgba(248, 197, 69, 0.1);
            border: 2px solid #F8C545;
            transform: scale(1.02);
        }

    .plan-name {
        font-family: 'Oswald';
        color: white;
        font-size: 1.1rem;
    }

    .plan-price {
        font-family: 'Oswald';
        color: #F8C545;
        font-size: 1.5rem;
        font-weight: bold;
        margin: 5px 0;
    }

    .plan-desc {
        font-size: 0.8rem;
        color: #aaa;
    }

    .check-icon {
        position: absolute;
        top: 10px;
        right: 10px;
        color: #28a745;
        font-size: 1.2rem;
    }

    .plan-badge {
        position: absolute;
        top: -10px;
        left: 50%;
        transform: translateX(-50%);
        background: #28a745;
        color: white;
        font-size: 0.6rem;
        padding: 2px 8px;
        border-radius: 10px;
        font-weight: bold;
        white-space: nowrap;
    }

    /* Estilos Modal Atleta Inputs */
    .modal-body .input-custom {
        background-color: #333333 !important;
        color: white !important;
        border: 1px solid #666;
        z-index: 10001;
        position: relative;
    }

        .modal-body .input-custom:focus {
            border-color: #F8C545;
            background-color: #444 !important;
        }

    /* NUEVO: ALERTA DE COSTO */
    .costo-alert {
        background: rgba(248, 197, 69, 0.1);
        border: 1px solid #F8C545;
        border-radius: 8px;
        padding: 10px;
        margin: 10px 0;
        display: flex;
        align-items: center;
        gap: 15px;
        color: white;
        animation: fadeIn 0.5s;
    }

        .costo-alert i {
            font-size: 1.5rem;
            color: #F8C545;
        }

    .precio {
        color: #F8C545;
        font-weight: bold;
        font-size: 1.1rem;
        font-family: 'Oswald';
        margin-left: 5px;
    }

    .small-text-costo {
        font-size: 0.75rem;
        color: #ccc;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-5px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

@code {
    // Login
    private string loginUsername;
    private string loginPassword;
    private string loginError;

    // Registro Atleta
    private bool mostrarModalRegistro = false;
    private string regNombre;
    private string regApellidos;
    private string regEmail;
    private string regPass;
    private string regConfirmPass;
    private string registroError;

    // Lista de Boxes y Selección
    private List<Boxes> listaBoxes = new List<Boxes>();
    private Boxes boxSeleccionado;
    private Guid regBoxId;

    // Registro Dueño (Box)
    private bool mostrarModalBox = false;
    private RegistroBoxes registroBox = new RegistroBoxes();
    private string confirmarPass = "";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var response = await Http.GetAsync("https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/authapi/boxes");
            if (response.IsSuccessStatusCode) listaBoxes = await response.Content.ReadFromJsonAsync<List<Boxes>>();
        }
        catch { }
    }

    private void AlSeleccionarBox(ChangeEventArgs e)
    {
        // 1. REINICIO TOTAL: Borramos cualquier selección anterior inmediatamente
        boxSeleccionado = null;
        regBoxId = Guid.Empty;

        // 2. Obtenemos el valor del dropdown
        string idStr = e.Value?.ToString();

        // 3. Si hay un ID válido (no es la opción por defecto "-- Selecciona --")
        if (!string.IsNullOrEmpty(idStr) && Guid.TryParse(idStr, out Guid id))
        {
            regBoxId = id; // Guardamos el ID para el registro

            // 4. Buscamos el box en la lista
            var encontrado = listaBoxes.FirstOrDefault(b => b.BoxID == id);

            // 5. Solo si el box existe Y tiene un costo mayor a 0, lo asignamos a la variable visual
            if (encontrado != null)
            {
                // Asignamos el objeto completo para que el HTML pueda leer el precio y el nombre
                boxSeleccionado = encontrado;
            }
        }

        // 6. Forzamos a la pantalla a redibujarse para quitar/poner el aviso
        StateHasChanged();
    }

    private void AbrirModalRegistroBox()
    {
        registroBox = new RegistroBoxes { PlanSeleccionadoID = 1 };
        confirmarPass = "";
        mostrarModalBox = true;
    }

    private void AbrirModalRegistro() => mostrarModalRegistro = true;

    private void CerrarModalRegistro()
    {
        mostrarModalRegistro = false;
        registroError = "";
        boxSeleccionado = null; // Limpiar selección al cerrar
    }

    private async Task IniciarSesion()
    {
        loginError = "";
        try
        {
            var loginData = new { Username = loginUsername, Password = loginPassword };

            var response = await Http.PostAsJsonAsync("https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/authapi/login", loginData);

            if (response.IsSuccessStatusCode)
            {
                // LOGIN EXITOSO (200 OK)
                var usuarioRecibido = await response.Content.ReadFromJsonAsync<UsuarioSesionDto>();
                Sesion.Usuario = usuarioRecibido;
                Nav.NavigateTo("/home");
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.Forbidden) // ⚠️ CÓDIGO 403 (NO VALIDADO)
            {
                // AQUÍ ATRAPAMOS AL USUARIO EN ESPERA
                await App.Current.MainPage.DisplayAlert("⏳ CUENTA EN ESPERA",
                    "Tu registro fue exitoso, pero debes esperar a que el administrador de tu Box acepte tu solicitud para poder ingresar.",
                    "Entendido");
            }
            else
            {
                // CUALQUIER OTRO ERROR (401, 404, 500)
                loginError = "Credenciales incorrectas o error de servidor.";
            }
        }
        catch (Exception ex)
        {
            loginError = "Error de conexión: " + ex.Message;
        }
    }

    private async Task RegistrarUsuario()
    {
        registroError = "";
        if (regBoxId == Guid.Empty) { registroError = "Por favor selecciona un Box."; return; }
        if (regPass != regConfirmPass) { registroError = "Las contraseñas no coinciden."; return; }
        if (string.IsNullOrEmpty(regEmail) || string.IsNullOrEmpty(regPass)) { registroError = "Campos obligatorios."; return; }

        try
        {
            var nuevoUsuario = new { Nombre = regNombre, Apellidos = regApellidos, CorreoElectronico = regEmail, Password = regPass, ConfirmPass = regConfirmPass, BoxID = regBoxId };
            var response = await Http.PostAsJsonAsync("https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/authapi/registrar", nuevoUsuario);

            if (response.IsSuccessStatusCode)
            {
                mostrarModalRegistro = false;
                await App.Current.MainPage.DisplayAlert("¡Éxito!", "Usuario creado correctamente.", "OK");
            }
            else
            {
                var errorJson = await response.Content.ReadFromJsonAsync<ErrorResponse>();
                registroError = errorJson?.mensaje ?? "No se pudo registrar.";
            }
        }
        catch { registroError = "Error al conectar con la API."; }
    }

    private async Task GuardarNuevoBox()
    {
        if (string.IsNullOrEmpty(registroBox.NombreBox) || string.IsNullOrEmpty(registroBox.Email)) { await App.Current.MainPage.DisplayAlert("Error", "Llena los campos.", "OK"); return; }
        if (registroBox.Password != confirmarPass) { await App.Current.MainPage.DisplayAlert("Error", "Contraseñas no coinciden.", "OK"); return; }

        try
        {
            var response = await Http.PostAsJsonAsync("https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/boxesAPI/registrar-nuevo", registroBox);
            if (response.IsSuccessStatusCode)
            {
                await App.Current.MainPage.DisplayAlert("¡Bienvenido!", "Box y Admin creados.", "OK");
                mostrarModalBox = false;
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                await App.Current.MainPage.DisplayAlert("Error", error, "OK");
            }
        }
        catch (Exception ex) { await App.Current.MainPage.DisplayAlert("Error", ex.Message, "OK"); }
    }

    public class ErrorResponse { public string mensaje { get; set; } }
}