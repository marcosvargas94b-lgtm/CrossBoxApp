@page "/progreso-view"
@using CrossBoxApp.Models
@using CrossBoxApp.Models.Services
@inject NavigationManager Nav
@inject HttpClient Http
@inject SesionService Sesion

<div class="top-navbar">
    <div class="nav-left" @onclick="Volver">
        <i class="fas fa-arrow-left"></i> VOLVER
    </div>
    <div class="nav-title">MI PROGRESO</div>
    <div class="nav-right"></div>
</div>

<div class="progress-container">
    @if (!cargando && gruposProgreso.Any())
    {
        <div class="instruction-banner">
            <i class="fas fa-hand-pointer"></i> Toca una marca para ver tu historial completo
        </div>
    }
    @if (cargando)
    {
        <div class="text-center mt-5">
            <div class="spinner-border text-warning"></div>
        </div>
    }
    else if (!gruposProgreso.Any())
    {
        <div class="empty-state">
            <i class="fas fa-chart-line"></i>
            <h3>SIN REGISTROS</h3>
            <p>Aún no hay datos de progreso disponibles.</p>
        </div>
    }
    else
    {
        @foreach (var grupo in gruposProgreso)
        {
            <div class="category-section">
                <div class="category-header">
                    @grupo.Key.ToUpper()
                </div>

                <div class="records-list">
                    @foreach (var item in grupo)
                    {
                        <div class="record-item" @onclick="() => VerHistorial(item.TestBoxId, item.NombreTest)">
                            <span class="record-name">@item.NombreTest</span>

                            <div class="record-value-wrapper">
                                <span class="record-num">@item.Valor</span>
                                <span class="record-unit">@item.Medida</span>
                            </div>
                            <i class="fas fa-history history-icon"></i>
                        </div>
                    }
                </div>
            </div>
        }
    }
</div>

@if (mostrarHistorial)
{
    <div class="modal-overlay" @onclick="CerrarModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h4>@nombreEjercicioSeleccionado</h4>
                <button class="btn-close" @onclick="CerrarModal"><i class="fas fa-times"></i></button>
            </div>

            <div class="history-list">
                @if (historialCargado == null)
                {
                    <div class="text-center p-3"><div class="spinner-border text-warning"></div></div>
                }
                else if (historialCargado.Count == 0)
                {
                    <div class="text-center p-3 text-muted">Solo tienes un registro.</div>
                }
                else
                {
                    @foreach (var h in historialCargado)
                    {
                        <div class="history-item @(h.EsRecordActual ? "current-pr" : "")">
                            <div class="h-date">
                                <i class="far fa-calendar-alt"></i> @h.Fecha.ToString("dd/MM/yyyy")
                            </div>
                            <div class="h-value">
                                @h.Valor <span class="unit-small">@h.Unidad</span>
                            </div>
                            @if (h.EsRecordActual)
                            {
                                <span class="badge-pr"><i class="fas fa-trophy"></i> PR ACTUAL</span>
                            }
                        </div>
                    }
                }
            </div>
        </div>
    </div>
}

<style>
    /* ... (TUS ESTILOS ORIGINALES SE MANTIENEN IGUAL) ... */

    .instruction-banner {
        text-align: center;
        color: #888; /* Gris sutil */
        font-size: 0.85rem;
        margin-bottom: 20px;
        font-family: 'Roboto', sans-serif;
        background: rgba(255, 255, 255, 0.05); /* Fondo muy tenue */
        padding: 8px;
        border-radius: 20px;
        border: 1px dashed #444;
        animation: fadeIn 1s ease-in-out;
    }

        .instruction-banner i {
            color: #F8C545; /* Mano amarilla */
            margin-right: 5px;
            animation: bounce 2s infinite; /* La manita se mueve suavemente */
        }

    /* Pequeña animación para la mano */
    @@keyframes bounce {
        0%, 100% {
            transform: translateY(0);
        }

        50% {
            transform: translateY(-3px);
        }
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    .top-navbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background: #1a1a1a;
        border-bottom: 2px solid #F8C545;
        color: white;
        font-family: 'Oswald';
        position: sticky;
        top: 0;
        z-index: 100;
    }

    .nav-left {
        color: #F8C545;
        cursor: pointer;
    }

    .nav-title {
        font-size: 1.2rem;
        letter-spacing: 1px;
    }

    .nav-right {
        width: 60px;
    }

    .progress-container {
        padding: 20px;
        background: #0d0d0d;
        min-height: 100vh;
        color: white;
    }

    .category-section {
        margin-bottom: 30px;
    }

    .category-header {
        color: #F8C545;
        font-family: 'Oswald';
        font-size: 1.3rem;
        border-bottom: 1px solid #F8C545;
        padding-bottom: 5px;
        margin-bottom: 10px;
        letter-spacing: 1px;
    }

    .records-list {
        background-color: #1a1a1a;
        border-radius: 10px;
        padding: 5px 15px;
        border: 1px solid #333;
    }

    /* Modificación al Item para que parezca botón */
    .record-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #333;
        cursor: pointer;
        position: relative;
    }

        .record-item:last-child {
            border-bottom: none;
        }

        .record-item:active {
            background-color: #222;
        }
    /* Efecto visual al tocar */

    .record-name {
        font-family: 'Roboto';
        font-size: 1rem;
        color: #eee;
    }

    .record-value-wrapper {
        display: flex;
        align-items: baseline;
        gap: 5px;
        margin-right: 20px;
    }
    /* Espacio para el ícono de historial */
    .record-num {
        font-family: 'Oswald';
        font-size: 1.4rem;
        color: white;
        font-weight: bold;
    }

    .record-unit {
        font-family: 'Oswald';
        font-size: 0.9rem;
        color: #F8C545;
        font-weight: bold;
        text-transform: uppercase;
    }

    .history-icon {
        color: #444;
        font-size: 0.8rem;
        position: absolute;
        right: 0;
    }

    .empty-state {
        text-align: center;
        margin-top: 60px;
        color: #666;
    }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 15px;
            color: #333;
        }

    /* --- NUEVOS ESTILOS DEL MODAL --- */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.85);
        z-index: 2000;
        display: flex;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(3px);
    }

    .modal-content {
        background: #1a1a1a;
        width: 90%;
        max-height: 70vh;
        border-radius: 15px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        border: 1px solid #F8C545;
        box-shadow: 0 10px 30px rgba(0,0,0,0.8);
    }

    .modal-header {
        background: #0d0d0d;
        padding: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #333;
    }

        .modal-header h4 {
            margin: 0;
            font-size: 1.1rem;
            font-family: 'Oswald';
            color: #F8C545;
            text-transform: uppercase;
        }

    .btn-close {
        background: none;
        border: none;
        color: white;
        font-size: 1.2rem;
    }

    .history-list {
        padding: 0;
        overflow-y: auto;
    }

    .history-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        border-bottom: 1px solid #333;
        color: #ccc;
        background: #1a1a1a;
    }

        .history-item.current-pr {
            background: rgba(248, 197, 69, 0.15);
            border-left: 4px solid #F8C545;
            color: white;
        }

    .h-date {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
        color: #aaa;
    }

    .current-pr .h-date {
        color: #F8C545;
    }

    .h-value {
        font-family: 'Oswald';
        font-size: 1.3rem;
        font-weight: bold;
    }

    .unit-small {
        font-size: 0.8rem;
        color: #888;
        font-weight: normal;
        margin-left: 2px;
    }

    .badge-pr {
        background: #F8C545;
        color: black;
        font-size: 0.7rem;
        padding: 3px 8px;
        border-radius: 10px;
        margin-left: 10px;
        font-weight: bold;
        font-family: 'Roboto';
        display: flex;
        align-items: center;
        gap: 4px;
    }

</style>

@code {
    private IEnumerable<IGrouping<string, EvaluacionVisualDto>> gruposProgreso = new List<IGrouping<string, EvaluacionVisualDto>>();
    private bool cargando = true;

    // Variables para el Modal
    private bool mostrarHistorial = false;
    private string nombreEjercicioSeleccionado = "";
    private List<HistorialDto> historialCargado;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            if (Sesion.Usuario == null) { Nav.NavigateTo("/"); return; }

            var boxId = Sesion.Usuario.BoxID;
            var userId = Sesion.Usuario.UsuarioID;

         
            var response = await Http.GetAsync($"https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/evaluacionesapi/usuario/{boxId}/{userId}");

            if (response.IsSuccessStatusCode)
            {
                var todosLosTests = await response.Content.ReadFromJsonAsync<List<EvaluacionVisualDto>>();

                gruposProgreso = todosLosTests
                    .Where(x => x.Valor.HasValue)
                    .GroupBy(x => x.Categoria)
                    .ToList();
            }
        }
        catch (Exception ex)
        {
            await App.Current.MainPage.DisplayAlert("Error", "No se pudo cargar el progreso", "OK");
        }
        finally
        {
            cargando = false;
        }
    }

    // --- NUEVO MÉTODO PARA CARGAR HISTORIAL ---
    private async Task VerHistorial(Guid testBoxId, string nombreTest)
    {
        nombreEjercicioSeleccionado = nombreTest;
        mostrarHistorial = true;
        historialCargado = null; // Para que muestre spinner en el modal si tarda

        try
        {
            var userId = Sesion.Usuario.UsuarioID;
            // Llamamos al endpoint nuevo que hicimos para las tablas TestUsuario
            historialCargado = await Http.GetFromJsonAsync<List<HistorialDto>>($"https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/Evaluacionesapi/historial/{userId}/{testBoxId}");
        }
        catch (Exception ex)
        {
            // Opcional: Mostrar alerta
            Console.WriteLine(ex.Message);
        }
    }

    private void CerrarModal() => mostrarHistorial = false;
    private void Volver() => Nav.NavigateTo("/home");
}