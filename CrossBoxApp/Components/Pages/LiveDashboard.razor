@page "/live-dashboard"
@using CrossBoxApp.Models
@using CrossBoxApp.Models.Services
@using Microsoft.AspNetCore.SignalR.Client
@using static CrossBoxApp.Components.Pages.LiveLobby 
@inject LiveSessionState LiveState
@inject NavigationManager Nav
@inject HttpClient Http
@inject SesionService Sesion
@inject IJSRuntime JS 
@implements IAsyncDisposable

@* --- AVISO DE GIRO PARA MÓVIL --- *@
<div class="rotate-warning">
    <div class="phone-animation">
        <i class="fas fa-mobile-alt"></i>
    </div>
    <h3>MODO DASHBOARD</h3>
    <p>Para controlar la clase, gira tu teléfono en horizontal.</p>
</div>

<div class="dashboard-container @(wodExpandido ? "wod-wide" : "")">
    
    @* SONIDOS *@
    <audio id="audio-beep" src="Sonidos/beep.mp3" preload="auto"></audio>
    <audio id="audio-go" src="Sonidos/go.mp3" preload="auto"></audio>
    <audio id="audio-medio" src="Sonidos/medio.mp3" preload="auto"></audio>

    @* --- PANEL 1: TIMER --- *@
    <div class="panel timer-panel @(verTimer ? "" : "collapsed")">
        @if (verTimer)
        {
            <div class="panel-header">
                <div class="header-left">
                    <span><i class="fas fa-stopwatch"></i> TIMER</span>
                    @if (!timerCorriendo)
                    {
                        <button class="btn-icon-header ml-2" @onclick="() => modoConfiguracion = !modoConfiguracion"><i class="fas fa-cog"></i></button>
                    }
                </div>
                <button class="btn-icon-header" @onclick="() => verTimer = false"><i class="fas fa-compress-arrows-alt"></i></button>
            </div>
            
            <div class="panel-content flex-center-vertical">
                @if (modoConfiguracion && !timerCorriendo)
                {
                    <div class="config-box slide-in">
                        <div class="timer-type-selector">
                            <button class="type-btn @(tipoTimer == 1 ? "active" : "")" @onclick="() => CambiarTipoTimer(1)">
                                <i class="fas fa-hourglass-start"></i> CUENTA ATRÁS
                            </button>
                            <button class="type-btn @(tipoTimer == 2 ? "active" : "")" @onclick="() => CambiarTipoTimer(2)">
                                <i class="fas fa-sync-alt"></i> INTERVALOS
                            </button>
                        </div>

                        <div class="inputs-grid">
                            <div class="input-group">
                                <label>TIEMPO DE TRABAJO</label>
                                <div class="time-inputs">
                                    <input type="number" @bind="inputMinutos" placeholder="00" />
                                    <span class="colon">:</span>
                                    <input type="number" @bind="inputSegundos" placeholder="00" />
                                </div>
                            </div>
                            
                            @if (tipoTimer == 2)
                            {
                                <div class="input-group">
                                    <label>RONDAS</label>
                                    <input type="number" @bind="inputRondas" class="single-input" />
                                </div>
                                <div class="input-group">
                                    <label>DESCANSO</label>
                                    <div class="time-inputs">
                                        <input type="number" @bind="inputMinDescanso" placeholder="00" />
                                        <span class="colon">:</span>
                                        <input type="number" @bind="inputSegDescanso" placeholder="00" />
                                    </div>
                                </div>
                            }
                        </div>
                        
                        <button class="btn-save-timer" @onclick="GuardarConfiguracion">
                            <i class="fas fa-check"></i> LISTO
                        </button>
                    </div>
                }
                else
                {
                    @if (enConteoPrevio)
                    {
                        <div class="prep-display pulse-animation">
                            <div class="prep-label">PREPARADOS</div>
                            <div class="prep-number">@tiempoPrevio</div>
                        </div>
                    }
                    else
                    {
                        <div class="timer-visual-group">
                            <div class="status-badge @(enDescanso ? "rest" : "work")">@(enDescanso ? "DESCANSO" : "WORK")</div>
                            <div class="timer-display @(timerCorriendo ? (enDescanso ? "resting" : "running") : "")">
                                @FormatoTiempo(tiempoRestanteActual)
                            </div>
                            @if (totalRondas > 1)
                            {
                                <div class="round-counter @(rondaActual == totalRondas ? "last-round-alert" : "")">
                                    RONDA <span class="big-round">@rondaActual</span> / @totalRondas
                                </div>
                            }
                        </div>
                    }
                    <div class="timer-controls">
                        @if (!timerCorriendo) { <button class="btn-control start" @onclick="IniciarSecuencia"><i class="fas fa-play"></i></button> }
                        else { <button class="btn-control stop" @onclick="PausarTimer"><i class="fas fa-pause"></i></button> }
                        <button class="btn-control reset" @onclick="ResetTimer"><i class="fas fa-undo"></i></button>
                    </div>
                }
            </div>
        }
        else { <div class="vertical-bar" @onclick="() => verTimer = true"><span class="v-text">TIMER</span><i class="fas fa-stopwatch v-icon"></i></div> }
    </div>

    @* --- PANEL 2: WOD (CON MARCA DE AGUA) --- *@
    <div class="panel wod-panel @(verWod ? "" : "collapsed")">
        @if (verWod)
        {
            <div class="panel-header">
                @if (wodHoy != null && wodHoy.Bloques != null && wodHoy.Bloques.Count > 0)
                {
                    <div class="header-select-wrapper">
                        <i class="fas fa-layer-group select-icon"></i>
                        <select class="header-select" @onchange="CambiarBloqueVisible">
                            <option value="@Guid.Empty" selected="@(segmentoSeleccionadoID == Guid.Empty)">WOD COMPLETO</option>
                            @foreach (var b in wodHoy.Bloques)
                            {
                                <option value="@b.SegmentoClaseID" selected="@(b.SegmentoClaseID == segmentoSeleccionadoID)">
                                    @(string.IsNullOrEmpty(b.NombreSegmento) ? "BLOQUE" : b.NombreSegmento.ToUpper())
                                </option>
                            }
                        </select>
                        <i class="fas fa-chevron-down select-arrow"></i>
                    </div>
                }
                else
                {
                    <span>WOD</span>
                }

                <div style="display:flex; gap:10px;">
                    <button class="btn-icon-header" @onclick="ToggleExpandirWod">
                        <i class="fas @(wodExpandido ? "fa-compress" : "fa-expand")"></i>
                    </button>
                    <button class="btn-icon-header" @onclick="() => verWod = false">
                        <i class="fas fa-compress-arrows-alt"></i>
                    </button>
                </div>
            </div>

            @* MARCA DE AGUA EN EL FONDO DEL WOD (SOLO SI HAY URL) *@
            @if (!string.IsNullOrEmpty(UrlLogoBox))
            {
                <div class="wod-watermark" style="background-image: url('@UrlLogoBox');"></div>
            }

            <div class="panel-content scroll-custom">
                @if (wodHoy != null && wodHoy.Bloques != null && wodHoy.Bloques.Count > 0)
                {
                    <div class="bloques-container">
                        @foreach (var bloque in wodHoy.Bloques)
                        {
                            @if (segmentoSeleccionadoID == Guid.Empty || bloque.SegmentoClaseID == segmentoSeleccionadoID)
                            {
                                <div class="wod-block fade-in">
                                    <h4 class="block-title">
                                        @(string.IsNullOrEmpty(bloque.NombreSegmento) ? "BLOQUE" : bloque.NombreSegmento.ToUpper())
                                    </h4>

                                    @if (bloque.Ejercicios != null)
                                    {
                                        <div class="exercises-wrapper">
                                            @foreach (var ej in bloque.Ejercicios)
                                            {
                                                <div class="ejercicio-row-clean">
                                                    <span class="ej-reps">@ej.PesoRepeticiones</span>
                                                    <div class="ej-nombre">
                                                        @((MarkupString)FormatearPesoPlateado(ej.Descripcion))
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                            }
                        }
                    </div>
                }
                else
                {
                    <div class="empty-state"><i class="fas fa-dumbbell"></i><p>@mensajeWod</p></div>
                }
            </div>
        }
        else
        {
            <div class="vertical-bar" @onclick="() => verWod = true"><span class="v-text">WORKOUT</span></div>
        }
    </div>

    @* --- PANEL 3: LISTA ATLETAS --- *@
    <div class="panel list-panel @(verLista ? "" : "collapsed")">
        @if (verLista) {
            <div class="panel-header">
                <span>CLASE</span>
                <div style="display:flex; gap:10px;">
                    <button class="btn-icon-header text-warning" @onclick="AbrirModalAtletas"><i class="fas fa-user-plus"></i></button>
                    <button class="btn-icon-header" @onclick="()=>verLista=false"><i class="fas fa-compress-arrows-alt"></i></button>
                </div>
            </div>
            
            <div class="panel-content scroll-custom"> 
                @if (LiveState.AtletasEnClase != null && LiveState.AtletasEnClase.Count > 0)
                {
                    <div class="atletas-grid">
                        @foreach (var atleta in LiveState.AtletasEnClase)
                        {
                            <div class="atleta-card slide-in">
                                <div class="avatar" style="@(!string.IsNullOrEmpty(atleta.FotoUrl) ? $"background-image: url('{atleta.FotoUrl}'); background-size:cover; border:none;" : "")">
                                    @if (string.IsNullOrEmpty(atleta.FotoUrl))
                                    {
                                        @atleta.NombreCompleto.Substring(0,1).ToUpper()
                                    }
                                </div>
                                <div class="name">@atleta.NombreCompleto</div>
                            </div>
                        }
                    </div>
                }
                else { <div class="empty-state"><i class="fas fa-users"></i><p>Esperando...</p></div> }
            </div>
            <button class="btn-terminate" @onclick="TerminarClase">TERMINAR</button>
        } else { <div class="vertical-bar" @onclick="()=>verLista=true"><span class="v-text">ATLETAS</span></div> }
    </div>
</div>

@* --- MODAL BUSCAR ATLETAS --- *@
@if (mostrarModalAtletas)
{
    <div class="modal-overlay">
        <div class="modal-content custom-modal">
            <div class="modal-header">
                <h5 style="margin:0; color:#F8C545; font-weight:bold;">SELECCIONAR ATLETA</h5>
                <button class="btn-icon-header" @onclick="() => mostrarModalAtletas = false"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="search-box mb-3">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="form-control input-dark search-input" placeholder="Buscar por nombre..." value="@filtroAtleta" @oninput="FiltrarAtletas" autofocus />
                </div>
                <div class="lista-atletas-scroll scroll-custom">
                    @if (listaTodosAtletas == null) { <div class="text-center py-3"><div class="spinner-border text-warning"></div></div> }
                    else if (listaAtletasFiltrada == null || listaAtletasFiltrada.Count == 0) { <p class="text-center text-muted mt-3">No hay resultados.</p> }
                    else
                    {
                        @foreach (var atleta in listaAtletasFiltrada)
                        {
                            @if (!LiveState.AtletasEnClase.Any(x => x.UsuarioId == atleta.UsuarioId))
                            {
                                <div class="atleta-row" @onclick="() => AgregarAtletaDesdeLista(atleta)">
                                    <div class="atleta-info">
                                        <div class="avatar-mini" style="@(!string.IsNullOrEmpty(atleta.FotoUrl) ? $"background-image: url('{atleta.FotoUrl}');" : "")">
                                            @if(string.IsNullOrEmpty(atleta.FotoUrl)) { @atleta.NombreCompleto.Substring(0,1).ToUpper() }
                                        </div>
                                        <div style="display:flex; flex-direction:column;">
                                            <span class="atleta-nombre">@atleta.NombreCompleto</span>
                                        </div>
                                    </div>
                                    <i class="fas fa-plus-circle add-icon"></i>
                                </div>
                            }
                        }
                    }
                </div>
            </div>
        </div>
    </div>
}

<style>
    /* --- 1. AVISO DE ROTACIÓN --- */
    .rotate-warning { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: #000; z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; color: #F8C545; text-align: center; padding: 40px; }
    .phone-animation { font-size: 4rem; margin-bottom: 20px; animation: rotarCelular 2s infinite ease-in-out; }
    @@keyframes rotarCelular { 0% { transform: rotate(0deg); } 50% { transform: rotate(-90deg); } 100% { transform: rotate(0deg); } }
    @@media (orientation: portrait) { .rotate-warning { display: flex; } .dashboard-container { display: none !important; } }

    /* --- 2. LAYOUT PRINCIPAL --- */
    .dashboard-container { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: #0d0d0d; color: white; display: flex; flex-direction: row; padding: 15px; gap: 15px; box-sizing: border-box; overflow: hidden; }

    /* --- 3. PANELES --- */
    .panel { flex: 1; display: flex; flex-direction: column; transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); background: #111; overflow: hidden; border-radius: 15px; border: 1px solid #222; box-shadow: 0 4px 15px rgba(0,0,0,0.5); min-width: 0; position: relative; } /* position relative es importante para la marca de agua */
    .panel.collapsed { flex: 0 0 60px !important; min-width: 60px; background: #000; cursor: pointer; border-color: #333; }
    .panel.collapsed:hover { background: #1a1a1a; }
    .panel.collapsed .panel-content, .panel.collapsed .panel-header .header-left, .panel.collapsed .panel-header span, .panel.collapsed .panel-header .header-select-wrapper { display: none; opacity: 0; }
    .panel-header { height: 50px; background: #1a1a1a; border-bottom: 2px solid #F8C545; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; font-family: 'Oswald'; font-size: 1.1rem; color: #F8C545; white-space: nowrap; flex-shrink: 0; z-index: 2; position: relative; }
    
    /* Panel content: z-index para estar encima de la marca de agua */
    .panel-content { flex: 1; padding: 15px; overflow-y: auto; position: relative; z-index: 1; }
    .btn-icon-header { background: none; border: none; color: #888; font-size: 1rem; cursor: pointer; }

    /* --- 4. MARCA DE AGUA (NUEVO) --- */
    .wod-watermark {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        width: 70%; height: 70%;
        background-repeat: no-repeat; background-position: center; background-size: contain;
        opacity: 0.1; /* Transparencia */
        pointer-events: none; z-index: 0; 
    }

    /* --- 5. SELECTOR WOD --- */
    .header-select-wrapper { display: flex; align-items: center; background-color: #000; border: 1px solid #333; border-radius: 4px; padding: 0 10px; height: 32px; position: relative; min-width: 160px; }
    .select-icon { font-size: 0.8rem; color: #F8C545; margin-right: 8px; }
    .header-select { background: transparent; border: none; color: white; font-family: 'Oswald'; font-size: 0.95rem; font-weight: bold; appearance: none; -webkit-appearance: none; width: 100%; cursor: pointer; outline: none; }
    .header-select option { background-color: #1a1a1a; color: white; padding: 10px; }
    .select-arrow { font-size: 0.7rem; color: #666; margin-left: 5px; pointer-events: none; }

    /* --- 6. ESTILOS WOD --- */
    .wod-block { margin-bottom: 25px; break-inside: avoid; -webkit-column-break-inside: avoid; }
    .block-title { color: #F8C545; background: transparent; padding: 2px 10px; margin: 0 0 12px 0; font-size: 1.1rem; font-weight: bold; font-family: 'Oswald'; border-left: 4px solid #F8C545; border-bottom: 1px solid rgba(255, 255, 255, 0.1); text-transform: uppercase; letter-spacing: 1px; }
    .ejercicio-row-clean { display: grid; grid-template-columns: 110px 1fr; gap: 15px; align-items: baseline; padding: 4px 0; margin-bottom: 2px; border-bottom: 1px solid rgba(255, 255, 255, 0.05); -webkit-column-break-inside: avoid; page-break-inside: avoid; break-inside: avoid; }
    .ej-reps { color: #F8C545; font-weight: 900; font-family: 'Oswald'; font-size: 1.1rem; text-align: right; white-space: nowrap; }
    .ej-nombre { color: #e0e0e0; font-family: 'Roboto', sans-serif; font-size: 1rem; font-weight: 500; line-height: 1.3; text-align: left; }
    .scroll-custom::-webkit-scrollbar { width: 6px; } .scroll-custom::-webkit-scrollbar-track { background: #111; } .scroll-custom::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }

    /* WOD EXPANDIDO */
    .dashboard-container.wod-wide .list-panel { flex: 0 0 0 !important; width: 0 !important; padding: 0 !important; border: none !important; margin: 0 !important; }
    .dashboard-container.wod-wide .wod-panel { flex: 2; }
    .dashboard-container.wod-wide .exercises-wrapper { display: block; column-width: 380px; column-gap: 50px; column-rule: 1px solid rgba(255, 255, 255, 0.1); width: 100%; padding-top: 10px; }

    /* BARRA VERTICAL */
    .vertical-bar { height: 100%; width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #666; animation: fadeIn 0.5s; }
    .v-text { writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg); font-family: 'Oswald'; font-size: 1.2rem; letter-spacing: 3px; white-space: nowrap; margin-bottom: 10px; }
    .v-icon { font-size: 1.5rem; }

    /* TIMER */
    .flex-center-vertical { display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 0 10px; }
    .timer-type-selector { display: flex; background: #222; border-radius: 25px; padding: 4px; margin-bottom: 20px; width: 100%; border: 1px solid #444; }
    .type-btn { flex: 1; background: transparent; border: none; color: #888; padding: 8px; border-radius: 20px; font-family: 'Oswald'; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; }
    .type-btn.active { background: #F8C545; color: black; font-weight: bold; box-shadow: 0 2px 8px rgba(248, 197, 69, 0.3); }
    .config-box { background: #1a1a1a; padding: 20px; border-radius: 15px; border: 1px solid #444; width: 100%; max-width: 350px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); z-index: 10; }
    .inputs-grid { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
    .input-group label { display: block; color: #F8C545; font-size: 0.8rem; margin-bottom: 5px; text-align: center; font-weight: bold; font-family: 'Oswald'; letter-spacing: 1px; }
    .time-inputs { display: flex; justify-content: center; align-items: center; gap: 5px; background: #222; padding: 5px 15px; border-radius: 10px; border: 1px solid #333; }
    .time-inputs input { width: 80px; font-size: 1.8rem; background: transparent; border: none; color: white; text-align: center; font-family: 'Oswald'; }
    .time-inputs input:focus { outline: none; color: #F8C545; }
    .single-input { width: 100%; font-size: 1.5rem; background: #222; border: 1px solid #333; color: white; text-align: center; font-family: 'Oswald'; border-radius: 10px; }
    .btn-save-timer { width: 100%; background: #28a745; color: white; border: none; padding: 12px; font-weight: bold; font-family: 'Oswald'; border-radius: 8px; font-size: 1.1rem; cursor: pointer; }
    .timer-display { font-family: 'Oswald'; font-weight: bold; color: white; line-height: 1; font-size: clamp(3rem, 12vw, 8rem); text-shadow: 0 0 20px rgba(255,255,255,0.1); margin: 10px 0; }
    .timer-display.running { color: #28a745; text-shadow: 0 0 30px rgba(40, 167, 69, 0.4); }
    .timer-display.resting { color: #dc3545; text-shadow: 0 0 30px rgba(220, 53, 69, 0.4); }
    .status-badge { font-family: 'Oswald'; font-size: 1.2rem; padding: 5px 15px; border-radius: 5px; letter-spacing: 2px; text-align: center; }
    .status-badge.work { color: #28a745; border: 1px solid #28a745; background: rgba(40,167,69,0.1); }
    .status-badge.rest { color: #dc3545; border: 1px solid #dc3545; background: rgba(220,53,69,0.1); }
    .timer-controls { display: flex; gap: 20px; margin-top: auto; padding-bottom: 10px; }
    .btn-control { width: 60px; height: 60px; border-radius: 50%; border: none; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.1s; }
    .start { background: #28a745; color: white; } .stop { background: #dc3545; color: white; } .reset { background: #333; color: white; }
    .btn-control:active { transform: scale(0.95); }
    .prep-display { text-align: center; } .prep-label { font-family: 'Oswald'; font-size: 2rem; color: #888; } .prep-number { font-size: 8rem; color: #F8C545; font-family: 'Oswald'; font-weight: bold; line-height: 1; }

    /* ATLETAS */
    .atletas-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(85px, 1fr)); gap: 10px; }
    .atleta-card { background: #222; border: 1px solid #444; border-radius: 8px; padding: 10px 5px; text-align: center; transition: 0.2s; }
    .avatar { width: 45px; height: 45px; background: #333; color: #F8C545; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; margin: 0 auto 5px auto; border: 2px solid #F8C545; position: relative; }
    .name { font-size: 0.75rem; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .btn-terminate { width: 100%; padding: 15px; background: #dc3545; color: white; font-weight: bold; font-family: 'Oswald'; border: none; cursor: pointer; margin-top: auto; border-radius: 0; }
    .empty-state { text-align: center; color: #444; margin-top: 50px; } .empty-state i { font-size: 3rem; margin-bottom: 10px; }

    /* MODAL */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
    .custom-modal { background: #111; width: 90%; max-width: 500px; border-radius: 10px; border: 1px solid #333; display: flex; flex-direction: column; overflow: hidden; height: 80vh; }
    .modal-header { height: auto; padding: 15px; border-bottom: 1px solid #333; }
    .modal-body { padding: 15px; overflow-y: auto; flex: 1; }
    .search-input { padding-left: 10px; background: #222; color: white; border: 1px solid #444; height: 40px; border-radius: 20px; width: 100%; text-indent: 10px;}
    .atleta-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #222; cursor: pointer; }
    .avatar-mini { width: 35px; height: 35px; background: #444; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 10px; background-size: cover; }
    .atleta-nombre { color: #F8C545; font-weight: bold; font-family: 'Oswald'; font-size: 1rem; line-height: 1; }
    .lista-atletas-scroll { max-height: 50vh; overflow-y: auto; margin-top: 10px; }
    .atleta-info { display: flex; align-items: center; flex: 1; gap: 10px; }

    /* ANIMACIONES & HELPERS */
    .fade-in { animation: fadeIn 0.3s ease-in; } .slide-in { animation: slideIn 0.3s ease-out; }
    @@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @@keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .pulse-animation { animation: pulseBig 1s infinite; }
    @@keyframes pulseBig { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    .last-round-alert { color: #dc3545 !important; animation: pulseRed 1s infinite; }
    @@keyframes pulseRed { 0% { transform: scale(1); } 50% { transform: scale(1.05); text-shadow: 0 0 10px red; } 100% { transform: scale(1); } }
    .peso-highlight { color: #F8C545; font-weight: 900; font-family: 'Oswald', sans-serif; font-size: 0.95em; margin-left: 5px; }
    .peso-silver { color: #C0C0C0; font-weight: 800; font-family: 'Oswald', sans-serif; font-size: 0.95em; letter-spacing: 0.5px; margin-left: 6px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
</style>

@code {
    // --- VARIABLES DE ESTADO ---
    private bool wodExpandido = false;
    private bool verTimer = true;
    private bool verWod = true;
    private bool verLista = true;
    private bool modoConfiguracion = false;

    private ProgramacionWodViewModel wodHoy;
    private string mensajeWod = "Cargando WOD...";
    private Guid segmentoSeleccionadoID;

    // --- VARIABLES PARA EL LOGO ---
    private Guid? logoGuidReal; 
    
    // Propiedad calculada segura: Si no hay logo real, devuelve vacío
    private string UrlLogoBox
    {
        get
        {
            if (logoGuidReal == null) return "";
            return $"https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/Imagenes/Logos/{logoGuidReal}.jpg";
        }
    }

    private bool mostrarModalAtletas = false;
    private List<UsuarioListDto> listaTodosAtletas;
    private List<UsuarioListDto> listaAtletasFiltrada;
    private string filtroAtleta = "";

    // Timer Variables...
    private int tipoTimer = 1;
    private int inputMinutos = 10; private int inputSegundos = 0;
    private int inputRondas = 1; private int inputMinDescanso = 0; private int inputSegDescanso = 0;
    private System.Timers.Timer _timer;
    private bool timerCorriendo = false;
    private int tiempoRestanteActual = 0;
    private int rondaActual = 1;
    private int totalRondas = 1;
    private bool enDescanso = false;
    private bool enConteoPrevio = false;
    private int tiempoPrevio = 7;
    private int tiempoTotalSegmentoActual = 0;
    private int tiempoTrabajoConfig = 0;
    private int tiempoDescansoConfig = 0;

    protected override async Task OnInitializedAsync()
    {
        // 1. Configurar Timer
        _timer = new System.Timers.Timer(1000);
        _timer.Elapsed += (sender, e) => Tick();
        _timer.AutoReset = true;
        GuardarConfiguracion();

        // 2. Cargas Asíncronas
        if (Sesion.Usuario != null)
        {
            // Ejecutamos las dos cargas en paralelo para que sea rápido
            await Task.WhenAll(
                CargarWodHoy(),
                CargarInfoBox() // <--- Llamada para obtener el logo
            );
        }
    }

    // --- NUEVO: Cargar Info del Box (Logo correcto) ---
    private async Task CargarInfoBox()
    {
        try
        {
            var response = await Http.GetAsync($"https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/configapi/nombre-box/{Sesion.Usuario.BoxID}");
            
            if (response.IsSuccessStatusCode)
            {
                var info = await response.Content.ReadFromJsonAsync<BoxInfoSimple>();
                if (info != null)
                {
                    logoGuidReal = info.Logo;
                    StateHasChanged(); 
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("No se pudo cargar el logo: " + ex.Message);
        }
    }

    // Clase simple para deserializar la respuesta del box
    public class BoxInfoSimple
    {
        public string Nombre { get; set; }
        public Guid? Logo { get; set; }
    }

    // --- MÉTODOS EXISTENTES (INTACTOS) ---

    private string FormatearNombreConPeso(string descripcion)
    {
        if (string.IsNullOrEmpty(descripcion)) return "";
        int indiceParentesis = descripcion.IndexOf('(');
        if (indiceParentesis > 0)
        {
            string nombre = descripcion.Substring(0, indiceParentesis);
            string peso = descripcion.Substring(indiceParentesis);
            return $"{nombre} <span class='peso-highlight'>{peso}</span>";
        }
        return descripcion;
    }

    private async Task CargarWodHoy()
    {
        try
        {
            var fecha = DateTime.Now.ToString("yyyy-MM-dd");
            var response = await Http.GetAsync($"https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/wodapi/obtener/{Sesion.Usuario.BoxID}/{fecha}");

            if (response.IsSuccessStatusCode)
            {
                wodHoy = await response.Content.ReadFromJsonAsync<ProgramacionWodViewModel>();
                segmentoSeleccionadoID = Guid.Empty;
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                wodHoy = null;
                mensajeWod = "¡Día de Descanso!";
            }
        }
        catch { mensajeWod = "Sin conexión."; }
    }

    private void CambiarBloqueVisible(ChangeEventArgs e)
    {
        if (Guid.TryParse(e.Value.ToString(), out Guid id)) segmentoSeleccionadoID = id;
    }

    private async Task AbrirModalAtletas()
    {
        mostrarModalAtletas = true;
        filtroAtleta = "";
        if (listaTodosAtletas == null)
        {
            try
            {
                listaTodosAtletas = await Http.GetFromJsonAsync<List<UsuarioListDto>>($"https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/usuariosapi/buscador/{Sesion.Usuario.BoxID}");
            }
            catch { listaTodosAtletas = new List<UsuarioListDto>(); }
        }
        listaAtletasFiltrada = listaTodosAtletas;
    }

    private string FormatearPesoPlateado(string descripcionBase)
    {
        if (string.IsNullOrEmpty(descripcionBase)) return "";
        int indiceInicio = descripcionBase.IndexOf('(');
        if (indiceInicio > 0)
        {
            string nombreEjercicio = descripcionBase.Substring(0, indiceInicio);
            string partePeso = descripcionBase.Substring(indiceInicio);
            return $"{nombreEjercicio} <span class='peso-silver'>{partePeso}</span>";
        }
        return descripcionBase;
    }

    private void FiltrarAtletas(ChangeEventArgs e)
    {
        filtroAtleta = e.Value?.ToString() ?? "";
        if (listaTodosAtletas == null) return;

        if (string.IsNullOrWhiteSpace(filtroAtleta))
        {
            listaAtletasFiltrada = listaTodosAtletas;
        }
        else
        {
            listaAtletasFiltrada = listaTodosAtletas
                .Where(x => x.NombreCompleto != null &&
                            x.NombreCompleto.Contains(filtroAtleta, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }
    }

    private void ToggleExpandirWod()
    {
        wodExpandido = !wodExpandido;
        if (wodExpandido)
        {
            verWod = true;
        }
    }

    private void AgregarAtletaDesdeLista(UsuarioListDto usuario)
    {
        if (!LiveState.AtletasEnClase.Any(x => x.UsuarioId == usuario.UsuarioId))
        {
            LiveState.AtletasEnClase.Add(new CheckInDto
            {
                UsuarioId = usuario.UsuarioId,
                BoxId = Sesion.Usuario.BoxID,
                NombreCompleto = usuario.NombreCompleto,
                FotoUrl = usuario.FotoUrl
            });
        }
        mostrarModalAtletas = false;
    }

    // --- LOGICA TIMER ---
    private async Task Sonar(string idAudio) { try { await JS.InvokeVoidAsync("reproducirSonido", idAudio); } catch { } }
    private void IniciarSecuencia() { enConteoPrevio = true; tiempoPrevio = 7; _timer.Start(); timerCorriendo = true; }
    private void PausarTimer() { _timer.Stop(); timerCorriendo = false; }
    private void ResetTimer() { _timer.Stop(); timerCorriendo = false; enConteoPrevio = false; rondaActual = 1; enDescanso = false; tiempoRestanteActual = tiempoTrabajoConfig; tiempoTotalSegmentoActual = tiempoTrabajoConfig; }
    private void GuardarConfiguracion() { tiempoTrabajoConfig = (inputMinutos * 60) + inputSegundos; tiempoDescansoConfig = (inputMinDescanso * 60) + inputSegDescanso; totalRondas = (tipoTimer == 1) ? 1 : inputRondas; ResetTimer(); modoConfiguracion = false; }
    private void Tick()
    {
        if (enConteoPrevio) { if (tiempoPrevio > 0) { tiempoPrevio--; if (tiempoPrevio <= 3) Sonar("audio-beep"); } else { enConteoPrevio = false; tiempoRestanteActual = tiempoTrabajoConfig; tiempoTotalSegmentoActual = tiempoTrabajoConfig; Sonar("audio-go"); } }
        else if (tiempoRestanteActual > 0) { tiempoRestanteActual--; if (!enDescanso && tiempoRestanteActual == (tiempoTotalSegmentoActual / 2)) Sonar("audio-medio"); if (tiempoRestanteActual <= 5) Sonar("audio-beep"); }
        else GestionarCambioDeRonda();
        InvokeAsync(StateHasChanged);
    }
    private void GestionarCambioDeRonda() { if (!enDescanso) { if (tipoTimer == 2 && tiempoDescansoConfig > 0 && rondaActual < totalRondas) { enDescanso = true; tiempoRestanteActual = tiempoDescansoConfig; tiempoTotalSegmentoActual = tiempoDescansoConfig; Sonar("audio-go"); } else SiguienteRondaOFin(); } else { enDescanso = false; SiguienteRondaOFin(); } }
    private void SiguienteRondaOFin() { if (rondaActual < totalRondas) { rondaActual++; tiempoRestanteActual = tiempoTrabajoConfig; tiempoTotalSegmentoActual = tiempoTrabajoConfig; enDescanso = false; Sonar("audio-go"); } else TerminarTodo(); }
    private void TerminarTodo() { _timer.Stop(); timerCorriendo = false; Sonar("audio-go"); }
    private string FormatoTiempo(int t) => $"{t / 60:00}:{t % 60:00}";
    private void CambiarTipoTimer(int t) { tipoTimer = t; if (t == 2) { inputMinutos = 0; inputSegundos = 20; inputRondas = 8; inputMinDescanso = 0; inputSegDescanso = 10; } else { inputMinutos = 10; inputSegundos = 0; inputRondas = 1; } }
    private void TerminarClase() { Nav.NavigateTo("/resumen-clase"); }
    public async ValueTask DisposeAsync() { if (_timer != null) { _timer.Stop(); _timer.Dispose(); } }
}