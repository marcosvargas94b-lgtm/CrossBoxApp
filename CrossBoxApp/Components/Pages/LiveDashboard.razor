@page "/live-dashboard"
@using CrossBoxApp.Models
@using CrossBoxApp.Models.Services
@using Microsoft.AspNetCore.SignalR.Client
@using static CrossBoxApp.Components.Pages.LiveLobby 
@inject LiveSessionState LiveState
@inject NavigationManager Nav
@inject HttpClient Http
@inject SesionService Sesion
@inject IJSRuntime JS 
@implements IAsyncDisposable

<div class="dashboard-container">
    
    <audio id="audio-beep" src="sonidos/beep.mp3" preload="auto"></audio>
    <audio id="audio-go" src="sonidos/go.mp3" preload="auto"></audio>
    <audio id="audio-medio" src="sonidos/medio.mp3" preload="auto"></audio>

    <div class="panel timer-panel @(verTimer ? "" : "collapsed")">
        @if (verTimer)
        {
            <div class="panel-header">
                <div class="header-left">
                    <span><i class="fas fa-stopwatch"></i> TIMER</span>
                    @if (!timerCorriendo)
                    {
                        <button class="btn-icon-header ml-2" @onclick="() => modoConfiguracion = !modoConfiguracion"><i class="fas fa-cog"></i></button>
                    }
                </div>
                <button class="btn-icon-header" @onclick="() => verTimer = false"><i class="fas fa-compress-arrows-alt"></i></button>
            </div>
            <div class="panel-content center-content">
                @if (modoConfiguracion && !timerCorriendo)
                {
                    <div class="config-box slide-in">
                        <div class="config-tabs">
                            <button class="@(tipoTimer == 1 ? "active" : "")" @onclick="() => CambiarTipoTimer(1)">CUENTA ATRÁS</button>
                            <button class="@(tipoTimer == 2 ? "active" : "")" @onclick="() => CambiarTipoTimer(2)">INTERVALOS</button>
                        </div>
                        <div class="inputs-grid">
                            <div class="input-group">
                                <label>TIEMPO</label>
                                <div class="time-inputs"><input type="number" @bind="inputMinutos" /><span>:</span><input type="number" @bind="inputSegundos" /></div>
                            </div>
                            @if (tipoTimer == 2)
                            {
                                <div class="input-group"><label>RONDAS</label><input type="number" @bind="inputRondas" class="single-input" /></div>
                                <div class="input-group"><label>DESCANSO</label><div class="time-inputs"><input type="number" @bind="inputMinDescanso" /><span>:</span><input type="number" @bind="inputSegDescanso" /></div></div>
                            }
                        </div>
                        <button class="btn-save-timer" @onclick="GuardarConfiguracion">LISTO</button>
                    </div>
                }
                else
                {
                    @if (enConteoPrevio)
                    {
                        <div class="prep-display pulse-animation">
                            <div class="prep-label">PREPARADOS</div>
                            <div class="prep-number">@tiempoPrevio</div>
                        </div>
                    }
                    else
                    {
                        <div class="status-badge @(enDescanso ? "rest" : "work")">@(enDescanso ? "DESCANSO" : "WORK")</div>
                        <div class="timer-display @(timerCorriendo ? (enDescanso ? "resting" : "running") : "")">@FormatoTiempo(tiempoRestanteActual)</div>
                        @if (totalRondas > 1)
                        {
                            <div class="round-counter @(rondaActual == totalRondas ? "last-round-alert" : "")">RONDA <span class="big-round">@rondaActual</span> / @totalRondas</div>
                        }
                    }
                    <div class="timer-controls">
                        @if (!timerCorriendo) { <button class="btn-control start" @onclick="IniciarSecuencia"><i class="fas fa-play"></i></button> }
                        else { <button class="btn-control stop" @onclick="PausarTimer"><i class="fas fa-pause"></i></button> }
                        <button class="btn-control reset" @onclick="ResetTimer"><i class="fas fa-undo"></i></button>
                    </div>
                }
            </div>
        }
        else { <div class="vertical-bar" @onclick="() => verTimer = true"><span class="v-text">TIMER</span><i class="fas fa-stopwatch v-icon"></i></div> }
    </div>

    <div class="panel wod-panel @(verWod ? "" : "collapsed")">
        @if (verWod)
        {
            <div class="panel-header"><span>WOD HOY</span><button class="btn-icon-header" @onclick="() => verWod = false"><i class="fas fa-compress-arrows-alt"></i></button></div>
            <div class="panel-content">
                @if (wodHoy != null && wodHoy.Bloques != null && wodHoy.Bloques.Count > 0)
                {
                    <div class="segment-selector mb-3">
                        <select class="form-control input-dark select-wod" @onchange="CambiarBloqueVisible">
                            <option value="@Guid.Empty" selected="@(segmentoSeleccionadoID == Guid.Empty)">
                                📜 WOD COMPLETO
                            </option>

                            @foreach (var b in wodHoy.Bloques)
                            {
                                <option value="@b.SegmentoClaseID" selected="@(b.SegmentoClaseID == segmentoSeleccionadoID)">
                                    @(string.IsNullOrEmpty(b.NombreSegmento) ? "BLOQUE" : b.NombreSegmento.ToUpper())
                                </option>
                            }
                        </select>
                    </div>

                    @foreach (var bloque in wodHoy.Bloques)
                    {
                        // LÓGICA MAESTRA: Si es Guid.Empty (Ver Todo) O si coincide el ID -> MUESTRA
                        @if (segmentoSeleccionadoID == Guid.Empty || bloque.SegmentoClaseID == segmentoSeleccionadoID)
                        {
                            <div class="wod-block fade-in">
                                <h4 style="color:#F8C545; border-bottom:1px solid #333; padding-bottom:10px; margin-bottom:15px; margin-top:20px;">
                                    @(string.IsNullOrEmpty(bloque.NombreSegmento) ? "BLOQUE" : bloque.NombreSegmento.ToUpper())
                                </h4>
                                @if (bloque.Ejercicios != null)
                                {
                                    @foreach (var ej in bloque.Ejercicios)
                                    {
                                        <div class="ejercicio-row">
                                            <div class="ej-desc">@ej.Descripcion</div>
                                            @if (!string.IsNullOrEmpty(ej.PesoRepeticiones))
                                            {
                                                <div class="ej-peso">@ej.PesoRepeticiones</div>
                                            }
                                        </div>
                                    }
                                }
                            </div>
                        }
                    }
                }
                else
                {
                    <div class="empty-state"><i class="fas fa-dumbbell"></i><p>@mensajeWod</p></div>
                }
            </div>
        }
        else
        {

            <div class="vertical-bar" @onclick="() => verWod = true"><span class="v-text">WORKOUT</span></div>
        }
    </div>

    <div class="panel list-panel @(verLista ? "" : "collapsed")">
        @if (verLista) {
            <div class="panel-header">
                <span>CLASE</span>
                <div style="display:flex; gap:10px;">
                    <button class="btn-icon-header text-warning" @onclick="AbrirModalAtletas"><i class="fas fa-user-plus"></i></button>
                    <button class="btn-icon-header" @onclick="()=>verLista=false"><i class="fas fa-compress-arrows-alt"></i></button>
                </div>
            </div>
            <div class="panel-content"> 
                @if (LiveState.AtletasEnClase != null && LiveState.AtletasEnClase.Count > 0)
                {
                    <div class="atletas-grid">
                        @foreach (var atleta in LiveState.AtletasEnClase)
                        {
                            <div class="atleta-card slide-in">
                                <div class="avatar" style="@(!string.IsNullOrEmpty(atleta.FotoUrl) ? $"background-image: url('{atleta.FotoUrl}'); background-size:cover; border:none;" : "")">
                                    @if (string.IsNullOrEmpty(atleta.FotoUrl))
                                    {
                                        @atleta.NombreCompleto.Substring(0,1).ToUpper()
                                    }
                                </div>
                                <div class="name">@atleta.NombreCompleto</div>
                            </div>
                        }
                    </div>
                }
                else { <div class="empty-state"><i class="fas fa-users"></i><p>Esperando atletas...</p></div> }
            </div>
            <button class="btn-terminate" @onclick="TerminarClase">TERMINAR CLASE</button>
        } else { <div class="vertical-bar" @onclick="()=>verLista=true"><span class="v-text">ATLETAS</span></div> }
    </div>
</div>

@if (mostrarModalAtletas)
{
    <div class="modal-overlay">
        <div class="modal-content custom-modal">
            <div class="modal-header">
                <h5 style="margin:0; color:#F8C545; font-weight:bold;">SELECCIONAR ATLETA</h5>
                <button class="btn-icon-header" @onclick="() => mostrarModalAtletas = false"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="search-box mb-3">
                    <i class="fas fa-search search-icon"></i>

                    <input type="text"
                           class="form-control input-dark search-input"
                           placeholder="Buscar por nombre..."
                           value="@filtroAtleta"
                           @oninput="FiltrarAtletas"
                           autofocus />
                </div>
                <div class="lista-atletas-scroll">
                    @if (listaTodosAtletas == null) { <div class="text-center py-3"><div class="spinner-border text-warning"></div></div> }
                    else if (listaAtletasFiltrada == null || listaAtletasFiltrada.Count == 0) { <p class="text-center text-muted mt-3">No hay resultados.</p> }
                    else
                    {
                        @foreach (var atleta in listaAtletasFiltrada)
                        {
                            @if (!LiveState.AtletasEnClase.Any(x => x.UsuarioId == atleta.UsuarioId))
                            {
                                <div class="atleta-row" @onclick="() => AgregarAtletaDesdeLista(atleta)">
                                    <div class="atleta-info">
                                        <div class="avatar-mini" style="@(!string.IsNullOrEmpty(atleta.FotoUrl) ? $"background-image: url('{atleta.FotoUrl}');" : "")">
                                            @if(string.IsNullOrEmpty(atleta.FotoUrl)) { @atleta.NombreCompleto.Substring(0,1).ToUpper() }
                                        </div>
                                        <div style="display:flex; flex-direction:column;">
                                            <span class="atleta-nombre">@atleta.NombreCompleto</span>
                                           @*  @if(atleta.Pagado) { <span class="badge bg-success" style="width:fit-content; font-size:0.6rem;">ACTIVO</span> }
                                            else { <span class="badge bg-danger" style="width:fit-content; font-size:0.6rem;">VENCIDO</span> } *@
                                        </div>
                                    </div>
                                    <i class="fas fa-plus-circle add-icon"></i>
                                </div>
                            }
                        }
                    }
                </div>
            </div>
        </div>
    </div>
}

<style>
    /* Estilos Actualizados */
    .avatar { width: 60px; height: 60px; background: #333; color: #F8C545; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.5rem; margin: 0 auto 10px auto; border: 2px solid #F8C545; position: relative; }
    
    .avatar-mini { width: 40px; height: 40px; background: #444; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1rem; margin-right: 15px; background-size: cover; background-position: center; flex-shrink: 0; }
    
    .atleta-info { display: flex; align-items: center; }
    .select-wod { font-family: 'Oswald'; font-size: 1.2rem; padding: 10px; border: 1px solid #F8C545; color: #F8C545; font-weight: bold; cursor: pointer; background: #1a1a1a; margin-bottom: 20px; }
    .select-wod option { background: #222; color: white; padding: 10px; }
    
    /* Resto de estilos (copiar los anteriores del Dashboard) */
    .dashboard-container { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: #0d0d0d; color: white; display: flex; overflow: hidden; font-family: 'Roboto', sans-serif; }
    .panel { flex: 1; border-right: 1px solid #333; display: flex; flex-direction: column; transition: all 0.3s ease; background: #111; overflow: hidden; }
    .panel.collapsed { flex: 0 0 60px; background: #000; cursor: pointer; }
    .panel.collapsed:hover { background: #1a1a1a; }
    .panel-header { height: 60px; background: #1a1a1a; border-bottom: 2px solid #F8C545; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; font-family: 'Oswald'; font-size: 1.3rem; color: #F8C545; white-space: nowrap; }
    .btn-icon-header { background: none; border: none; color: #888; font-size: 1.1rem; cursor: pointer; transition: 0.2s; }
    .btn-icon-header:hover { color: white; }
    .text-warning { color: #F8C545 !important; }
    .panel-content { flex: 1; padding: 20px; overflow-y: auto; position: relative; }
    .center-content { display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .vertical-bar { height: 100%; width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #666; }
    .v-text { writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg); font-family: 'Oswald'; font-size: 1.5rem; letter-spacing: 3px; white-space: nowrap; }
    .ejercicio-row { background: #222; border-left: 3px solid #F8C545; padding: 12px; margin-bottom: 10px; border-radius: 4px; }
    .ej-desc { font-weight: bold; font-size: 1.1rem; margin-bottom: 3px; }
    .ej-peso { color: #aaa; font-size: 0.9rem; font-style: italic; }
    .atletas-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 15px; }
    .atleta-card { background: #222; border: 1px solid #444; border-radius: 10px; padding: 15px 10px; text-align: center; transition: 0.2s; }
    .atleta-card:hover { border-color: #F8C545; transform: translateY(-2px); }
    .name { font-size: 0.85rem; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .empty-state { text-align: center; color: #444; margin-top: 50px; }
    .empty-state i { font-size: 4rem; margin-bottom: 15px; }
    .timer-display { font-size: 8rem; font-family: 'Oswald'; font-weight: bold; color: white; line-height: 1; text-shadow: 0 0 20px rgba(255,255,255,0.1); }
    .timer-display.running { color: #28a745; text-shadow: 0 0 30px rgba(40, 167, 69, 0.4); }
    .timer-display.resting { color: #dc3545; text-shadow: 0 0 30px rgba(220, 53, 69, 0.4); }
    .status-badge { font-family: 'Oswald'; font-size: 1.5rem; padding: 5px 20px; border-radius: 5px; margin-bottom: 10px; letter-spacing: 2px; }
    .status-badge.work { color: #28a745; border: 1px solid #28a745; background: rgba(40,167,69,0.1); }
    .status-badge.rest { color: #dc3545; border: 1px solid #dc3545; background: rgba(220,53,69,0.1); }
    .timer-controls { display: flex; gap: 20px; margin-bottom: 40px; margin-top: 20px; }
    .btn-control { width: 70px; height: 70px; border-radius: 50%; border: none; font-size: 1.8rem; display: flex; align-items: center; justify-content: center; cursor: pointer; }
    .start { background: #28a745; color: white; } .stop { background: #dc3545; color: white; } .reset { background: #333; color: white; }
    .btn-control:active { transform: scale(0.9); }
    .config-box { background: #1a1a1a; padding: 25px; border-radius: 15px; border: 2px solid #F8C545; width: 100%; max-width: 400px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); }
    .config-tabs { display: flex; margin-bottom: 25px; background: #0d0d0d; border-radius: 10px; padding: 5px; }
    .config-tabs button { flex: 1; background: none; border: none; color: #666; padding: 10px; font-weight: bold; cursor: pointer; border-radius: 8px; font-family: 'Oswald'; }
    .config-tabs button.active { background: #F8C545; color: black; }
    .input-group label { display: block; color: #F8C545; font-size: 0.9rem; margin-bottom: 8px; text-align: center; font-weight: bold; font-family: 'Oswald'; }
    .time-inputs { display: flex; align-items: center; justify-content: center; gap: 10px; background: #0d0d0d; padding: 10px; border-radius: 12px; border: 1px solid #333; }
    .time-inputs input { width: 80px; background: transparent; border: none; color: white; font-size: 2.5rem; font-family: 'Oswald'; text-align: center; border-bottom: 2px solid #333; }
    .time-inputs input:focus { border-bottom-color: #F8C545; outline: none; }
    .btn-save-timer { width: 100%; background: linear-gradient(45deg, #F8C545, #ffb300); color: black; border: none; padding: 15px; font-weight: bold; border-radius: 8px; font-family: 'Oswald'; font-size: 1.2rem; cursor: pointer; margin-top: 20px; }
    .btn-terminate { width: 100%; padding: 20px; background: #dc3545; color: white; font-weight: bold; font-family: 'Oswald'; border: none; cursor: pointer; margin-top: 10px; }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
    .custom-modal { background: #111; width: 90%; max-width: 500px; border-radius: 10px; border: 1px solid #333; display: flex; flex-direction: column; overflow: hidden; height: 70vh; box-shadow: 0 0 30px rgba(248, 197, 69, 0.2); }
    .search-box { position: relative; }
    .search-icon { position: absolute; left: 15px; top: 12px; color: #888; }
    .search-input { padding-left: 40px; background: #222; color: white; border: 1px solid #444; height: 45px; border-radius: 25px; }
    .search-input:focus { background: #333; border-color: #F8C545; color: white; box-shadow: none; }
    .lista-atletas-scroll { overflow-y: auto; flex: 1; padding: 0 5px; }
    .atleta-row { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #222; cursor: pointer; transition: 0.2s; }
    .atleta-row:hover { background: #222; padding-left: 20px; }
    .atleta-nombre { color: white; font-weight: bold; font-size: 1rem; }
    .add-icon { color: #28a745; font-size: 1.4rem; }
    .fade-in { animation: fadeIn 0.3s ease-in; }
    .slide-in { animation: slideIn 0.3s ease-out; }
    .prep-display { text-align: center; margin-bottom: 20px; }
    .prep-label { color: #aaa; font-size: 1.5rem; letter-spacing: 5px; font-family: 'Oswald'; margin-bottom: 10px; }
    .prep-number { font-size: 10rem; color: #F8C545; font-family: 'Oswald'; font-weight: bold; line-height: 1; text-shadow: 0 0 30px rgba(248, 197, 69, 0.5); }
    .pulse-animation { animation: pulseBig 1s infinite; }
    .last-round-alert { color: #dc3545 !important; animation: pulseRed 1s infinite; }
    .warning-icon { font-weight: bold; margin-right: 10px; }
    @@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @@keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @@keyframes pulseBig { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    @@keyframes pulseRed { 0% { transform: scale(1); } 50% { transform: scale(1.05); text-shadow: 0 0 10px red; } 100% { transform: scale(1); } }
</style>

@code {
    private bool verTimer = true;
    private bool verWod = true;
    private bool verLista = true;
    private bool modoConfiguracion = false;

    private ProgramacionWodViewModel wodHoy;
    private string mensajeWod = "Cargando WOD...";
    private Guid segmentoSeleccionadoID;

    private bool mostrarModalAtletas = false;
    private List<UsuarioListDto> listaTodosAtletas; 
    private List<UsuarioListDto> listaAtletasFiltrada;
    private string filtroAtleta = "";

    private int tipoTimer = 1; 
    private int inputMinutos = 10; private int inputSegundos = 0;
    private int inputRondas = 1; private int inputMinDescanso = 0; private int inputSegDescanso = 0;
    private System.Timers.Timer _timer;
    private bool timerCorriendo = false;
    private int tiempoRestanteActual = 0;
    private int rondaActual = 1;
    private int totalRondas = 1;
    private bool enDescanso = false;
    private bool enConteoPrevio = false;
    private int tiempoPrevio = 7;
    private int tiempoTotalSegmentoActual = 0; 
    private int tiempoTrabajoConfig = 0;
    private int tiempoDescansoConfig = 0;

    protected override async Task OnInitializedAsync()
    {
        _timer = new System.Timers.Timer(1000);
        _timer.Elapsed += (sender, e) => Tick();
        _timer.AutoReset = true;
        
        GuardarConfiguracion(); 
        await CargarWodHoy();
    }

    private async Task CargarWodHoy()
    {
        try
        {
            var fecha = DateTime.Now.ToString("yyyy-MM-dd");
            var response = await Http.GetAsync($"https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/wodapi/obtener/{Sesion.Usuario.BoxID}/{fecha}");

            if (response.IsSuccessStatusCode)
            {
                wodHoy = await response.Content.ReadFromJsonAsync<ProgramacionWodViewModel>();

                // CAMBIO IMPORTANTE:
                // Ya no forzamos el 'First()'. Dejamos Guid.Empty para que muestre todo por defecto.
                segmentoSeleccionadoID = Guid.Empty;
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                wodHoy = null;
                mensajeWod = "¡Día de Descanso!";
            }
        }
        catch { mensajeWod = "Sin conexión."; }
    }

    private void CambiarBloqueVisible(ChangeEventArgs e)
    {
        if (Guid.TryParse(e.Value.ToString(), out Guid id)) segmentoSeleccionadoID = id;
    }

    private async Task AbrirModalAtletas()
    {
        mostrarModalAtletas = true;
        filtroAtleta = ""; 
        if (listaTodosAtletas == null)
        {
            try {
                // Usamos el endpoint del buscador nuevo (paso 1)
                listaTodosAtletas = await Http.GetFromJsonAsync<List<UsuarioListDto>>($"https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/usuariosapi/buscador/{Sesion.Usuario.BoxID}");
            } catch { listaTodosAtletas = new List<UsuarioListDto>(); }
        }
        listaAtletasFiltrada = listaTodosAtletas;
    }
    private void FiltrarAtletas(ChangeEventArgs e)
    {
        // 1. Capturamos lo que el usuario escribió
        filtroAtleta = e.Value?.ToString() ?? "";

        // 2. Si la lista maestra está vacía, no hacemos nada
        if (listaTodosAtletas == null) return;

        // 3. Aplicamos el filtro
        if (string.IsNullOrWhiteSpace(filtroAtleta))
        {
            listaAtletasFiltrada = listaTodosAtletas;
        }
        else
        {
            listaAtletasFiltrada = listaTodosAtletas
                .Where(x => x.NombreCompleto != null &&
                            x.NombreCompleto.Contains(filtroAtleta, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }
    }

    private void AgregarAtletaDesdeLista(UsuarioListDto usuario)
    {
        if (!LiveState.AtletasEnClase.Any(x => x.UsuarioId == usuario.UsuarioId))
        {
            LiveState.AtletasEnClase.Add(new CheckInDto
            {
                UsuarioId = usuario.UsuarioId,
                BoxId = Sesion.Usuario.BoxID,
                NombreCompleto = usuario.NombreCompleto,
                FotoUrl = usuario.FotoUrl // Ahora pasamos la foto
            });
        }
        mostrarModalAtletas = false;
    }

    // --- LOGICA TIMER (Minimizada) ---
    private async Task Sonar(string idAudio) { try { await JS.InvokeVoidAsync("reproducirSonido", idAudio); } catch { } }
    private void IniciarSecuencia() { enConteoPrevio = true; tiempoPrevio = 7; _timer.Start(); timerCorriendo = true; }
    private void PausarTimer() { _timer.Stop(); timerCorriendo = false; }
    private void ResetTimer() { _timer.Stop(); timerCorriendo = false; enConteoPrevio = false; rondaActual = 1; enDescanso = false; tiempoRestanteActual = tiempoTrabajoConfig; tiempoTotalSegmentoActual = tiempoTrabajoConfig; }
    private void GuardarConfiguracion() { tiempoTrabajoConfig = (inputMinutos * 60) + inputSegundos; tiempoDescansoConfig = (inputMinDescanso * 60) + inputSegDescanso; totalRondas = (tipoTimer == 1) ? 1 : inputRondas; ResetTimer(); modoConfiguracion = false; }
    private void Tick()
    {
        if (enConteoPrevio) { if (tiempoPrevio > 0) { tiempoPrevio--; if (tiempoPrevio <= 3) Sonar("audio-beep"); } else { enConteoPrevio = false; tiempoRestanteActual = tiempoTrabajoConfig; tiempoTotalSegmentoActual = tiempoTrabajoConfig; Sonar("audio-go"); } }
        else if (tiempoRestanteActual > 0) { tiempoRestanteActual--; if (!enDescanso && tiempoRestanteActual == (tiempoTotalSegmentoActual / 2)) Sonar("audio-medio"); if (tiempoRestanteActual <= 5) Sonar("audio-beep"); }
        else GestionarCambioDeRonda();
        InvokeAsync(StateHasChanged);
    }
    private void GestionarCambioDeRonda() { if (!enDescanso) { if (tipoTimer == 2 && tiempoDescansoConfig > 0 && rondaActual < totalRondas) { enDescanso = true; tiempoRestanteActual = tiempoDescansoConfig; tiempoTotalSegmentoActual = tiempoDescansoConfig; Sonar("audio-go"); } else SiguienteRondaOFin(); } else { enDescanso = false; SiguienteRondaOFin(); } }
    private void SiguienteRondaOFin() { if (rondaActual < totalRondas) { rondaActual++; tiempoRestanteActual = tiempoTrabajoConfig; tiempoTotalSegmentoActual = tiempoTrabajoConfig; enDescanso = false; Sonar("audio-go"); } else TerminarTodo(); }
    private void TerminarTodo() { _timer.Stop(); timerCorriendo = false; Sonar("audio-go"); }
    private string FormatoTiempo(int t) => $"{t / 60:00}:{t % 60:00}";
    private void CambiarTipoTimer(int t) { tipoTimer = t; if (t == 2) { inputMinutos = 0; inputSegundos = 20; inputRondas = 8; inputMinDescanso = 0; inputSegDescanso = 10; } else { inputMinutos = 10; inputSegundos = 0; inputRondas = 1; } }
    private void TerminarClase() { Nav.NavigateTo("/resumen-clase"); }
    public async ValueTask DisposeAsync() { if (_timer != null) { _timer.Stop(); _timer.Dispose(); } }
}