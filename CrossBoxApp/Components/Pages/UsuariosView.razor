@page "/usuarios-view"
@using CrossBoxApp.Models
@using CrossBoxApp.Models.Services
@inject NavigationManager Nav
@inject HttpClient Http
@inject SesionService Sesion

<div class="top-navbar">
    <div class="nav-left" @onclick="Volver"><i class="fas fa-arrow-left"></i> VOLVER</div>
    <div class="nav-title">ATLETAS</div>
    <div class="nav-right"></div>
</div>

<div class="users-container">
    @if (cargando)
    {
        <div class="text-center mt-5"><div class="spinner-border text-warning"></div></div>
    }
    else if (listaUsuarios.Count == 0)
    {
        <div class="text-center mt-5 text-muted">No hay atletas registrados.</div>
    }
    else
    {
        <div class="user-list">
            @foreach (var usuario in listaUsuarios)
            {
                <div class="user-card">
                    <div class="user-info">
                        <div class="user-name">@usuario.NombreCompleto</div>
                        <div class="user-meta">
                            <span class="badge-status" style="background-color: @usuario.ColorEstatus">
                                @usuario.Estatus
                            </span>
                            @if (usuario.DiasRestantes >= 0 && usuario.DiasRestantes <= 30)
                            {
                                <span class="text-date"><i class="far fa-clock"></i> @usuario.DiasRestantes días</span>
                            }
                        </div>
                    </div>

                    <div class="action-side">
                        @if (usuario.DiasRestantes <= 5 && (Sesion.Usuario.TipoUsuarioID == 1 || Sesion.TienePermiso("MANAGE_PAYMENTS")))
                        {
                            <button class="btn-renovar" @onclick="() => AbrirModalRenovacion(usuario)">
                                <i class="fas fa-money-bill-wave"></i>
                            </button>
                        }

                        <div class="action-menu-wrapper">
                            <button class="btn-icon" @onclick="() => ToggleMenu(usuario)">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>

                            @if (usuario.MostrarMenu)
                            {
                                <div class="user-dropdown">
                                    
                                    @if (Sesion.Usuario.TipoUsuarioID == 1 || Sesion.TienePermiso("MANAGE_PAYMENTS"))
                                    {
                                        <div class="dropdown-item" @onclick="() => AbrirModalRenovacion(usuario)">
                                            <i class="fas fa-calendar-check"></i> Registrar Pago
                                        </div>
                                    }

                                    @if (Sesion.Usuario.TipoUsuarioID == 1 || Sesion.TienePermiso("MANAGE_EVALUATIONS"))
                                    {
                                        <div class="dropdown-item" @onclick="() => VerEvaluaciones(usuario)">
                                            <i class="fas fa-clipboard-check"></i> Evaluaciones
                                        </div>
                                    }

                                    @if (Sesion.Usuario.TipoUsuarioID == 1 || Sesion.TienePermiso("MANAGE_WOD"))
                                    {
                                        <div class="dropdown-item" @onclick="() => IrARunning(usuario)">
                                            <i class="fas fa-running"></i> Running Plan
                                        </div>
                                    }
                                    
                                    @if (Sesion.Usuario.TipoUsuarioID == 1 || Sesion.TienePermiso("MANAGE_USERS"))
                                    {
                                        <div class="dropdown-item" @onclick="() => RestablecerPass(usuario)">
                                            <i class="fas fa-key"></i> Restablecer Pass
                                        </div>
                                    }

                                    @if (Sesion.Usuario.TipoUsuarioID == 1 || Sesion.TienePermiso("DELETE_DATA"))
                                    {
                                        <div class="dropdown-item text-danger" @onclick="() => EliminarUsuario(usuario)">
                                            <i class="fas fa-trash"></i> Eliminar
                                        </div>
                                    }
                                </div>
                                <div class="menu-overlay" @onclick="() => ToggleMenu(usuario)"></div>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@if (mostrarModalPago) { <div class="modal fade show" style="display: block; background-color: rgba(0,0,0,0.9); z-index: 2000;" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content" style="background-color: #222; border: 1px solid #F8C545; color: white;"><div class="modal-header"><h5 class="modal-title" style="color:#F8C545;">REGISTRAR PAGO</h5><button type="button" class="btn-close btn-close-white" @onclick="() => mostrarModalPago = false"></button></div><div class="modal-body text-center"><p>Renovar suscripción para: <br><strong style="font-size:1.2rem">@usuarioSeleccionado?.NombreCompleto</strong></p><div class="info-vencimiento mb-3"><small class="text-muted">Vencimiento actual:</small><br><span style="color:#F8C545; font-weight:bold;">@(usuarioSeleccionado.FechaVencimiento == DateTime.MinValue ? "Nunca ha pagado" : usuarioSeleccionado.FechaVencimiento.ToString("dd/MM/yyyy"))</span></div><label class="mb-2">Nueva Fecha de Inicio:</label><input type="date" @bind="fechaPagoSeleccionada" class="form-control input-dark" style="font-size: 1.2rem; padding: 10px;" /><small class="text-muted">Se sumará 1 mes a partir de esta fecha.</small></div><div class="modal-footer"><button class="btn btn-secondary" @onclick="() => mostrarModalPago = false">Cancelar</button><button class="btn btn-warning" @onclick="ConfirmarRenovacion">Confirmar Pago</button></div></div></div></div> }

<style>
    /* ... (TUS ESTILOS ORIGINALES SE MANTIENEN IGUAL) ... */
    .top-navbar { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #1a1a1a; border-bottom: 2px solid #F8C545; color: white; font-family: 'Oswald'; }
    .nav-left { color: #F8C545; cursor: pointer; }
    .users-container { padding: 15px; background: #0d0d0d; min-height: 100vh; color: white; }
    .user-card { background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 15px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; position: relative; }
    .user-info { display: flex; flex-direction: column; gap: 5px; }
    .user-name { font-family: 'Oswald'; font-size: 1.1rem; color: white; }
    .user-meta { display: flex; gap: 10px; font-size: 0.85rem; align-items: center; }
    .badge-status { color: white; padding: 3px 8px; border-radius: 4px; font-weight: bold; font-size: 0.7rem; text-transform: uppercase; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
    .text-date { color: #aaa; font-family: 'Roboto'; font-size: 0.8rem; }
    .text-date i { color: #F8C545; margin-right: 3px; }
    .action-side { display: flex; align-items: center; gap: 15px; }
    .btn-renovar { background-color: #28a745; color: white; border: none; border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 8px rgba(40, 167, 69, 0.6); animation: pulse 2s infinite; }
    @@keyframes pulse {0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);} 70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);} 100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);}}
    .btn-icon { background: transparent; border: none; color: #F8C545; font-size: 1.2rem; padding: 5px; }
    .user-dropdown { position: absolute; right: 40px; top: 10px; background-color: #222; border: 1px solid #F8C545; border-radius: 5px; min-width: 180px; z-index: 1000; box-shadow: 0 5px 15px rgba(0,0,0,0.8); }
    .dropdown-item { padding: 12px 15px; color: white; border-bottom: 1px solid #333; cursor: pointer; display: flex; align-items: center; gap: 10px; font-family: 'Roboto'; font-size: 0.9rem; }
    .dropdown-item:last-child { border-bottom: none; }
    .dropdown-item:active { background-color: #333; }
    .dropdown-item i { width: 20px; text-align: center; color: #F8C545; }
    .text-danger { color: #ff6b6b !important; } .text-danger i { color: #ff6b6b !important; }
    .menu-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 999; }
    .input-dark { background: #333 !important; color: white !important; border: 1px solid #F8C545; text-align: center; }
</style>

@code {
    private List<AtletaConEstadoDto> listaUsuarios = new List<AtletaConEstadoDto>();
    private bool cargando = true;
    private bool mostrarModalPago = false;
    private AtletaConEstadoDto usuarioSeleccionado;
    private DateTime fechaPagoSeleccionada = DateTime.Today;

    protected override async Task OnInitializedAsync()
    {
        // 1. SEGURIDAD DE NIVEL ALTO
        if (Sesion.Usuario == null) { Nav.NavigateTo("/"); return; }

        // Si no eres Admin (1) y no tienes permiso de gestionar usuarios... FUERA.
        if (Sesion.Usuario.TipoUsuarioID != 1 && !Sesion.TienePermiso("MANAGE_USERS"))
        {
            await App.Current.MainPage.DisplayAlert("Acceso Denegado", "No tienes permisos de gestión.", "OK");
            Nav.NavigateTo("/home");
            return;
        }

        await CargarUsuarios();
    }

    private async Task CargarUsuarios()
    {
        try {
            cargando = true;
            var response = await Http.GetAsync($"https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/pagosapi/atletas-status/{Sesion.Usuario.BoxID}");
            if (response.IsSuccessStatusCode) listaUsuarios = await response.Content.ReadFromJsonAsync<List<AtletaConEstadoDto>>();
        } catch(Exception ex) { await App.Current.MainPage.DisplayAlert("Error", ex.Message, "OK"); } finally { cargando = false; }
    }

    private void ToggleMenu(AtletaConEstadoDto usuario)
    {
        foreach (var u in listaUsuarios) { if (u != usuario) u.MostrarMenu = false; }
        usuario.MostrarMenu = !usuario.MostrarMenu;
    }

    private void AbrirModalRenovacion(AtletaConEstadoDto u)
    {
        // Verificación extra por si acaso
        if(Sesion.Usuario.TipoUsuarioID != 1 && !Sesion.TienePermiso("MANAGE_PAYMENTS")) return;

        u.MostrarMenu = false;
        usuarioSeleccionado = u;
        if (u.DiasRestantes > 0 && u.FechaVencimiento > DateTime.MinValue) fechaPagoSeleccionada = u.FechaVencimiento;
        else fechaPagoSeleccionada = DateTime.Today;
        mostrarModalPago = true;
    }

    private async Task ConfirmarRenovacion()
    {
        try {
            var req = new RenovarPagoRequest { UsuarioID = usuarioSeleccionado.UsuarioID, NuevaFechaInicio = fechaPagoSeleccionada };
            var response = await Http.PostAsJsonAsync("https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/pagosapi/renovar", req);
            if (response.IsSuccessStatusCode) { await App.Current.MainPage.DisplayAlert("Éxito", "Pago registrado.", "OK"); mostrarModalPago = false; await CargarUsuarios(); }
            else await App.Current.MainPage.DisplayAlert("Error", "No se pudo guardar.", "OK");
        } catch(Exception ex) { await App.Current.MainPage.DisplayAlert("Error", ex.Message, "OK"); }
    }

    private void VerEvaluaciones(AtletaConEstadoDto u) { u.MostrarMenu = false; Nav.NavigateTo($"/evaluaciones/{u.UsuarioID}/{u.NombreCompleto}"); }
    private void IrARunning(AtletaConEstadoDto u) { u.MostrarMenu = false; Nav.NavigateTo($"/running-plan/{u.UsuarioID}/{u.NombreCompleto}"); }
    private async Task RestablecerPass(AtletaConEstadoDto u) { u.MostrarMenu = false; await App.Current.MainPage.DisplayAlert("Seguridad", "¿Resetear contraseña?", "Sí", "No"); }

    private async Task EliminarUsuario(AtletaConEstadoDto u)
    {
        // Verificación extra
        if(Sesion.Usuario.TipoUsuarioID != 1 && !Sesion.TienePermiso("DELETE_DATA")) return;

        u.MostrarMenu = false;
        bool confirm = await App.Current.MainPage.DisplayAlert("⚠️ ELIMINAR", $"Se borrarán datos de {u.NombreCompleto}. ¿Seguro?", "SÍ, BORRAR", "Cancelar");
        if (!confirm) return;
        try {
            var response = await Http.PostAsync($"https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/usuariosapi/eliminar-definitivo/{u.UsuarioID}", null);
            if (response.IsSuccessStatusCode) { await App.Current.MainPage.DisplayAlert("Hecho", "Eliminado.", "OK"); listaUsuarios.Remove(u); }
            else await App.Current.MainPage.DisplayAlert("Error", "No se pudo borrar.", "OK");
        } catch(Exception ex) { await App.Current.MainPage.DisplayAlert("Error", ex.Message, "OK"); }
    }

    private void Volver() => Nav.NavigateTo("/home");
}