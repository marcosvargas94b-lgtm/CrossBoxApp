@page "/usuarios-view"
@using CrossBoxApp.Models
@using CrossBoxApp.Models.Services
@inject NavigationManager Nav
@inject HttpClient Http
@inject SesionService Sesion

<div class="top-navbar">
    <div class="nav-left" @onclick="Volver"><i class="fas fa-arrow-left"></i> VOLVER</div>
    <div class="nav-title">ATLETAS</div>
    
    <div class="nav-right">
        @if (Sesion.Usuario.TipoUsuarioID == 1 || Sesion.TienePermiso("MANAGE_USERS"))
        {
            <div class="btn-add-header" @onclick="AbrirModalCrear">
                <i class="fas fa-user-plus"></i>
            </div>
        }
    </div>
</div>

<div class="users-container">
    <div class="search-bar-container">
        <i class="fas fa-search search-icon"></i>
        <input type="text" 
               class="search-input" 
               placeholder="Buscar atleta por nombre..." 
               @bind="textoBusqueda" 
               @bind:event="oninput" />
        @if (!string.IsNullOrEmpty(textoBusqueda))
        {
            <i class="fas fa-times clear-icon" @onclick="() => textoBusqueda = string.Empty"></i>
        }
    </div>

    <div class="filter-tabs">
        <button class="tab-btn @(filtroEstado == "TODOS" ? "active" : "")" 
                @onclick='() => CambiarFiltro("TODOS")'>
            TODOS
        </button>
        
        <button class="tab-btn @(filtroEstado == "POR_VENCER" ? "active" : "")" 
                @onclick='() => CambiarFiltro("POR_VENCER")'>
            ⚠ POR VENCER
        </button>

        <button class="tab-btn @(filtroEstado == "VENCIDOS" ? "active" : "")" 
                @onclick='() => CambiarFiltro("VENCIDOS")'>
            ⛔ VENCIDOS
        </button>
    </div>

    @if (cargando)
    {
        <div class="text-center mt-5"><div class="spinner-border text-warning"></div></div>
    }
    else if (listaUsuarios.Count == 0)
    {
        <div class="text-center mt-5 text-muted">No hay atletas registrados aún.</div>
    }
    else if (UsuariosFiltrados.Count == 0)
    {
        <div class="text-center mt-5 text-muted">
            <i class="fas fa-filter" style="font-size: 2rem; margin-bottom: 10px; color: #444;"></i>
            <p>No hay resultados con estos filtros.</p>
        </div>
    }
    else
    {
        <div class="user-list">
            @foreach (var usuario in UsuariosFiltrados)
            {
                <div class="user-card">
                    <div class="user-info">
                        <div class="user-name">@usuario.NombreCompleto</div>
                        <div class="user-meta">
                            <span class="badge-status" style="background-color: @usuario.ColorEstatus">
                                @usuario.Estatus
                            </span>
                            
                            @if (usuario.DiasRestantes <= 0)
                            {
                                <span class="text-date text-danger"><i class="fas fa-exclamation-circle"></i> Vencido hace @(Math.Abs(usuario.DiasRestantes)) días</span>
                            }
                            else if (usuario.DiasRestantes <= 5)
                            {
                                <span class="text-date text-warning"><i class="fas fa-clock"></i> Quedan @usuario.DiasRestantes días</span>
                            }
                            else if (usuario.DiasRestantes <= 30)
                            {
                                <span class="text-date"><i class="far fa-clock"></i> @usuario.DiasRestantes días</span>
                            }
                        </div>
                    </div>

                    <div class="action-side">
                        @if (usuario.DiasRestantes <= 5 && (Sesion.Usuario.TipoUsuarioID == 1 || Sesion.TienePermiso("MANAGE_PAYMENTS")))
                        {
                            <button class="btn-renovar" @onclick="() => AbrirModalRenovacion(usuario)">
                                <i class="fas fa-money-bill-wave"></i>
                            </button>
                        }

                        <div class="action-menu-wrapper">
                            <button class="btn-icon" @onclick="() => ToggleMenu(usuario)">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>

                            @if (usuario.MostrarMenu)
                            {
                                <div class="user-dropdown">
                                    @if (PermisoPago)
                                    {
                                        <div class="dropdown-item" @onclick="() => AbrirModalRenovacion(usuario)">
                                            <i class="fas fa-calendar-check"></i> Registrar Pago
                                        </div>
                                    }
                                    @if (PermisoEvaluacion)
                                    {
                                        <div class="dropdown-item" @onclick="() => VerEvaluaciones(usuario)">
                                            <i class="fas fa-clipboard-check"></i> Evaluaciones
                                        </div>
                                    }
                                    @if (Sesion.Usuario.TipoUsuarioID == 1 || Sesion.Usuario.TipoUsuarioID == 3)
                                    {
                                        <div class="dropdown-item" @onclick="() => IrAGestionPropositos(usuario)">
                                            <i class="fas fa-bullseye" style="color: #F8C545;"></i> Gestionar Retos
                                        </div>
                                    }
                                    @if (PermisoWod)
                                    {
                                        <div class="dropdown-item" @onclick="() => IrARunning(usuario)">
                                            <i class="fas fa-running"></i> Running Plan
                                        </div>
                                        <div class="dropdown-item" @onclick="() => IrRutinaPersonalizada(usuario)">
                                           <i class="fas fa-dumbbell"></i> Rutina Personalizada
                                        </div>
                                    }
                                    @if (PermisoUsers)
                                    {
                                       @*  <div class="dropdown-item" @onclick="() => RestablecerPass(usuario)">
                                            <i class="fas fa-key"></i> Restablecer Pass
                                        </div> *@
                                        <div class="dropdown-item text-danger" @onclick="() => EliminarUsuario(usuario)">
                                            <i class="fas fa-trash"></i> Eliminar
                                        </div>
                                    }
                                </div>
                                <div class="menu-overlay" @onclick="() => ToggleMenu(usuario)"></div>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@if (mostrarModalCrear)
{
    <div class="modal fade show" style="display: block; background-color: rgba(0,0,0,0.9); z-index: 2000;" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="background-color: #222; border: 1px solid #F8C545; color: white;">
                <div class="modal-header">
                    <h5 class="modal-title" style="color:#F8C545; font-family:'Oswald'; margin:0;">ALTA RÁPIDA</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="() => mostrarModalCrear = false"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label text-warning">Nombre *</label>
                        <input type="text" @bind="nuevoAtleta.Nombre" class="form-control input-dark" placeholder="Ej: Pedro" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-warning">Apellidos *</label>
                        <input type="text" @bind="nuevoAtleta.Apellidos" class="form-control input-dark" placeholder="Ej: Picapiedra" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-warning">Teléfono</label>
                        <input type="tel" @bind="nuevoAtleta.Telefono" class="form-control input-dark" placeholder="Ej: 9611234567" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-warning">Correo (Opcional)</label>
                        <input type="email" @bind="nuevoAtleta.Email" class="form-control input-dark" placeholder="Dejar vacío si no usará la App" />
                        <small class="text-muted d-block mt-1" style="font-size:0.75rem;">
                            <i class="fas fa-info-circle"></i> Si lo dejas vacío, se creará un usuario interno.
                        </small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-warning">Fecha de Inicio (Pago)</label>
                        <input type="date" @bind="nuevoAtleta.FechaInicio" class="form-control input-dark" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="() => mostrarModalCrear = false">Cancelar</button>
                    <button class="btn btn-warning fw-bold" @onclick="GuardarAtletaManual"><i class="fas fa-save"></i> GUARDAR</button>
                </div>
            </div>
        </div>
    </div>
}

@if (mostrarModalPago) { <div class="modal fade show" style="display: block; background-color: rgba(0,0,0,0.9); z-index: 2000;" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content" style="background-color: #222; border: 1px solid #F8C545; color: white;"><div class="modal-header"><h5 class="modal-title" style="color:#F8C545;">REGISTRAR PAGO</h5><button type="button" class="btn-close btn-close-white" @onclick="() => mostrarModalPago = false"></button></div><div class="modal-body text-center"><p>Renovar suscripción para: <br><strong style="font-size:1.2rem">@usuarioSeleccionado?.NombreCompleto</strong></p><div class="info-vencimiento mb-3"><small class="text-muted">Vencimiento actual:</small><br><span style="color:#F8C545; font-weight:bold;">@(usuarioSeleccionado.FechaVencimiento == DateTime.MinValue ? "Nunca ha pagado" : usuarioSeleccionado.FechaVencimiento.ToString("dd/MM/yyyy"))</span></div><label class="mb-2">Nueva Fecha de Inicio:</label><input type="date" @bind="fechaPagoSeleccionada" class="form-control input-dark" style="font-size: 1.2rem; padding: 10px;" /><small class="text-muted">Se sumará 1 mes a partir de esta fecha.</small></div><div class="modal-footer"><button class="btn btn-secondary" @onclick="() => mostrarModalPago = false">Cancelar</button><button class="btn btn-warning" @onclick="ConfirmarRenovacion">Confirmar Pago</button></div></div></div></div> }

<style>
    /* --- ESTILOS DE TABS (NUEVO) --- */
    .filter-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        background: #1a1a1a;
        padding: 5px;
        border-radius: 10px;
        border: 1px solid #333;
    }

    .tab-btn {
        flex: 1;
        background: transparent;
        border: none;
        color: #888;
        padding: 10px 5px;
        font-family: 'Oswald';
        font-size: 0.9rem;
        border-radius: 8px;
        transition: all 0.3s;
        cursor: pointer;
    }

    .tab-btn.active {
        background: #F8C545;
        color: black;
        font-weight: bold;
        box-shadow: 0 2px 10px rgba(248, 197, 69, 0.3);
    }

    /* --- ESTILOS DEL BUSCADOR --- */
    .search-bar-container {
        position: relative;
        margin-bottom: 10px; /* Reduje el margen para que pegue con los tabs */
        display: flex;
        align-items: center;
    }
    
    .search-input {
        width: 100%;
        background-color: #1a1a1a;
        border: 1px solid #333;
        border-radius: 30px;
        padding: 12px 40px; 
        color: white;
        outline: none;
        font-family: 'Roboto';
        font-size: 1rem;
        transition: border-color 0.3s;
    }

    .search-input:focus {
        border-color: #F8C545;
        box-shadow: 0 0 8px rgba(248, 197, 69, 0.2);
    }

    .search-icon {
        position: absolute;
        left: 15px;
        color: #666;
    }

    .clear-icon {
        position: absolute;
        right: 15px;
        color: #666;
        cursor: pointer;
        padding: 5px;
    }
    .clear-icon:hover { color: #ccc; }

    /* (RESTO DE ESTILOS SE MANTIENEN IGUAL) */
    .btn-add-header { font-size: 1.5rem; color: #F8C545; cursor: pointer; padding: 0 10px; transition: transform 0.2s; }
    .btn-add-header:active { transform: scale(0.8); }
    .input-dark { background: #333 !important; color: white !important; border: 1px solid #555; }
    .input-dark:focus { border-color: #F8C545; box-shadow: 0 0 5px rgba(248,197,69,0.5); }
    .text-warning { color: #F8C545 !important; }
    .top-navbar { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #1a1a1a; border-bottom: 2px solid #F8C545; color: white; font-family: 'Oswald'; }
    .nav-left { color: #F8C545; cursor: pointer; }
    .users-container { padding: 15px; background: #0d0d0d; min-height: 100vh; color: white; }
    .user-card { background-color: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 15px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; position: relative; }
    .user-info { display: flex; flex-direction: column; gap: 5px; }
    .user-name { font-family: 'Oswald'; font-size: 1.1rem; color: white; }
    .user-meta { display: flex; gap: 10px; font-size: 0.85rem; align-items: center; }
    .badge-status { color: white; padding: 3px 8px; border-radius: 4px; font-weight: bold; font-size: 0.7rem; text-transform: uppercase; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
    .text-date { color: #aaa; font-family: 'Roboto'; font-size: 0.8rem; }
    .text-date i { margin-right: 3px; }
    .action-side { display: flex; align-items: center; gap: 15px; }
    .btn-renovar { background-color: #28a745; color: white; border: none; border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 8px rgba(40, 167, 69, 0.6); animation: pulse 2s infinite; }
    .btn-icon { background: transparent; border: none; color: #F8C545; font-size: 1.2rem; padding: 5px; }
    .user-dropdown { position: absolute; right: 40px; top: 10px; background-color: #222; border: 1px solid #F8C545; border-radius: 5px; min-width: 180px; z-index: 1000; box-shadow: 0 5px 15px rgba(0,0,0,0.8); }
    .dropdown-item { padding: 12px 15px; color: white; border-bottom: 1px solid #333; cursor: pointer; display: flex; align-items: center; gap: 10px; font-family: 'Roboto'; font-size: 0.9rem; }
    .dropdown-item:active { background-color: #333; }
    .text-danger { color: #ff6b6b !important; } .text-danger i { color: #ff6b6b !important; }
    .menu-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 999; }
    @@keyframes pulse {0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);} 70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);} 100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);}}
</style>

@code {
    // --- VARIABLES DE FILTRO Y BÚSQUEDA ---
    private string filtroEstado = "TODOS";
    private string textoBusqueda = "";

    // LISTA MAESTRA (Descargada de API)
    private List<AtletaConEstadoDto> listaUsuarios = new List<AtletaConEstadoDto>();
    
    // LISTA COMPUTADA (Se actualiza sola cuando cambias filtro o texto)
    private List<AtletaConEstadoDto> UsuariosFiltrados
    {
        get
        {
            // 1. Empezamos con todos
            IEnumerable<AtletaConEstadoDto> query = listaUsuarios;

            // 2. Filtramos por Texto (Nombre)
            if (!string.IsNullOrWhiteSpace(textoBusqueda))
            {
                query = query.Where(u => u.NombreCompleto.Contains(textoBusqueda, StringComparison.OrdinalIgnoreCase));
            }

            // 3. Filtramos por Pestaña (Estado)
            switch (filtroEstado)
            {
                case "POR_VENCER":
                    // Días entre 1 y 5
                    query = query.Where(u => u.DiasRestantes > 0 && u.DiasRestantes <= 5);
                    break;
                case "VENCIDOS":
                    // Días 0 o negativos (ya venció)
                    query = query.Where(u => u.DiasRestantes <= 0);
                    break;
                case "TODOS":
                default:
                    // No hacemos nada, pasan todos
                    break;
            }

            return query.ToList();
        }
    }

    private bool cargando = true;
    private bool PermisoUsers = false;
    private bool PermisoPago = false;
    private bool PermisoWod = false;
    private bool PermisoEvaluacion = false;

    // MODALES
    private bool mostrarModalPago = false;
    private AtletaConEstadoDto usuarioSeleccionado;
    private DateTime fechaPagoSeleccionada = DateTime.Today;
    private bool mostrarModalCrear = false;
    private CrearAtletaManualDto nuevoAtleta = new CrearAtletaManualDto();

    public class CrearAtletaManualDto
    {
        public Guid BoxID { get; set; }
        public string Nombre { get; set; }
        public string Apellidos { get; set; }
        public string Email { get; set; }
        public string? Telefono { get; set; }
        public DateTime FechaInicio { get; set; } = DateTime.Today;
    }

    protected override async Task OnInitializedAsync()
    {
        if (Sesion.Usuario == null) { Nav.NavigateTo("/"); return; }
        
        bool esAdmin = Sesion.Usuario.TipoUsuarioID == 1;
        PermisoUsers = esAdmin || Sesion.TienePermiso("MANAGE_USERS");
        PermisoPago = esAdmin || Sesion.TienePermiso("MANAGE_PAYMENTS");
        PermisoWod = esAdmin || Sesion.TienePermiso("MANAGE_WOD");
        PermisoEvaluacion = esAdmin || Sesion.TienePermiso("MANAGE_EVALUATIONS");

        if (!PermisoUsers) { await App.Current.MainPage.DisplayAlert("Acceso Denegado", "No tienes permisos.", "OK"); Nav.NavigateTo("/home"); return; }

        await CargarUsuarios();
    }

    private async Task CargarUsuarios()
    {
        try {
            cargando = true;
            var response = await Http.GetAsync($"https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/pagosapi/atletas-status/{Sesion.Usuario.BoxID}");
            if (response.IsSuccessStatusCode) listaUsuarios = await response.Content.ReadFromJsonAsync<List<AtletaConEstadoDto>>();
        } catch { } finally { cargando = false; }
    }

    // --- LÓGICA DE TABS ---
    private void CambiarFiltro(string nuevoEstado)
    {
        filtroEstado = nuevoEstado;
        // Al cambiar variable, 'UsuariosFiltrados' se recalcula solo en el HTML
    }

    private void ToggleMenu(AtletaConEstadoDto u) { foreach (var x in listaUsuarios) if (x != u) x.MostrarMenu = false; u.MostrarMenu = !u.MostrarMenu; }
    
    private void IrRutinaPersonalizada(AtletaConEstadoDto u)
    {
        u.MostrarMenu = false;
        Nav.NavigateTo($"/rutina-admin/{u.UsuarioID}/{u.NombreCompleto}");
    }

    // --- PAGO ---
    private void AbrirModalRenovacion(AtletaConEstadoDto u)
    {
        if (!PermisoPago) return;
        u.MostrarMenu = false;
        usuarioSeleccionado = u;
        if (u.DiasRestantes > 0 && u.FechaVencimiento > DateTime.MinValue) fechaPagoSeleccionada = u.FechaVencimiento;
        else fechaPagoSeleccionada = DateTime.Today;
        mostrarModalPago = true;
    }

    private void IrAGestionPropositos(AtletaConEstadoDto u)
    {
        u.MostrarMenu = false;
        Nav.NavigateTo($"/gestion-propositos/{u.UsuarioID}/{u.NombreCompleto}");
    }

    private async Task ConfirmarRenovacion()
    {
        try {
            var req = new RenovarPagoRequest { UsuarioID = usuarioSeleccionado.UsuarioID, NuevaFechaInicio = fechaPagoSeleccionada };
            var response = await Http.PostAsJsonAsync("https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/pagosapi/renovar", req);
            if (response.IsSuccessStatusCode) { await App.Current.MainPage.DisplayAlert("Éxito", "Pago registrado.", "OK"); mostrarModalPago = false; await CargarUsuarios(); }
            else await App.Current.MainPage.DisplayAlert("Error", "No se pudo guardar.", "OK");
        } catch(Exception ex) { await App.Current.MainPage.DisplayAlert("Error", ex.Message, "OK"); }
    }

    // --- CREAR MANUAL ---
    private void AbrirModalCrear()
    {
        nuevoAtleta = new CrearAtletaManualDto { FechaInicio = DateTime.Today };
        mostrarModalCrear = true;
    }

    private async Task GuardarAtletaManual()
    {
        if (string.IsNullOrWhiteSpace(nuevoAtleta.Nombre) || string.IsNullOrWhiteSpace(nuevoAtleta.Apellidos))
        {
            await App.Current.MainPage.DisplayAlert("Error", "Nombre y Apellidos son obligatorios", "OK"); return;
        }
        try
        {
            nuevoAtleta.BoxID = Sesion.Usuario.BoxID;
            var response = await Http.PostAsJsonAsync("https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/usuariosapi/crear-manual", nuevoAtleta);
            if (response.IsSuccessStatusCode) {
                await App.Current.MainPage.DisplayAlert("¡Listo!", "Atleta creado.", "OK");
                mostrarModalCrear = false; await CargarUsuarios();
            } else {
                var msg = await response.Content.ReadFromJsonAsync<dynamic>();
                await App.Current.MainPage.DisplayAlert("Error", msg.mensaje.ToString(), "OK");
            }
        } catch (Exception ex) { await App.Current.MainPage.DisplayAlert("Error", ex.Message, "OK"); }
    }

    // --- OTROS ---
    private void VerEvaluaciones(AtletaConEstadoDto u) { u.MostrarMenu = false; Nav.NavigateTo($"/evaluaciones/{u.UsuarioID}/{u.NombreCompleto}"); }
    private void IrARunning(AtletaConEstadoDto u) { u.MostrarMenu = false; Nav.NavigateTo($"/running-plan/{u.UsuarioID}/{u.NombreCompleto}"); }
    private async Task RestablecerPass(AtletaConEstadoDto u) { u.MostrarMenu = false; await App.Current.MainPage.DisplayAlert("Seguridad", "Función pendiente", "OK"); }
    private async Task EliminarUsuario(AtletaConEstadoDto u) { 
        u.MostrarMenu = false; 
        bool confirm = await App.Current.MainPage.DisplayAlert("⚠️ ELIMINAR", $"Se borrarán datos de {u.NombreCompleto}. ¿Seguro?", "SÍ, BORRAR", "Cancelar"); 
        if (!confirm) return; 
        try { 
            var response = await Http.PostAsync($"https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/usuariosapi/eliminar-definitivo/{u.UsuarioID}", null); 
            if (response.IsSuccessStatusCode) { await App.Current.MainPage.DisplayAlert("Hecho", "Eliminado.", "OK"); listaUsuarios.Remove(u); } 
            else await App.Current.MainPage.DisplayAlert("Error", "No se pudo borrar.", "OK"); 
        } catch(Exception ex) { await App.Current.MainPage.DisplayAlert("Error", ex.Message, "OK"); } 
    }

    private void Volver() => Nav.NavigateTo("/home");
}