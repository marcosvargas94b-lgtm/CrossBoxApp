@page "/usuarios-view"
@using CrossBoxApp.Models
@using CrossBoxApp.Models.Services
@inject NavigationManager Nav
@inject HttpClient Http
@inject SesionService Sesion

<div class="main-layout">

    <div class="navbar-container">
        <div class="nav-left" @onclick="Volver">
            <i class="fas fa-arrow-left"></i> VOLVER
        </div>
        <div class="nav-title">ATLETAS</div>
        
        <div class="nav-right">
            @if (Sesion.Usuario.TipoUsuarioID == 1 || Sesion.TienePermiso("MANAGE_USERS"))
            {
                <div class="btn-add-header" @onclick="AbrirModalCrear">
                    <i class="fas fa-user-plus"></i>
                </div>
            }
        </div>
    </div>

    <div class="scrollable-content">
        
        <div class="search-bar-container fade-in">
            <i class="fas fa-search search-icon"></i>
            <input type="text" 
                   class="search-input" 
                   placeholder="Buscar atleta por nombre..." 
                   @bind="textoBusqueda" 
                   @bind:event="oninput" />
            @if (!string.IsNullOrEmpty(textoBusqueda))
            {
                <i class="fas fa-times clear-icon" @onclick="() => textoBusqueda = string.Empty"></i>
            }
        </div>

        <div class="filter-tabs fade-in">
            <button class="tab-btn @(filtroEstado == "TODOS" ? "active" : "")" 
                    @onclick='() => CambiarFiltro("TODOS")'>
                TODOS
            </button>
            
            <button class="tab-btn @(filtroEstado == "POR_VENCER" ? "active" : "")" 
                    @onclick='() => CambiarFiltro("POR_VENCER")'>
                ⚠ POR VENCER
            </button>

            <button class="tab-btn @(filtroEstado == "VENCIDOS" ? "active" : "")" 
                    @onclick='() => CambiarFiltro("VENCIDOS")'>
                ⛔ VENCIDOS
            </button>
        </div>

        @if (cargando)
        {
            <div class="text-center mt-5">
                <div class="spinner-border text-warning"></div>
            </div>
        }
        else if (listaUsuarios.Count == 0)
        {
            <div class="text-center mt-5 text-muted fade-in">
                <i class="fas fa-users-slash mb-3" style="font-size: 3rem; opacity: 0.3;"></i>
                <p>No hay atletas registrados aún.</p>
            </div>
        }
        else if (UsuariosFiltrados.Count == 0)
        {
            <div class="text-center mt-5 text-muted fade-in">
                <i class="fas fa-filter mb-3" style="font-size: 2rem; color: #444;"></i>
                <p>No hay resultados con estos filtros.</p>
            </div>
        }
        else
        {
            <div class="user-list fade-in">
                @foreach (var usuario in UsuariosFiltrados)
                {
                    <div class="user-card">
                        <div class="user-info">
                            <div class="user-name">@usuario.NombreCompleto</div>
                            <div class="user-meta">
                                <span class="badge-status" style="background-color: @usuario.ColorEstatus">
                                    @usuario.Estatus
                                </span>
                                
                                @if (usuario.DiasRestantes <= 0)
                                {
                                    <span class="text-date text-danger"><i class="fas fa-exclamation-circle"></i> Vencido hace @(Math.Abs(usuario.DiasRestantes)) días</span>
                                }
                                else if (usuario.DiasRestantes <= 5)
                                {
                                    <span class="text-date text-warning"><i class="fas fa-clock"></i> Quedan @usuario.DiasRestantes días</span>
                                }
                                else if (usuario.DiasRestantes <= 30)
                                {
                                    <span class="text-date"><i class="far fa-clock"></i> @usuario.DiasRestantes días</span>
                                }
                            </div>
                        </div>

                        <div class="action-side">
                            @if (usuario.DiasRestantes <= 5 && (Sesion.Usuario.TipoUsuarioID == 1 || Sesion.TienePermiso("MANAGE_PAYMENTS")))
                            {
                                <button class="btn-renovar" @onclick="() => AbrirModalRenovacion(usuario)">
                                    <i class="fas fa-money-bill-wave"></i>
                                </button>
                            }

                            <div class="action-menu-wrapper">
                                <button class="btn-icon" @onclick="() => ToggleMenu(usuario)">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>

                                @if (usuario.MostrarMenu)
                                {
                                    <div class="user-dropdown slide-down">
                                        @if (PermisoPago)
                                        {
                                            <div class="dropdown-item" @onclick="() => AbrirModalRenovacion(usuario)">
                                                <i class="fas fa-calendar-check text-success"></i> Registrar Pago
                                            </div>
                                        }
                                        @if (PermisoEvaluacion)
                                        {
                                            <div class="dropdown-item" @onclick="() => VerEvaluaciones(usuario)">
                                                <i class="fas fa-clipboard-check text-info"></i> Evaluaciones
                                            </div>
                                        }
                                        @if (Sesion.Usuario.TipoUsuarioID == 1 || Sesion.Usuario.TipoUsuarioID == 3)
                                        {
                                            <div class="dropdown-item" @onclick="() => IrAGestionPropositos(usuario)">
                                                <i class="fas fa-bullseye text-warning"></i> Gestionar Retos
                                            </div>
                                        }
                                        @if (PermisoWod)
                                        {
                                            <div class="dropdown-item" @onclick="() => IrARunning(usuario)">
                                                <i class="fas fa-running text-primary"></i> Running Plan
                                            </div>
                                            <div class="dropdown-item" @onclick="() => IrRutinaPersonalizada(usuario)">
                                               <i class="fas fa-dumbbell text-secondary"></i> Rutina Personalizada
                                            </div>
                                        }
                                        @if (PermisoUsers)
                                        {
                                            <div class="dropdown-item text-danger" @onclick="() => EliminarUsuario(usuario)">
                                                <i class="fas fa-trash"></i> Eliminar
                                            </div>
                                        }
                                    </div>
                                    <div class="menu-overlay" @onclick="() => ToggleMenu(usuario)"></div>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        
        <div style="height: 60px;"></div>
    </div>
</div>

@if (mostrarModalCrear)
{
    <div class="modal-overlay fade-in">
        <div class="modal-content custom-modal slide-up">
            <div class="modal-header">
                <h5 class="modal-title" style="color:#F8C545; font-family:'Oswald'; margin:0;">ALTA RÁPIDA</h5>
                <button type="button" class="btn-close-custom" @onclick="() => mostrarModalCrear = false"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label text-warning">Nombre *</label>
                    <input type="text" @bind="nuevoAtleta.Nombre" @bind:event="oninput" class="form-control input-dark" placeholder="Ej: Pedro" />
                </div>
                <div class="mb-3">
                    <label class="form-label text-warning">Apellidos *</label>
                    <input type="text" @bind="nuevoAtleta.Apellidos" @bind:event="oninput" class="form-control input-dark" placeholder="Ej: Picapiedra" />
                </div>

                <div class="mb-3">
                    <label class="form-label text-warning">Teléfono *</label>
                    <input type="tel"
                           @bind="TelefonoFormateado"
                           @bind:event="oninput"
                           class="form-control input-dark"
                           placeholder="Ej: 9611234567"
                           maxlength="10" />

                    @if (!string.IsNullOrEmpty(nuevoAtleta.Telefono) && nuevoAtleta.Telefono.Length < 10)
                    {
                        <small class="text-danger" style="font-size: 0.7rem;">
                            Faltan @(10 - nuevoAtleta.Telefono.Length) dígitos...
                        </small>
                    }
                </div>
                <div class="mb-3">
                    <label class="form-label text-warning">Correo (Opcional)</label>
                    <input type="email" @bind="nuevoAtleta.Email" class="form-control input-dark" placeholder="Dejar vacío si no usará la App" />
                    <small class="text-muted d-block mt-1" style="font-size:0.75rem;">
                        <i class="fas fa-info-circle"></i> Si lo dejas vacío, se creará un usuario interno.
                    </small>
                </div>
                <div class="mb-3">
                    <label class="form-label text-warning">Fecha de Inicio (Pago)</label>
                    <input type="date" @bind="nuevoAtleta.FechaInicio" class="form-control input-dark" />
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" @onclick="() => mostrarModalCrear = false" disabled="@guardandoAtleta">Cancelar</button>

                <button class="btn-confirm fw-bold @(EsFormularioValido ? "btn-valid" : "btn-invalid")"
                        @onclick="GuardarAtletaManual"
                        disabled="@(!EsFormularioValido || guardandoAtleta)">

                    @if (guardandoAtleta)
                    {
                        <span><i class="fas fa-circle-notch fa-spin"></i> GUARDANDO...</span>
                    }
                    else
                    {
                        <span><i class="fas fa-save"></i> GUARDAR</span>
                    }
                </button>
            </div>
        </div>
    </div>
}

@if (mostrarModalPago) 
{ 
    <div class="modal-overlay fade-in">
        <div class="modal-content custom-modal slide-up">
            <div class="modal-header">
                <h5 class="modal-title" style="color:#F8C545; font-family:'Oswald'; margin:0;">REGISTRAR PAGO</h5>
                <button type="button" class="btn-close-custom" @onclick="() => mostrarModalPago = false"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body text-center">
                <p>Renovar suscripción para: <br><strong style="font-size:1.2rem; color:white;">@usuarioSeleccionado?.NombreCompleto</strong></p>
                
                <div class="info-vencimiento mb-3">
                    <small class="text-muted">Vencimiento actual:</small><br>
                    <span style="color:#F8C545; font-weight:bold;">@(usuarioSeleccionado.FechaVencimiento == DateTime.MinValue ? "Nunca ha pagado" : usuarioSeleccionado.FechaVencimiento.ToString("dd/MM/yyyy"))</span>
                </div>
                
                <label class="mb-2 lbl-input">Nueva Fecha de Inicio:</label>
                <input type="date" @bind="fechaPagoSeleccionada" class="form-control input-dark" style="font-size: 1.1rem; padding: 10px;" />
                <small class="text-muted d-block mt-2">Se sumará 1 mes a partir de esta fecha.</small>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" @onclick="() => mostrarModalPago = false">Cancelar</button>
                <button class="btn-confirm" @onclick="ConfirmarRenovacion">Confirmar Pago</button>
            </div>
        </div>
    </div> 
}

<style>
    /* --- ESTRUCTURA BASE --- */
    .main-layout {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background-color: #0d0d0d; display: flex; flex-direction: column; z-index: 1;
    }

    .navbar-container {
        flex-shrink: 0;
        padding-top: calc(env(safe-area-inset-top) + 5px);
        padding-bottom: 10px; padding-left: 20px; padding-right: 20px;
        background-color: #0d0d0d; border-bottom: 1px solid #F8C545;
        color: white; display: flex; justify-content: space-between; align-items: center;
        z-index: 100; font-family: 'Oswald'; min-height: 60px;
    }

    .nav-left { color: #F8C545; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }
    .nav-title { font-weight: bold; font-size: 1.1rem; color: white; letter-spacing: 1px; }
    .nav-right { width: 60px; display: flex; justify-content: flex-end; }

    .btn-add-header { font-size: 1.2rem; color: #F8C545; cursor: pointer; padding: 5px; }

    .scrollable-content {
        flex-grow: 1; overflow-y: auto; padding: 15px;
        display: flex; flex-direction: column; align-items: center;
        -webkit-overflow-scrolling: touch; padding-bottom: 40px;
    }

    /* --- ESTILOS USUARIOS --- */
    
    /* BUSCADOR */
    .search-bar-container {
        position: relative; margin-bottom: 15px; width: 100%; max-width: 600px;
        display: flex; align-items: center;
    }
    .search-input {
        width: 100%; background-color: #1a1a1a; border: 1px solid #333;
        border-radius: 30px; padding: 10px 40px; color: white; outline: none;
        font-family: 'Roboto'; font-size: 1rem; transition: border-color 0.3s;
    }
    .search-input:focus { border-color: #F8C545; box-shadow: 0 0 8px rgba(248, 197, 69, 0.2); }
    .search-icon { position: absolute; left: 15px; color: #666; }
    .clear-icon { position: absolute; right: 15px; color: #666; cursor: pointer; padding: 5px; }

    /* TABS */
    .filter-tabs {
        display: flex; gap: 10px; margin-bottom: 20px; background: #1a1a1a;
        padding: 5px; border-radius: 10px; border: 1px solid #333;
        width: 100%; max-width: 600px;
    }
    .tab-btn {
        flex: 1; background: transparent; border: none; color: #888;
        padding: 8px 5px; font-family: 'Oswald'; font-size: 0.85rem;
        border-radius: 8px; transition: all 0.3s; cursor: pointer;
    }
    .tab-btn.active { background: #F8C545; color: black; font-weight: bold; }

    /* LISTA */
    .user-list { width: 100%; max-width: 600px; display: flex; flex-direction: column; gap: 10px; }

    .user-card {
        background-color: #1a1a1a; border: 1px solid #333; border-radius: 10px;
        padding: 15px; display: flex; justify-content: space-between; align-items: center;
        position: relative; transition: transform 0.1s;
    }
    
    .user-info { display: flex; flex-direction: column; gap: 4px; }
    .user-name { font-family: 'Oswald'; font-size: 1rem; color: white; }
    
    .user-meta { display: flex; gap: 10px; font-size: 0.8rem; align-items: center; flex-wrap: wrap; }
    .badge-status { color: white; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 0.65rem; text-transform: uppercase; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
    
    .text-date { color: #aaa; font-family: 'Roboto'; font-size: 0.8rem; }
    .text-danger { color: #ff6b6b !important; }
    .text-warning { color: #F8C545 !important; }

    /* ACCIONES */
    .action-side { display: flex; align-items: center; gap: 10px; }
    
    .btn-renovar {
        background-color: #28a745; color: white; border: none; border-radius: 50%;
        width: 35px; height: 35px; display: flex; align-items: center; justify-content: center;
        box-shadow: 0 0 8px rgba(40, 167, 69, 0.6); animation: pulse 2s infinite; font-size: 0.9rem;
    }
    
    .btn-icon { background: transparent; border: none; color: #F8C545; font-size: 1.1rem; padding: 5px; }

    /* DROPDOWN */
    .user-dropdown {
        position: absolute; right: 40px; top: 35px; background-color: #222;
        border: 1px solid #F8C545; border-radius: 8px; min-width: 190px;
        z-index: 1000; box-shadow: 0 5px 15px rgba(0,0,0,0.9); overflow: hidden;
    }
    .dropdown-item {
        padding: 12px 15px; color: white; border-bottom: 1px solid #333;
        cursor: pointer; display: flex; align-items: center; gap: 10px;
        font-family: 'Roboto'; font-size: 0.9rem; background: #222;
    }
    .dropdown-item:last-child { border-bottom: none; }
    .dropdown-item:active { background-color: #333; }
    .menu-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 999; }

    /* MODALES */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
    .custom-modal { background: #1a1a1a; width: 90%; max-width: 400px; border: 1px solid #F8C545; border-radius: 12px; padding: 0; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 10px 40px rgba(0,0,0,0.8); }
    
    .modal-header { padding: 15px; background: #222; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
    .modal-body { padding: 20px; color: white; }
    .modal-footer { padding: 15px; border-top: 1px solid #333; background: #222; display: flex; justify-content: flex-end; gap: 10px; }

    .btn-close-custom { background: none; border: none; color: white; font-size: 1.2rem; }
    .btn-cancel { background: #333; color: white; border: none; padding: 8px 15px; border-radius: 5px; }
    .btn-confirm { background: #F8C545; color: black; border: none; padding: 8px 15px; border-radius: 5px; font-weight: bold; }

    .input-dark { background: #333 !important; color: white !important; border: 1px solid #555; }
    .input-dark:focus { border-color: #F8C545; box-shadow: none; }
    .form-label { color: #F8C545; font-size: 0.85rem; margin-bottom: 4px; display: block; font-weight: bold; }

    .fade-in { animation: fadeIn 0.5s ease; }
    .slide-up { animation: slideUp 0.3s ease; }
    .slide-down { animation: slideDown 0.2s ease-out; transform-origin: top right; }
    
    @@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @@keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @@keyframes slideDown { from { transform: scaleY(0); opacity: 0; } to { transform: scaleY(1); opacity: 1; } }
    @@keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(40, 167, 69, 0); } 100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); } }

    .btn-confirm.btn-invalid {
        background-color: #444 !important;
        color: #888 !important;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
    }

    /* Botón cuando el formulario SÍ es válido */
    .btn-confirm.btn-valid {
        background-color: #F8C545 !important;
        color: black !important;
        cursor: pointer;
        box-shadow: 0 0 15px rgba(248, 197, 69, 0.4);
        transition: all 0.3s ease;
    }

        .btn-confirm.btn-valid:hover {
            transform: scale(1.05);
            background-color: #ffca28 !important;
        }
</style>

@code {
    private string filtroEstado = "TODOS";
    private string textoBusqueda = "";
    private List<AtletaConEstadoDto> listaUsuarios = new List<AtletaConEstadoDto>();
    private bool EsFormularioValido =>
    !string.IsNullOrWhiteSpace(nuevoAtleta.Nombre) &&
    !string.IsNullOrWhiteSpace(nuevoAtleta.Apellidos) &&
    !string.IsNullOrEmpty(nuevoAtleta.Telefono) &&
    nuevoAtleta.Telefono.Trim().Length == 10;

    private bool guardandoAtleta = false;

    private List<AtletaConEstadoDto> UsuariosFiltrados
    {
        get
        {
            IEnumerable<AtletaConEstadoDto> query = listaUsuarios;

            if (!string.IsNullOrWhiteSpace(textoBusqueda))
            {
                query = query.Where(u => u.NombreCompleto.Contains(textoBusqueda, StringComparison.OrdinalIgnoreCase));
            }

            switch (filtroEstado)
            {
                case "POR_VENCER":
                    query = query.Where(u => u.DiasRestantes > 0 && u.DiasRestantes <= 5);
                    break;
                case "VENCIDOS":
                    query = query.Where(u => u.DiasRestantes <= 0);
                    break;
                case "TODOS":
                default:
                    break;
            }

            return query.ToList();
        }
    }

    private bool cargando = true;
    private bool PermisoUsers = false;
    private bool PermisoPago = false;
    private bool PermisoWod = false;
    private bool PermisoEvaluacion = false;

    // MODALES
    private bool mostrarModalPago = false;
    private AtletaConEstadoDto usuarioSeleccionado;
    private DateTime fechaPagoSeleccionada = DateTime.Today;
    private bool mostrarModalCrear = false;
    private CrearAtletaManualDto nuevoAtleta = new CrearAtletaManualDto();
    
    private string TelefonoFormateado
    {
        get => nuevoAtleta.Telefono;
        set
        {
            // Filtramos: Solo permitimos dígitos del 0 al 9
            if (value != null)
            {
                nuevoAtleta.Telefono = new string(value.Where(c => char.IsDigit(c)).ToArray());
            }
            else
            {
                nuevoAtleta.Telefono = string.Empty;
            }
        }
    }
    public class CrearAtletaManualDto
    {
        public Guid BoxID { get; set; }
        public string Nombre { get; set; }
        public string Apellidos { get; set; }
        public string Email { get; set; }
        public string? Telefono { get; set; }
        public DateTime FechaInicio { get; set; } = DateTime.Today;
    }

    protected override async Task OnInitializedAsync()
    {
        if (Sesion.Usuario == null) { Nav.NavigateTo("/"); return; }
        
        bool esAdmin = Sesion.Usuario.TipoUsuarioID == 1;
        PermisoUsers = esAdmin || Sesion.TienePermiso("MANAGE_USERS");
        PermisoPago = esAdmin || Sesion.TienePermiso("MANAGE_PAYMENTS");
        PermisoWod = esAdmin || Sesion.TienePermiso("MANAGE_WOD");
        PermisoEvaluacion = esAdmin || Sesion.TienePermiso("MANAGE_EVALUATIONS");

        if (!PermisoUsers) 
        { 
            await App.Current.MainPage.DisplayAlert("Acceso Denegado", "No tienes permisos.", "OK"); 
            Nav.NavigateTo("/home"); 
            return; 
        }

        await CargarUsuarios();
    }

    private async Task CargarUsuarios()
    {
        try {
            cargando = true;
            var response = await Http.GetAsync($"https://api-aftrack-mx-fphnazfmahdedtcj.canadacentral-01.azurewebsites.net/api/pagosapi/atletas-status/{Sesion.Usuario.BoxID}");
            if (response.IsSuccessStatusCode) listaUsuarios = await response.Content.ReadFromJsonAsync<List<AtletaConEstadoDto>>();
        } catch { } finally { cargando = false; }
    }

    private void CambiarFiltro(string nuevoEstado) => filtroEstado = nuevoEstado;

    private void ToggleMenu(AtletaConEstadoDto u) { foreach (var x in listaUsuarios) if (x != u) x.MostrarMenu = false; u.MostrarMenu = !u.MostrarMenu; }
    
    private void IrRutinaPersonalizada(AtletaConEstadoDto u)
    {
        u.MostrarMenu = false;
        Nav.NavigateTo($"/rutina-admin/{u.UsuarioID}/{u.NombreCompleto}");
    }

    private void AbrirModalRenovacion(AtletaConEstadoDto u)
    {
        if (!PermisoPago) return;
        u.MostrarMenu = false;
        usuarioSeleccionado = u;
        if (u.DiasRestantes > 0 && u.FechaVencimiento > DateTime.MinValue) fechaPagoSeleccionada = u.FechaVencimiento;
        else fechaPagoSeleccionada = DateTime.Today;
        mostrarModalPago = true;
    }

    private void IrAGestionPropositos(AtletaConEstadoDto u)
    {
        u.MostrarMenu = false;
        Nav.NavigateTo($"/gestion-propositos/{u.UsuarioID}/{u.NombreCompleto}");
    }

    private async Task ConfirmarRenovacion()
    {
        try {
            var req = new RenovarPagoRequest { UsuarioID = usuarioSeleccionado.UsuarioID, NuevaFechaInicio = fechaPagoSeleccionada };
            var response = await Http.PostAsJsonAsync("https://api-aftrack-mx-fphnazfmahdedtcj.canadacentral-01.azurewebsites.net/api/pagosapi/renovar", req);
            if (response.IsSuccessStatusCode) { 
                await App.Current.MainPage.DisplayAlert("Éxito", "Pago registrado.", "OK"); 
                mostrarModalPago = false; 
                await CargarUsuarios(); 
            }
            else await App.Current.MainPage.DisplayAlert("Error", "No se pudo guardar.", "OK");
        } catch(Exception ex) { await App.Current.MainPage.DisplayAlert("Error", ex.Message, "OK"); }
    }

    private void AbrirModalCrear()
    {
        nuevoAtleta = new CrearAtletaManualDto { FechaInicio = DateTime.Today };
        mostrarModalCrear = true;
    }

    private async Task GuardarAtletaManual()
    {
        // Si ya se está enviando una petición, ignorar clics extra
        if (guardandoAtleta) return;

        // 1. Validaciones básicas
        if (string.IsNullOrWhiteSpace(nuevoAtleta.Nombre) || string.IsNullOrWhiteSpace(nuevoAtleta.Apellidos))
        {
            await App.Current.MainPage.DisplayAlert("Error", "Nombre y Apellidos son obligatorios", "OK");
            return;
        }

        // 2. Validación de Teléfono
        if (string.IsNullOrEmpty(nuevoAtleta.Telefono) || nuevoAtleta.Telefono.Trim().Length != 10 || !long.TryParse(nuevoAtleta.Telefono, out _))
        {
            await App.Current.MainPage.DisplayAlert("Teléfono Inválido", "Ingresa un número de 10 dígitos numéricos.", "OK");
            return;
        }

        try
        {
            // ACTIVAR LOADER Y BLOQUEO
            guardandoAtleta = true;
            StateHasChanged(); // Forzar actualización de UI

            nuevoAtleta.BoxID = Sesion.Usuario.BoxID;
            var response = await Http.PostAsJsonAsync("https://api-aftrack-mx-fphnazfmahdedtcj.canadacentral-01.azurewebsites.net/api/usuariosapi/crear-manual", nuevoAtleta);

            if (response.IsSuccessStatusCode)
            {
                await App.Current.MainPage.DisplayAlert("¡Listo!", "Atleta creado exitosamente.", "OK");
                mostrarModalCrear = false;
                await CargarUsuarios();
            }
            else
            {
                // Intentar leer error del backend
                try
                {
                    var errorData = await response.Content.ReadFromJsonAsync<dynamic>();
                    string errorMsg = errorData?.mensaje?.ToString() ?? "Error desconocido en el servidor.";
                    await App.Current.MainPage.DisplayAlert("Atención", errorMsg, "OK");
                }
                catch
                {
                    await App.Current.MainPage.DisplayAlert("Error", "No se pudo crear el atleta. Revisa el formato de los datos.", "OK");
                }
            }
        }
        catch (Exception ex)
        {
            await App.Current.MainPage.DisplayAlert("Error de Conexión", "No se pudo contactar con el servidor. " + ex.Message, "OK");
        }
        finally
        {
            // SIEMPRE DESACTIVAR EL LOADER AL FINAL (éxito o error)
            guardandoAtleta = false;
            StateHasChanged();
        }
    }

    private void VerEvaluaciones(AtletaConEstadoDto u) { u.MostrarMenu = false; Nav.NavigateTo($"/evaluaciones/{u.UsuarioID}/{u.NombreCompleto}"); }
    private void IrARunning(AtletaConEstadoDto u) { u.MostrarMenu = false; Nav.NavigateTo($"/running-plan/{u.UsuarioID}/{u.NombreCompleto}"); }
    
    private async Task EliminarUsuario(AtletaConEstadoDto u) { 
        u.MostrarMenu = false; 
        bool confirm = await App.Current.MainPage.DisplayAlert("⚠️ ELIMINAR", $"Se borrarán datos de {u.NombreCompleto}. ¿Seguro?", "SÍ, BORRAR", "Cancelar"); 
        if (!confirm) return; 
        try { 
            var response = await Http.PostAsync($"https://api-aftrack-mx-fphnazfmahdedtcj.canadacentral-01.azurewebsites.net/api/usuariosapi/eliminar-definitivo/{u.UsuarioID}", null); 
            if (response.IsSuccessStatusCode) { await App.Current.MainPage.DisplayAlert("Hecho", "Eliminado.", "OK"); listaUsuarios.Remove(u); } 
            else await App.Current.MainPage.DisplayAlert("Error", "No se pudo borrar.", "OK"); 
        } catch(Exception ex) { await App.Current.MainPage.DisplayAlert("Error", ex.Message, "OK"); } 
    }

    private void Volver() => Nav.NavigateTo("/home");
}