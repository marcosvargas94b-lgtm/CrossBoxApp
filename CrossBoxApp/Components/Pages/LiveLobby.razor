@page "/live-lobby"
@using Microsoft.AspNetCore.SignalR.Client
@using CrossBoxApp.Models.Services
@inject NavigationManager Nav
@inject SesionService Sesion
@inject HttpClient Http
@inject LiveSessionState LiveState
@inject IJSRuntime JS 
@implements IAsyncDisposable

<div class="rotate-warning">
    <div class="phone-animation">
        <i class="fas fa-mobile-alt"></i>
    </div>
    <h3>GIRA TU TELÉFONO</h3>
    <p>Para gestionar el Lobby en vivo, coloca tu dispositivo en horizontal.</p>
</div>

<div class="lobby-landscape">

    <div class="qr-section">
        <div class="qr-card fade-in">
            <h2 class="qr-title">ESCANEA PARA ENTRAR</h2>
            <div class="qr-frame">
                <img src="@($"https://quickchart.io/qr?text={Sesion.Usuario.BoxID}&size=400&dark=000000&light=ffffff")" 
                     class="qr-img" />
            </div>           
        </div>
    </div>

    <div class="controls-section">
        <div class="header-status">
            <div class="status-title">ATLETAS LISTOS</div>
            <div class="badge-count pulse-badge">@atletasEnSala.Count</div>
        </div>

        <div class="live-list-container">
            @if (atletasEnSala.Count == 0)
            {
                <div class="empty-state">
                    <div class="radar-pulse">
                        <i class="fas fa-satellite-dish"></i>
                    </div>
                    <p>Esperando señal de atletas...</p>
                </div>
            }
            else
            {
                <div class="athletes-scroll" id="scrollContainer">
                    @foreach (var atleta in atletasEnSala)
                    {
                        <div class="athlete-card slide-in">
                            @if (!string.IsNullOrEmpty(atleta.FotoUrl))
                            {
                                <img src="@atleta.FotoUrl" class="athlete-avatar" />
                            }
                            else
                            {
                                <div class="athlete-initial">
                                    @(atleta.NombreCompleto?.Substring(0, 1).ToUpper() ?? "A")
                                </div>
                            }

                            <div class="athlete-info">
                                <span class="athlete-name">@atleta.NombreCompleto</span>
                                <span class="athlete-time"><i class="fas fa-clock"></i> Listo para entrenar</span>
                            </div>
                            <i class="fas fa-check-circle check-icon"></i>
                        </div>
                    }
                </div>
            }
        </div>

        <div class="action-buttons">
            <button class="btn-cancel" @onclick="CancelarClase">CANCELAR</button>
            <button class="btn-start" @onclick="IniciarClase">
                INICIAR CLASE (@atletasEnSala.Count) <i class="fas fa-play"></i>
            </button>
        </div>
    </div>
</div>

<script>
    window.scrollToBottom = (elementId) => {
        var element = document.getElementById(elementId);
        if (element) {
            element.scrollTop = element.scrollHeight;
        }
    };
</script>

<style>
    /* --- BLOQUEO VERTICAL --- */
    .rotate-warning {
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background-color: #000; z-index: 9999;
        display: none; flex-direction: column; justify-content: center; align-items: center;
        color: #F8C545; text-align: center; padding: 40px;
    }
    .phone-animation { font-size: 4rem; margin-bottom: 20px; animation: rotarCelular 2s infinite ease-in-out; }
    @@keyframes rotarCelular { 0% { transform: rotate(0deg); } 50% { transform: rotate(-90deg); } 100% { transform: rotate(0deg); } }
    @@media (orientation: portrait) { .rotate-warning { display: flex; } .lobby-landscape { display: none !important; } }

    /* --- LAYOUT HORIZONTAL --- */
    .lobby-landscape {
        display: flex; width: 100vw; height: 100vh; background-color: #0d0d0d;
        padding: 20px; box-sizing: border-box; gap: 20px;
    }

    /* --- QR FIXED --- */
    .qr-section {
        flex: 1; display: flex; justify-content: center; align-items: center;
        background: radial-gradient(circle, #1a1a1a 0%, #000000 100%);
        border-radius: 20px; border: 1px solid #333; box-shadow: 0 0 30px rgba(0,0,0,0.5);
    }
    .qr-card { 
        text-align: center; width: 100%; 
        display: flex; flex-direction: column; align-items: center; 
    }
    .qr-title { font-family: 'Oswald'; font-size: 2.2rem; color: white; margin-bottom: 15px; letter-spacing: 2px; }
    
    .qr-frame { 
        background: white; padding: 15px; border-radius: 15px; 
        display: flex; justify-content: center; align-items: center;
        box-shadow: 0 0 40px rgba(248, 197, 69, 0.2);
        max-width: 80%; aspect-ratio: 1/1; 
    }
    
    .qr-img { width: 100%; height: 100%; max-width: 300px; object-fit: contain; }
    .qr-footer { color: #888; margin-top: 15px; font-size: 1rem; font-family: 'Roboto'; }

    /* --- CONTROLES Y LISTA --- */
    .controls-section {
        flex: 1; display: flex; flex-direction: column; background: #111;
        border-radius: 20px; padding: 20px; border: 1px solid #333;
        max-height: 100%; 
    }

    .header-status { border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
    .status-title { font-family: 'Oswald'; color: #F8C545; font-size: 1.8rem; }
    .badge-count { background: white; color: black; font-weight: bold; padding: 5px 20px; border-radius: 50px; font-size: 1.2rem; }
    .pulse-badge { animation: pulseBadge 2s infinite; }

    /* SCROLL AREA FIX */
    .live-list-container { flex: 1; overflow: hidden; position: relative; display: flex; flex-direction: column; }
    .athletes-scroll { overflow-y: auto; padding-right: 5px; height: 100%; scroll-behavior: smooth; }

    .athlete-card {
        background: #222; border-left: 5px solid #F8C545; padding: 10px 15px; margin-bottom: 10px;
        border-radius: 8px; display: flex; align-items: center; gap: 15px; transition: transform 0.2s;
        animation: slideIn 0.3s ease-out; 
    }

    /* ESTILO PARA FOTO DE PERFIL */
    .athlete-avatar { 
        width: 50px; height: 50px; border-radius: 50%; object-fit: cover; 
        border: 2px solid #555; flex-shrink: 0; 
    }

    /* NUEVO ESTILO PARA INICIAL (Cuando no hay foto) */
    .athlete-initial {
        width: 50px; height: 50px; background: #333; color: #F8C545; 
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        font-weight: bold; font-size: 1.5rem; border: 2px solid #555;
        flex-shrink: 0; font-family: 'Oswald';
    }

    .athlete-info { flex: 1; display: flex; flex-direction: column; }
    .athlete-name { font-family: 'Oswald'; font-size: 1.2rem; color: white; text-transform: uppercase; }
    .athlete-time { font-size: 0.8rem; color: #888; }
    .check-icon { font-size: 1.5rem; color: #28a745; }

    .empty-state { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #444; }
    .radar-pulse { font-size: 4rem; margin-bottom: 15px; animation: pulseRadar 2s infinite; color: #F8C545; }

    .action-buttons { display: flex; gap: 15px; margin-top: 20px; height: 70px; flex-shrink: 0; }
    .btn-cancel { flex: 1; background: #333; color: white; border: none; border-radius: 12px; font-weight: bold; font-family: 'Oswald'; cursor: pointer; }
    .btn-start { flex: 2; background: #F8C545; color: black; border: none; border-radius: 12px; font-weight: bold; font-family: 'Oswald'; font-size: 1.2rem; cursor: pointer; box-shadow: 0 0 15px rgba(248, 197, 69, 0.3); }
    .btn-start:active { transform: scale(0.98); }

    @@keyframes slideIn { from { transform: translateX(50px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @@keyframes pulseRadar { 0% { opacity: 0.3; transform: scale(1); } 50% { opacity: 1; transform: scale(1.1); } 100% { opacity: 0.3; transform: scale(1); } }
    @@keyframes pulseBadge { 0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 255, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); } }
    @@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .fade-in { animation: fadeIn 1s ease-in; }
</style>

@code {
    private HubConnection hubConnection;
    private List<CheckInDto> atletasEnSala = new List<CheckInDto>();

    protected override async Task OnInitializedAsync()
    {
        if (Sesion.Usuario == null) { Nav.NavigateTo("/"); return; }

        hubConnection = new HubConnectionBuilder()
            .WithUrl("https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/livehub")
            .WithAutomaticReconnect()
            .Build();

        hubConnection.On<CheckInDto>("NuevoAtletaEnClase", (atleta) =>
        {
            InvokeAsync(async () =>
            {
                if (!atletasEnSala.Any(x => x.UsuarioId == atleta.UsuarioId))
                {
                    // Agregamos al FINAL de la lista
                    atletasEnSala.Add(atleta);
                    
                    StateHasChanged(); 

                    // Auto-scroll
                    try {
                        await JS.InvokeVoidAsync("scrollToBottom", "scrollContainer");
                    } catch { /* Ignorar */ }
                }
            });
        });

        await hubConnection.StartAsync();
        await hubConnection.SendAsync("JoinBoxGroup", Sesion.Usuario.BoxID.ToString());
    }

    private void CancelarClase()
    {
        atletasEnSala.Clear();
        Nav.NavigateTo("/home");
    }

    private void IniciarClase()
    {
        LiveState.AtletasEnClase = atletasEnSala;
        LiveState.BoxId = Sesion.Usuario.BoxID;
        Nav.NavigateTo("/live-dashboard");
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }
}