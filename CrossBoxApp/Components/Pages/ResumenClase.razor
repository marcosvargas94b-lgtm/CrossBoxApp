@page "/resumen-clase"
@using CrossBoxApp.Models
@using CrossBoxApp.Models.Services
@using System.Globalization
@inject LiveSessionState LiveState
@inject NavigationManager Nav
@inject HttpClient Http
@inject SesionService Sesion

<div class="resumen-container">
    <div class="resumen-card">
        
        <div class="header-resumen">
            <h2>CLASE FINALIZADA</h2>
            
            @* --- SWITCH DE CATEGORÍA --- *@
            <div class="category-switch-area">
                <span class="lbl-cat">¿USAR CATEGORÍAS?</span>
                <label class="switch-cat">
                    <input type="checkbox" @bind="usarCategorias">
                    <span class="slider-cat round"></span>
                </label>
            </div>

            @if (LiveState.FueModoJuez)
            {
                <div class="mode-badge">
                    <i class="fas fa-stopwatch"></i> TIEMPOS CAPTURADOS
                </div>
            }
            else
            {
                <div class="score-toggle" @onclick="() => modoScore = !modoScore">
                    <span class="@(!modoScore ? "active" : "")">ASISTENCIA</span>
                    <div class="toggle-track @(modoScore ? "on" : "")">
                        <div class="toggle-thumb"></div>
                    </div>
                    <span class="@(modoScore ? "active" : "")">RESULTADOS</span>
                </div>
            }
        </div>

        <div class="attendance-list scroll-custom">
            
            @* ==================================================================== *@
            @* MODO JUEZ (TIEMPOS) *@
            @* ==================================================================== *@
            @if (LiveState.FueModoJuez)
            {
                @if (LiveState.ResultadosJuez.Count == 0)
                {
                    <div class="text-muted">No se capturaron tiempos.</div>
                }
                else
                {
                    <table class="table-results">
                        <thead>
                            <tr>
                                <th>Atleta / Equipo</th>
                                <th style="text-align:center;">Tiempo</th>
                            </tr>
                        </thead>
                        <tbody>
                        @foreach (var res in LiveState.ResultadosJuez)
                        {
                            // Usamos el ID del primer atleta como clave única
                            var key = res.Atletas[0].UsuarioId; 
                            string catActual = "";
                            if (categoriasJuezSeleccionadas.ContainsKey(key)) catActual = categoriasJuezSeleccionadas[key];

                            <tr>
                                <td style="text-align:left;">
                                    @* DATOS DEL ATLETA/EQUIPO *@
                                    @if (res.Atletas.Count > 1)
                                    {
                                        <div class="team-group">
                                            <div class="team-members">
                                                @foreach(var a in res.Atletas)
                                                {
                                                    <div class="mini-row">
                                                        <span>@a.NombreCompleto</span>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    }
                                    else
                                    {
                                        var atl = res.Atletas[0];
                                        <div class="individual-row">
                                            @if(!string.IsNullOrEmpty(atl.FotoUrl)) { <img src="@atl.FotoUrl" class="avatar-small" @onerror="@(e => atl.FotoUrl = null)" /> }
                                            else { <div class="avatar-small-letter">@atl.NombreCompleto.Substring(0,1)</div> }
                                            <span>@atl.NombreCompleto</span>
                                        </div>
                                    }

                                    @* --- ETIQUETA CATEGORÍA CLICKEABLE --- *@
                                    @if (usarCategorias)
                                    {
                                        <div class="cat-badge-container" @onclick="() => AbrirModalCategoria(key, true)">
                                            @if (string.IsNullOrEmpty(catActual))
                                            {
                                                <span class="cat-badge-empty">Categoría (+)</span>
                                            }
                                            else
                                            {
                                                <span class="cat-badge-filled">@catActual</span>
                                            }
                                        </div>
                                    }
                                </td>
                                <td style="text-align:center; vertical-align: top;">
                                    <div class="result-box @(res.Finalizado ? "done" : "pend")">
                                        @(res.Finalizado ? res.TiempoFinal : "---")
                                    </div>
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>
                }
            }
            @* ==================================================================== *@
            @* MODO MANUAL (ASISTENCIA / REPS) *@
            @* ==================================================================== *@
            else
            {
                @if (listaLocal.Count == 0)
                {
                    <div class="text-muted">Nadie hizo check-in.</div>
                }
                else
                {
                    @foreach (var atleta in listaLocal)
                    {
                        <div class="user-row-wrapper">
                            <div class="user-row">
                                <div class="user-left">
                                    @if (!string.IsNullOrEmpty(atleta.FotoUrl))
                                    {
                                        <img src="@atleta.FotoUrl" class="avatar-list-img" @onerror="@(e => atleta.FotoUrl = null)" />
                                    }
                                    else
                                    {
                                        <div class="avatar-list-letter">
                                            @(atleta.NombreCompleto?.Substring(0, 1).ToUpper() ?? "A")
                                        </div>
                                    }
                                    
                                    <div style="display:flex; flex-direction:column; align-items:flex-start;">
                                        <span class="text-truncate">@atleta.NombreCompleto</span>
                                        
                                        @* --- ETIQUETA CATEGORÍA CLICKEABLE (MANUAL) --- *@
                                        @if (usarCategorias)
                                        {
                                            <div class="cat-badge-manual" @onclick="() => AbrirModalCategoria(atleta.UsuarioId, false)">
                                                @if (string.IsNullOrEmpty(atleta.Categoria))
                                                {
                                                    <span class="cat-text-empty">Categoría (+)</span>
                                                }
                                                else
                                                {
                                                    <span class="cat-text-filled">@atleta.Categoria</span>
                                                }
                                            </div>
                                        }
                                    </div>
                                </div>

                                @if (modoScore)
                                {
                                    <div class="score-input-wrapper">
                                        <input type="number" @bind="atleta.Reps" class="input-reps" placeholder="0" min="0" />
                                        <small>REPS</small>
                                    </div>
                                }
                                else
                                {
                                    <i class="fas fa-check" style="color:#28a745; margin-right:10px;"></i>
                                }
                            </div>
                        </div>
                    }
                }
            }
        </div>

        <div class="footer-actions">
            <button class="btn-close-session" @onclick="ProcesarYGuardar" disabled="@guardando">
                @if (guardando)
                {
                    <span><i class="fas fa-spinner fa-spin"></i> GUARDANDO...</span>
                }
                else
                {
                    <span>CONFIRMAR Y GUARDAR</span>
                }
            </button>
        </div>
    </div>
</div>

@* --- MODAL SELECCIONAR CATEGORÍA --- *@
@if (mostrarModalCategoria)
{
    <div class="modal-overlay fade-in">
        <div class="modal-content custom-modal" style="height:auto; max-width:350px;">
            <div class="modal-header">
                <h5 style="margin:0; color:#F8C545; font-weight:bold;">SELECCIONAR NIVEL</h5>
                <button class="btn-icon-header" @onclick="() => mostrarModalCategoria = false"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="cat-buttons-grid">
                    <button class="btn-cat-opt" @onclick='() => AsignarCategoria("PRINCIPIANTE")'>PRINCIPIANTE</button>
                    <button class="btn-cat-opt" @onclick='() => AsignarCategoria("INTERMEDIO")'>INTERMEDIO</button>
                    <button class="btn-cat-opt" @onclick='() => AsignarCategoria("AVANZADO")'>AVANZADO</button>
                    <button class="btn-cat-opt" @onclick='() => AsignarCategoria("RX")'>RX</button>
                </div>
            </div>
        </div>
    </div>
}

@* --- MODAL DE PODIO FINAL --- *@
@if (mostrarPodio)
{
    <div class="podium-overlay fade-in">
        <button class="btn-close-overlay" @onclick="FinalizarNavegacion">
            <i class="fas fa-times"></i>
        </button>

        <div class="victory-bg-effect"></div>
        <div class="victory-container">
            <div class="victory-layout-main">
                
                @* --- PODIO --- *@
                <div class="podium-area">
                    <div class="podium-stage">
                        
                        @* 2DO LUGAR *@
                        <div class="podium-group slide-up-delay-2">
                            <div class="podium-avatar-box silver-glow">
                                @if (!string.IsNullOrEmpty(top3.ElementAtOrDefault(1)?.FotoUrl))
                                {
                                    <img src="@top3[1].FotoUrl" class="avatar-circle" @onerror="@(e => top3[1].FotoUrl = null)" />
                                }
                                else
                                {
                                    <div class="medal-placeholder silver-medal"><i class="fas fa-medal"></i></div>
                                }
                            </div>
                            <div class="podium-pillar silver" style="height: 160px;">
                                <div class="bar-content">
                                    <span class="rank-num">2</span>
                                    @if (top3.Count >= 2)
                                    {
                                        <div class="winner-info">
                                            @if(top3[1].EsEquipo && top3[1].NombresMiembros.Any())
                                            {
                                                <div class="team-stack-podium">
                                                    @foreach(var name in top3[1].NombresMiembros.Take(2))
                                                    {
                                                        <span class="winner-name">@name</span>
                                                    }
                                                </div>
                                            }
                                            else
                                            {
                                                <span class="winner-name">@top3[1].NombrePrincipal</span>
                                            }
                                            <span class="winner-score">@top3[1].ScoreTexto</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>

                        @* 1ER LUGAR *@
                        <div class="podium-group slide-up-delay-1">
                            <div class="crown-floating zoom-in-delay"></div>
                            <div class="podium-avatar-box big gold-glow">
                                @if (!string.IsNullOrEmpty(top3.ElementAtOrDefault(0)?.FotoUrl))
                                {
                                    <img src="@top3[0].FotoUrl" class="avatar-circle" @onerror="@(e => top3[0].FotoUrl = null)" />
                                }
                                else
                                {
                                    <div class="medal-placeholder gold-medal"><i class="fas fa-trophy"></i></div>
                                }
                            </div>
                            <div class="podium-pillar gold" style="height: 220px;">
                                <div class="bar-content">
                                    <span class="rank-num">1</span>
                                    @if (top3.Count >= 1)
                                    {
                                        <div class="winner-info main-winner">
                                            @if(top3[0].EsEquipo && top3[0].NombresMiembros.Any())
                                            {
                                                <div class="team-stack-podium">
                                                    @foreach(var name in top3[0].NombresMiembros.Take(2))
                                                    {
                                                        <span class="winner-name">@name</span>
                                                    }
                                                </div>
                                            }
                                            else
                                            {
                                                <span class="winner-name">@top3[0].NombrePrincipal</span>
                                            }
                                            <span class="winner-score main-score">@top3[0].ScoreTexto</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>

                        @* 3ER LUGAR *@
                        <div class="podium-group slide-up-delay-3">
                            <div class="podium-avatar-box bronze-glow">
                                @if (!string.IsNullOrEmpty(top3.ElementAtOrDefault(2)?.FotoUrl))
                                {
                                    <img src="@top3[2].FotoUrl" class="avatar-circle" @onerror="@(e => top3[2].FotoUrl = null)" />
                                }
                                else
                                {
                                    <div class="medal-placeholder bronze-medal"><i class="fas fa-medal"></i></div>
                                }
                            </div>
                            <div class="podium-pillar bronze" style="height: 130px;">
                                <div class="bar-content">
                                    <span class="rank-num">3</span>
                                    @if (top3.Count >= 3)
                                    {
                                        <div class="winner-info">
                                            @if(top3[2].EsEquipo && top3[2].NombresMiembros.Any())
                                            {
                                                <div class="team-stack-podium">
                                                    @foreach(var name in top3[2].NombresMiembros.Take(2))
                                                    {
                                                        <span class="winner-name">@name</span>
                                                    }
                                                </div>
                                            }
                                            else
                                            {
                                                <span class="winner-name">@top3[2].NombrePrincipal</span>
                                            }
                                            <span class="winner-score">@top3[2].ScoreTexto</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                @* --- THE PACK (RESTO DE ATLETAS) --- *@
                @if(restoList.Count > 0)
                {
                    <div class="the-rest-area slide-in-right-delay">
                        <div class="rest-header">THE PACK</div>
                        <div class="rest-list scroll-custom">
                            @foreach(var item in restoList)
                            {
                                <div class="rest-row">
                                    <span class="rest-rank">#@item.Posicion</span>
                                    <div class="rest-info">
                                         @if(item.EsEquipo && item.NombresMiembros.Any())
                                         {
                                              <div class="rest-stack-names">
                                                   @foreach(var name in item.NombresMiembros) 
                                                   {
                                                       <span class="rest-name">@name</span>
                                                   }
                                              </div>
                                         }
                                         else
                                         {
                                              <span class="rest-name">@item.NombrePrincipal</span>
                                         }
                                    </div>
                                    <span class="rest-score">@item.ScoreTexto</span>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
}

<style>
    /* --- ESTILOS GENERALES --- */
    .resumen-container { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #0d0d0d; color: white; display: flex; justify-content: center; align-items: center; z-index: 1; padding: 10px; }
    .resumen-card { background: #1a1a1a; width: 90%; max-width: 500px; border-radius: 20px; padding: 20px; text-align: center; border: 2px solid #F8C545; box-shadow: 0 0 50px rgba(248, 197, 69, 0.2); display: flex; flex-direction: column; max-height: 90vh; height: auto; }
    .header-resumen { flex-shrink: 0; }
    .header-resumen h2 { font-family: 'Oswald'; margin-bottom: 10px; color: white; font-size: 1.5rem; }
    .attendance-list { flex-grow: 1; overflow-y: auto; min-height: 0; margin-bottom: 15px; padding-right: 5px; border-top: 1px solid #333; border-bottom: 1px solid #333; }
    .footer-actions { flex-shrink: 0; }
    .scroll-custom::-webkit-scrollbar { width: 5px; } .scroll-custom::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }

    /* ESTILOS SWITCH CATEGORIA */
    .category-switch-area { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 15px; background: rgba(255,255,255,0.05); padding: 8px; border-radius: 10px; }
    .lbl-cat { font-size: 0.9rem; color: #F8C545; font-family: 'Oswald'; }
    .switch-cat { position: relative; display: inline-block; width: 40px; height: 22px; }
    .switch-cat input { opacity: 0; width: 0; height: 0; }
    .slider-cat { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 34px; }
    .slider-cat:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider-cat { background-color: #F8C545; }
    input:checked + .slider-cat:before { transform: translateX(18px); background-color: black; }

    /* ESTILOS BOTONES CATEGORIA (MODAL) */
    .cat-buttons-grid { display: flex; flex-direction: column; gap: 10px; }
    .btn-cat-opt { background: #222; border: 1px solid #F8C545; color: white; padding: 12px; border-radius: 8px; font-family: 'Oswald'; font-size: 1.1rem; transition: 0.2s; text-transform: uppercase; }
    .btn-cat-opt:active { background: #F8C545; color: black; transform: scale(0.98); }

    /* ESTILOS BADGE CATEGORIA (EN LISTA) */
    .cat-badge-container { margin-top: 5px; cursor: pointer; display: inline-block; }
    .cat-badge-manual { cursor: pointer; margin-top: 2px; }
    
    .cat-badge-empty, .cat-text-empty { color: #888; font-size: 0.8rem; font-style: italic; border: 1px dashed #666; padding: 2px 8px; border-radius: 4px; font-family: 'Roboto'; }
    .cat-badge-filled, .cat-text-filled { background: #F8C545; color: black; font-weight: bold; font-family: 'Oswald'; font-size: 0.8rem; padding: 2px 8px; border-radius: 4px; letter-spacing: 1px; }

    /* MODO MANUAL */
    .score-toggle { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 15px; cursor: pointer; }
    .score-toggle span { font-size: 0.8rem; font-weight: bold; color: #666; transition: color 0.3s; }
    .score-toggle span.active { color: #F8C545; }
    .toggle-track { width: 50px; height: 26px; background: #333; border-radius: 13px; position: relative; transition: 0.3s; }
    .toggle-track.on { background: #F8C545; }
    .toggle-thumb { width: 20px; height: 20px; background: white; border-radius: 50%; position: absolute; top: 3px; left: 3px; transition: 0.3s; }
    .toggle-track.on .toggle-thumb { transform: translateX(24px); }
    .user-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 5px; }
    .user-left { display: flex; align-items: center; gap: 10px; flex: 1; min-width: 0; }
    
    .avatar-list-img, .avatar-list-letter, .avatar-tiny, .avatar-tiny-letter, .avatar-small, .avatar-small-letter { border-radius: 50% !important; object-fit: cover; display: flex; justify-content: center; align-items: center; font-weight: bold; font-family: 'Oswald'; flex-shrink: 0; aspect-ratio: 1/1; }
    .avatar-list-img { width: 35px; height: 35px; border: 2px solid #F8C545; }
    .avatar-list-letter { width: 35px; height: 35px; background: #333; color: #F8C545; border: 2px solid #F8C545; font-size: 1.1rem; }
    .text-truncate { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 140px; font-size: 0.9rem; }
    .score-input-wrapper { display: flex; align-items: center; gap: 5px; animation: fadeIn 0.3s; }
    .input-reps { width: 60px; background: #222; border: 1px solid #F8C545; color: white; text-align: center; padding: 4px; border-radius: 5px; font-weight: bold; font-size: 1rem; }

    /* MODO JUEZ */
    .mode-badge { background: #F8C545; color: black; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-family: 'Oswald'; font-size: 0.9rem; margin-bottom: 10px; display: inline-block; letter-spacing: 1px; }
    .table-results { width: 100%; border-collapse: collapse; margin-top: 5px; }
    .table-results th { text-align: left; color: #888; font-size: 0.8rem; padding-bottom: 5px; border-bottom: 1px solid #444; font-family: 'Oswald'; letter-spacing: 1px; }
    .table-results td { padding: 8px 5px; border-bottom: 1px solid #222; color: white; font-size: 0.9rem; vertical-align: middle; }
    .team-group { display: flex; flex-direction: column; align-items: flex-start; }
    .team-members { display: flex; flex-direction: column; gap: 4px; margin-top: 2px; }
    .mini-row { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: #ddd; }
    .avatar-tiny { width: 24px; height: 24px; border: 1px solid #666; }
    .avatar-tiny-letter { width: 24px; height: 24px; border: 1px solid #666; background: #333; color: white; font-size: 0.75rem; }
    .individual-row { display: flex; align-items: center; gap: 10px; }
    .avatar-small { width: 32px; height: 32px; border: 1px solid #F8C545; }
    .avatar-small-letter { width: 32px; height: 32px; border: 1px solid #F8C545; background: #333; color: white; font-size: 0.9rem; }
    .result-box { padding: 4px 8px; border-radius: 5px; font-family: 'Oswald'; text-align: center; font-weight: bold; min-width: 70px; font-size: 0.9rem; }
    .result-box.done { background: rgba(40, 167, 69, 0.2); color: #28a745; border: 1px solid #28a745; text-shadow: 0 0 5px rgba(40, 167, 69, 0.5); }
    .result-box.pend { background: #222; color: #666; border: 1px solid #444; }

    .btn-close-session { width: 100%; padding: 12px; border-radius: 50px; border: none; background: #F8C545; color: black; font-weight: bold; font-family: 'Oswald'; font-size: 1.1rem; cursor: pointer; transition: 0.2s; }
    .btn-close-session:hover { transform: scale(1.02); box-shadow: 0 0 15px rgba(248, 197, 69, 0.4); }
    .btn-close-session:disabled { background: #555; color: #888; cursor: not-allowed; transform: none; box-shadow: none; }

    /* PODIO */
    .podium-overlay, .modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.9); z-index: 5000; display: flex; justify-content: center; align-items: center; }
    .podium-overlay { background: radial-gradient(circle at center, #222 0%, #000 100%); }
    .custom-modal { background: #111; width: 90%; max-width: 500px; border-radius: 10px; border: 1px solid #333; display: flex; flex-direction: column; overflow: hidden; }
    .modal-header { height: auto; padding: 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
    .modal-body { padding: 15px; overflow-y: auto; flex: 1; }
    .btn-icon-header { background: none; border: none; color: #888; font-size: 1rem; cursor: pointer; }

    .victory-bg-effect { position: absolute; width: 100%; height: 100%; opacity: 0.1; background-image: repeating-linear-gradient(45deg, #333 0, #333 1px, transparent 0, transparent 50%); z-index: -1; }
    .btn-close-overlay { position: absolute; top: 25px; right: 25px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); color: white; font-size: 1.5rem; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; z-index: 5001; display: flex; justify-content: center; align-items: center; transition: 0.3s; }
    .btn-close-overlay:hover { background: #F8C545; color: black; transform: rotate(90deg); border-color: #F8C545; }
    
    .victory-container { 
        width: 100%; max-width: 1200px; 
        display: flex; flex-direction: column; align-items: center; 
        z-index: 1; height: 100vh; 
        /* Cambiado: Usamos flex-end para asegurar que llegue abajo en móviles */
        justify-content: flex-end; 
        padding-bottom: 50px; /* Safe area del fondo */
        padding-top: 60px;
    }

    .victory-layout-main { 
        display: flex; flex-direction: row; gap: 40px; 
        width: 100%; 
        height: 100%; /* Ocupar todo el espacio disponible */
        align-items: flex-end; /* Alinear al fondo en escritorio */
        justify-content: center; 
    }

    .podium-area { display: flex; justify-content: center; align-items: flex-end; height: 100%; }
    .podium-stage { display: flex; align-items: flex-end; gap: 15px; }
    .podium-group { display: flex; flex-direction: column; align-items: center; position: relative; width: 100px; }
    .podium-avatar-box { width: 70px; height: 70px; margin-bottom: -15px; z-index: 20; border-radius: 50%; border: 4px solid white; background: #111; display: flex; justify-content: center; align-items: center; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.5); flex-shrink: 0; }
    .podium-avatar-box.big { width: 95px; height: 95px; margin-bottom: -20px; border-width: 5px; }
    .avatar-circle { width: 100%; height: 100%; object-fit: cover; aspect-ratio: 1/1; }
    .medal-placeholder { font-size: 2rem; display: flex; justify-content: center; align-items: center; width: 100%; height: 100%; }
    .gold-medal { background: #FFD700; color: #5c4500; } .silver-medal { background: #E0E0E0; color: #555; } .bronze-medal { background: #CD7F32; color: #3e1f00; }
    .gold-glow { border-color: #FFD700; box-shadow: 0 0 30px rgba(255, 215, 0, 0.6); } .silver-glow { border-color: #E0E0E0; box-shadow: 0 0 25px rgba(224, 224, 224, 0.5); } .bronze-glow { border-color: #CD7F32; box-shadow: 0 0 25px rgba(205, 127, 50, 0.5); }
    .rank-num { position: absolute; top: 5px; font-size: 4rem; font-weight: 900; opacity: 0.2; font-family: 'Oswald'; color: black; mix-blend-mode: overlay; pointer-events: none; }
    .podium-pillar { width: 100%; border-radius: 10px 10px 0 0; display: flex; flex-direction: column; justify-content: flex-end; position: relative; overflow: visible; }
    .bar-content { width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; padding-bottom: 10px; }
    .gold { background: linear-gradient(180deg, #FFD700 0%, #B8860B 100%); border: 2px solid #FFF8DC; box-shadow: 0 0 40px rgba(255, 215, 0, 0.4); z-index: 10; }
    .silver { background: linear-gradient(180deg, #E0E0E0 0%, #7f8c8d 100%); border: 2px solid #FFF; }
    .bronze { background: linear-gradient(180deg, #CD7F32 0%, #8B4513 100%); border: 2px solid #FFDAB9; }
    .winner-info { z-index: 50; text-align: center; width: 100%; padding: 0 2px; display: flex; flex-direction: column; align-items: center; justify-content: center; margin-top: 10px; }
    .winner-name { display: block; font-family: 'Oswald'; font-size: 0.85rem; font-weight: 800; color: white; text-transform: uppercase; line-height: 1; margin-bottom: 2px; text-shadow: 0 0 3px #000, 0 0 3px #000; }
    .main-winner .winner-name { font-size: 1rem; }
    .winner-score { display: block; font-family: 'Oswald'; font-size: 1.2rem; font-weight: 900; color: white; text-shadow: 0 0 3px #000, 0 0 3px #000; margin-top: 5px; }
    .main-score { font-size: 1.5rem; }
    .team-stack-podium { display: flex; flex-direction: column; align-items: center; }
    .crown-floating { position: absolute; top: -50px; font-size: 2.5rem; color: #FFD700; animation: float 3s infinite ease-in-out; filter: drop-shadow(0 0 10px gold); z-index: 50; }
    
    .the-rest-area { 
        min-width: 260px; max-width: 320px; 
        height: 300px; 
        background: rgba(30,30,30,0.7); 
        border-radius: 15px; 
        border: 1px solid rgba(255,255,255,0.1); 
        display: flex; flex-direction: column; 
        overflow: hidden; 
        margin-bottom: 20px; /* Separación estándar en escritorio */
        backdrop-filter: blur(10px); 
    }
    .rest-header { background: rgba(248, 197, 69, 0.1); padding: 10px; text-align: center; color: #F8C545; font-family: 'Oswald'; font-weight: bold; letter-spacing: 1px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .rest-list { flex: 1; overflow-y: auto; padding: 5px; }
    .rest-row { display: flex; align-items: center; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .rest-rank { font-family: 'Oswald'; font-weight: bold; color: #666; width: 30px; font-size: 1rem; }
    .rest-info { flex: 1; overflow: hidden; display: flex; flex-direction: column; justify-content: center; }
    .rest-stack-names { display: flex; flex-direction: column; line-height: 1.1; }
    .rest-name { color: #ddd; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-family: 'Roboto'; font-weight: 500; }
    .rest-score { font-family: 'Oswald'; font-weight: bold; color: #F8C545; font-size: 0.95rem; }

    .fade-in { animation: fadeIn 0.6s forwards; }
    .slide-up-delay-1 { animation: slideUpAvatar 0.8s 0.5s forwards; opacity: 0; transform: translateY(100px); }
    .slide-up-delay-2 { animation: slideUpAvatar 0.8s 1s forwards; opacity: 0; transform: translateY(100px); }
    .slide-up-delay-3 { animation: slideUpAvatar 0.8s 1.2s forwards; opacity: 0; transform: translateY(100px); }
    .slide-in-right-delay { animation: slideInRight 0.6s 0.8s backwards; }
    .zoom-in-delay { animation: zoomIn 0.6s 1.8s backwards; }
    
    @@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @@keyframes slideUpAvatar { to { opacity: 1; transform: translateY(0); } }
    @@keyframes slideInRight { from { transform: translateX(50px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @@keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    @@keyframes float { 0% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-15px) rotate(2deg); } 100% { transform: translateY(0) rotate(0deg); } }
    
    @@media (max-width: 850px) {
        .victory-layout-main { 
            flex-direction: column; 
            align-items: center; 
            justify-content: flex-start; /* Empezar desde arriba */
            height: 100%; 
            overflow-y: auto; 
            padding-bottom: 80px; /* Espacio extra abajo */
        }
        
        .podium-area { 
            width: 100%; flex: none; height: auto; 
            margin-top: 40px; /* Bajar un poco el podio */
            margin-bottom: 20px; 
        }
        
        .the-rest-area { 
            width: 90%; 
            height: 250px; 
            flex: none; 
            margin-top: auto; /* ESTO ES LA CLAVE: Empuja la lista al fondo del contenedor */
            margin-bottom: 0;
        }
    }
</style>

@code {
    class AtletaResumen { 
        public Guid UsuarioId; public Guid BoxId; public string NombreCompleto; public string FotoUrl; public int Reps; 
        public string Categoria; // Nuevo campo local
    }
    
    class PodiumItem { public string NombrePrincipal; public List<string> NombresMiembros = new(); public bool EsEquipo; public string FotoUrl; public string ScoreTexto; public int Posicion; public double ValorOrdenamiento; }
    
    public class GuardarResultadosDto
    {
        public Guid BoxId { get; set; }
        public Guid WodId { get; set; }
        public List<ResultadoAtletaDto> Resultados { get; set; } = new();
    }

    public class ResultadoAtletaDto
    {
        public Guid UsuarioUnoId { get; set; }
        public Guid? UsuarioDosId { get; set; }
        public bool EsEquipo { get; set; }
        public string TiempoFinal { get; set; }
        public int Reps { get; set; }
        public string NombreEquipo { get; set; }
        public string Categoria { get; set; } // <--- DATO A ENVIAR
    }

    private List<AtletaResumen> listaLocal = new();
    private bool modoScore = false;
    private bool guardando = false;
    private bool mostrarPodio = false;
    private List<PodiumItem> top3 = new();
    private List<PodiumItem> restoList = new();

    // --- NUEVAS VARIABLES PARA MODAL CATEGORÍA ---
    private bool usarCategorias = false; 
    private Dictionary<Guid, string> categoriasJuezSeleccionadas = new();
    private bool mostrarModalCategoria = false;
    private Guid idAtletaEditandoCategoria = Guid.Empty; // Para saber a quién le asignamos
    private bool esModoJuezEditando = false; // Para saber si editamos en lista juez o lista manual

    protected override void OnInitialized()
    {
        if (!LiveState.FueModoJuez) {
            listaLocal = LiveState.AtletasEnClase.Select(a => new AtletaResumen { UsuarioId = a.UsuarioId, BoxId = a.BoxId, NombreCompleto = a.NombreCompleto, FotoUrl = a.FotoUrl, Reps = 0, Categoria = "" }).ToList();
        }
    }

    // --- LOGICA MODAL CATEGORÍA ---
    private void AbrirModalCategoria(Guid id, bool esJuez)
    {
        idAtletaEditandoCategoria = id;
        esModoJuezEditando = esJuez;
        mostrarModalCategoria = true;
    }

    private void AsignarCategoria(string cat)
    {
        if (esModoJuezEditando)
        {
            if(categoriasJuezSeleccionadas.ContainsKey(idAtletaEditandoCategoria)) 
                categoriasJuezSeleccionadas[idAtletaEditandoCategoria] = cat;
            else 
                categoriasJuezSeleccionadas.Add(idAtletaEditandoCategoria, cat);
        }
        else
        {
            var atleta = listaLocal.FirstOrDefault(x => x.UsuarioId == idAtletaEditandoCategoria);
            if(atleta != null) atleta.Categoria = cat;
        }
        mostrarModalCategoria = false;
    }

private async Task ProcesarYGuardar()
{
    guardando = true;
    StateHasChanged();

    // Preparamos el payload base
    var payload = new GuardarResultadosDto { BoxId = Sesion.Usuario.BoxID, WodId = Guid.Empty };

    // CASO 1: MODO JUEZ (Tiempos capturados en vivo)
    if (LiveState.FueModoJuez)
    {
        foreach (var item in LiveState.ResultadosJuez)
        {
            string cat = "";
            if(categoriasJuezSeleccionadas.ContainsKey(item.Atletas[0].UsuarioId)) 
                cat = categoriasJuezSeleccionadas[item.Atletas[0].UsuarioId];
            
            if (usarCategorias && string.IsNullOrEmpty(cat)) cat = "Sin asignar";
            if (!usarCategorias) cat = "";

            payload.Resultados.Add(new ResultadoAtletaDto
            {
                UsuarioUnoId = item.Atletas[0].UsuarioId,
                UsuarioDosId = (item.Atletas.Count > 1) ? item.Atletas[1].UsuarioId : null,
                EsEquipo = (item.Atletas.Count > 1),
                TiempoFinal = item.Finalizado ? item.TiempoFinal : "DNF",
                Reps = 0,
                NombreEquipo = item.NombreEquipo ?? "Equipo",
                Categoria = cat
            });
        }
    }
    // CASO 2: MODO LISTA (Manual)
    else
    {
        // Recorremos TODOS los atletas de la lista local
        foreach (var item in listaLocal)
        {
            string cat = item.Categoria;
            if (usarCategorias && string.IsNullOrEmpty(cat)) cat = "Sin asignar";
            if (!usarCategorias) cat = "";

            // Lógica para definir si es "Solo Asistencia" o "Score"
            // Si modoScore es false, mandamos Reps = 0 y Tiempo = null.
            // El backend detectará esto y solo guardará asistencia.
            
            payload.Resultados.Add(new ResultadoAtletaDto
            {
                UsuarioUnoId = item.UsuarioId,
                EsEquipo = false,
                Reps = modoScore ? item.Reps : 0, // Si no es modo score, va 0
                TiempoFinal = null, // Siempre null en modo manual por reps
                NombreEquipo = "Individual",
                Categoria = cat
            });
        }
    }

    // --- LLAMADA AL API ---
    try
    {
        var url = "https://api-aftrack-mx-fphnazfmahdedtcj.canadacentral-01.azurewebsites.net/api/scoresapi/guardar-clase";
        var response = await Http.PostAsJsonAsync(url, payload);
        
        if (!response.IsSuccessStatusCode)
        {
            Console.WriteLine("Error al guardar en servidor.");
        }
    }
    catch (Exception ex)
    {
        Console.WriteLine($"Error de conexión: {ex.Message}");
    }

    // --- DECISIÓN DE NAVEGACIÓN ---
    // Si no hubo competencia (solo asistencia), nos vamos directo a home.
    // Si hubo competencia (Juez o Score Manual > 0), mostramos podio.
    
    bool huboCompetencia = LiveState.FueModoJuez || (modoScore && listaLocal.Any(x => x.Reps > 0));

    if (!huboCompetencia)
    {
        FinalizarNavegacion();
    }
    else
    {
        CalcularPodio();
    }

    guardando = false;
    StateHasChanged();
}

    private void CalcularPodio()
    {
       top3.Clear(); restoList.Clear(); List<PodiumItem> candidatos = new();
       if (LiveState.FueModoJuez) {
             var terminados = LiveState.ResultadosJuez.Where(x => x.Finalizado).ToList();
             foreach(var r in terminados) {
                 double segundos = 99999;
                 if(!string.IsNullOrEmpty(r.TiempoFinal)) { var parts = r.TiempoFinal.Split(':'); if(parts.Length == 2) segundos = (int.Parse(parts[0])*60) + int.Parse(parts[1]); }
                 var item = new PodiumItem { EsEquipo = r.Atletas.Count > 1, FotoUrl = r.Atletas[0].FotoUrl, ScoreTexto = r.TiempoFinal, ValorOrdenamiento = segundos };
                 if (item.EsEquipo) item.NombresMiembros = r.Atletas.Select(a => a.NombreCompleto.Split(' ')[0]).ToList();
                 else item.NombrePrincipal = r.Atletas[0].NombreCompleto.Split(' ')[0];
                 candidatos.Add(item);
             }
             candidatos = candidatos.OrderBy(x => x.ValorOrdenamiento).ToList();
       } else {
             var origen = listaLocal.Where(x => x.Reps > 0).ToList();
             if(!origen.Any() && listaLocal.Any()) origen = listaLocal.Take(5).ToList(); 
             foreach(var a in origen) {
                 candidatos.Add(new PodiumItem { EsEquipo = false, NombrePrincipal = a.NombreCompleto.Split(' ')[0], FotoUrl = a.FotoUrl, ScoreTexto = $"{a.Reps} REPS", ValorOrdenamiento = a.Reps });
             }
             candidatos = candidatos.OrderByDescending(x => x.ValorOrdenamiento).ToList();
       }

       if (candidatos.Count > 0) {
            for(int i=0; i<candidatos.Count; i++) {
                candidatos[i].Posicion = i + 1;
                if(i < 3) top3.Add(candidatos[i]); else restoList.Add(candidatos[i]);
            }
            mostrarPodio = true;
       } else { FinalizarNavegacion(); }
    }

    private void FinalizarNavegacion() { LiveState.AtletasEnClase.Clear(); LiveState.ResultadosJuez.Clear(); LiveState.FueModoJuez = false; Nav.NavigateTo("/home"); }
}