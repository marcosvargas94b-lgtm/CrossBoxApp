@page "/se-entreno"
@using CrossBoxApp.Models
@using CrossBoxApp.Models.Services
@using System.Net.Http.Headers
@inject NavigationManager Nav
@inject HttpClient Http
@inject SesionService Sesion

<div class="top-navbar">
    <div class="nav-left" @onclick="Volver">
        <i class="fas fa-arrow-left"></i> VOLVER
    <div class="nav-title">SE ENTRENÓ</div>
    <div class="nav-right"></div>
</div>

<div class="feed-container">

    @if (!yaSubiFotoHoy)
    {
        <div class="upload-card">
            <h3>¡Presume tu entreno!</h3>
            <p>Sube tu foto de hoy para ganar Likes.</p>

            @* <label class="image-preview-area">
                <InputFile OnChange="CargarPreview" accept=".jpg,.jpeg,.png" style="display:none;" />

                @if (string.IsNullOrEmpty(previewLocal))
                {
                    <i class="fas fa-camera camera-icon"></i>
                    <span>Toca aquí para subir foto</span>
                }
                else
                {
                    <img src="@previewLocal" class="img-fluid rounded" style="max-height: 100%; max-width: 100%; object-fit: contain;" />
                }
            </label> *@
            <div class="image-preview-area" @onclick="SeleccionarFotoFeed">
             @if (string.IsNullOrEmpty(previewLocal))
             {
                 <i class="fas fa-camera camera-icon"></i>
                 <span>Toca aquí para subir foto</span>
             }
             else
             {
                 <img src="@previewLocal" class="img-fluid rounded" ... />
             }
            </div>

            <input type="text" @bind="descripcion" class="input-dark mt-2" placeholder="Comentario (opcional)..." />

            @if (!string.IsNullOrEmpty(previewLocal))
            {
                <button class="btn-subir mt-2" @onclick="SubirFoto" disabled="@subiendo">
                    @(subiendo ? "SUBIENDO..." : "PUBLICAR AHORA")
                </button>
            }
        </div>
    }
    else
    {
        <div class="alert-success-custom">
            <i class="fas fa-check-circle"></i> Ya cumpliste hoy. ¡Mira a los demás!
        </div>
    }

    <hr class="divider" />

    @if (feed == null)
    {
        <div class="text-center mt-5"><div class="spinner-border text-warning"></div></div>
    }
    else if (feed.Count == 0)
    {
        <div class="text-center text-muted mt-5">Nadie ha subido fotos hoy. ¡Sé el primero!</div>
    }
    else
    {
        <div class="feed-list">
            @foreach (var item in feed)
            {
                <div class="feed-card">
                    <div class="feed-header">
                        <img src="@(item.FotoPerfilUsuario ?? "imagenes/Rhino.png")" class="avatar-small" />
                        <span class="feed-username">@item.NombreUsuario</span>
                    </div>

                    <img src="@item.FotoUrl" class="feed-image" />

                    <div class="feed-footer">
                        <div class="actions">
                            <button class="btn-like @(item.YaDiLike ? "liked" : "")"
                                    @onclick="() => DarLike(item)"
                                    disabled="@item.YaDiLike">
                                <i class="fas fa-heart"></i> @item.Likes
                            </button>
                        </div>
                        @if (!string.IsNullOrEmpty(item.Descripcion))
                        {
                            <p class="feed-desc"><strong>@item.NombreUsuario</strong> @item.Descripcion</p>
                        }
                    </div>
                </div>
            }
        </div>
    }
</div>

<style>
    /* Estilos Generales */
 .top-navbar {
        display: flex; 
        justify-content: space-between; 
        align-items: center;
        padding: 15px; 
        background: #1a1a1a; 
        border-bottom: 2px solid #F8C545;
        color: white; 
        font-family: 'Oswald';
        position: relative; 
    }

    .nav-title {
        position: absolute; /* Lo sacamos del flujo normal */
        left: 50%; /* Lo mandamos a la mitad */
        transform: translateX(-50%); /* Lo ajustamos para que su propio centro sea el eje */
        font-size: 1.2rem; /* Un poco más grande para que luzca */
        font-weight: bold;
        color: white;
        text-transform: uppercase;
    }
    .nav-left {
        color: #F8C545; /* Amarillo ALFA */
        font-weight: bold;
        font-size: 0.9rem; /* Un poco más pequeño si el texto es largo */
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .feed-container {
        padding: 15px;
        background: #0d0d0d;
        min-height: 100vh;
        color: white;
        padding-bottom: 50px;
    }

    /* Upload Section */
    .upload-card {
        background: #1a1a1a;
        padding: 15px;
        border-radius: 10px;
        border: 1px dashed #F8C545;
        text-align: center;
        margin-bottom: 20px;
    }

    /* El área de carga ahora es un label cursor pointer */
    .image-preview-area {
        background: #222;
        height: 150px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        cursor: pointer; /* Manita al pasar mouse */
        border-radius: 8px;
        overflow: hidden;
        border: 2px solid transparent;
        transition: border-color 0.3s;
        width: 100%; /* Asegurar que ocupe el ancho */
    }

        .image-preview-area:active {
            border-color: #F8C545;
        }
    /* Feedback visual al tocar */

    .camera-icon {
        font-size: 2rem;
        color: #F8C545;
        margin-bottom: 5px;
    }

    .btn-subir {
        width: 100%;
        background: #F8C545;
        border: none;
        padding: 10px;
        font-weight: bold;
        border-radius: 5px;
        color: black;
    }

    .input-dark {
        width: 100%;
        background: #333;
        border: none;
        color: white;
        padding: 8px;
        border-radius: 5px;
    }

    .alert-success-custom {
        background: rgba(40, 167, 69, 0.2);
        color: #28a745;
        padding: 10px;
        border-radius: 8px;
        text-align: center;
        border: 1px solid #28a745;
    }

    /* Feed Card Styles */
    .feed-card {
        background: #1a1a1a;
        border-radius: 12px;
        margin-bottom: 25px;
        overflow: hidden;
        border: 1px solid #333;
    }

    .feed-header {
        padding: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .avatar-small {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #F8C545;
    }

    .feed-username {
        font-family: 'Oswald';
        font-size: 1rem;
        color: #F8C545;
    }

    .feed-image {
        width: 100%;
        height: auto;
        display: block;
        max-height: 400px;
        object-fit: cover;
    }

    .feed-footer {
        padding: 10px;
    }

    .btn-like {
        background: none;
        border: 1px solid #555;
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        transition: all 0.3s;
    }

        .btn-like i {
            margin-right: 5px;
        }

        .btn-like.liked {
            background: #e0245e;
            border-color: #e0245e;
            color: white;
            opacity: 1;
        }

    .feed-desc {
        font-size: 0.9rem;
        margin-top: 8px;
        color: #ccc;
    }
</style>

@code {
    private bool yaSubiFotoHoy = false;
    private List<FotoFeedDto> feed;
    // Eliminé la variable 'inputFile' que ya no usamos
    private IBrowserFile archivoSeleccionado;
    private string previewLocal;
    private string descripcion;
    private bool subiendo = false;
    private FileResult fotoFeedNativa;

    private async Task SeleccionarFotoFeed()
    {
        if (!await VerificarPermisosGaleria()) return;

        try
        {
            var foto = await MediaPicker.Default.PickPhotoAsync();
            if (foto != null)
            {
                using var stream = await foto.OpenReadAsync();
                var ms = new MemoryStream();
                await stream.CopyToAsync(ms);
                
                // Preview
                previewLocal = $"data:image/jpeg;base64,{Convert.ToBase64String(ms.ToArray())}";
                
                // Guardar referencia
                fotoFeedNativa = foto;
            }
        }
        catch { }
    }

    private async Task<bool> VerificarPermisosGaleria()
    {
        // 1. Verificamos el estado actual
        var estado = await Permissions.CheckStatusAsync<Permissions.Photos>();

        // 2. Si no tenemos permiso, lo pedimos
        if (estado != PermissionStatus.Granted)
        {
            estado = await Permissions.RequestAsync<Permissions.Photos>();
        }

        // 3. Si el usuario dijo que NO
        if (estado != PermissionStatus.Granted)
        {
            await App.Current.MainPage.DisplayAlert("Permiso Requerido", "Necesitamos acceso a tus fotos para subir tu evidencia.", "Entendido");
            return false;
        }

        return true;
    }

    protected override async Task OnInitializedAsync()
    {
        await VerificarPermisosGaleria();
        await CargarFeed();
    }

    private async Task CargarFeed()
    {
        if (Sesion.Usuario == null) return;
        try
        {
            var response = await Http.GetAsync($"https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/SocialApi/feed/{Sesion.Usuario.UsuarioID}");
            if (response.IsSuccessStatusCode)
            {
                var data = await response.Content.ReadFromJsonAsync<FeedResponse>();
                yaSubiFotoHoy = data.yaSubi;
                feed = data.lista;
            }
        }
        catch { }
    }

    // ELIMINÉ el método TriggerInput porque con el <label> ya no es necesario

    private async Task CargarPreview(InputFileChangeEventArgs e)
    {
        var archivo = e.File;
        if (archivo != null)
        {
            archivoSeleccionado = archivo;
            var format = "image/jpeg";
            // Reducimos a 800px para que suba rápido
            var resized = await archivo.RequestImageFileAsync(format, 800, 800);
            var buffer = new byte[resized.Size];
            await resized.OpenReadStream().ReadAsync(buffer);
            previewLocal = $"data:{format};base64,{Convert.ToBase64String(buffer)}";
        }
    }

    private async Task SubirFoto()
    {
        subiendo = true;
        try
        {
            var content = new MultipartFormDataContent();
            content.Add(new StringContent(Sesion.Usuario.UsuarioID.ToString()), "UsuarioID");
            content.Add(new StringContent(descripcion ?? ""), "Descripcion");

           if (fotoFeedNativa != null)
        {
            using var stream = await fotoFeedNativa.OpenReadAsync();
            var fileContent = new StreamContent(stream);
            fileContent.Headers.ContentType = new MediaTypeHeaderValue(fotoFeedNativa.ContentType);
            content.Add(fileContent, "archivoFoto", fotoFeedNativa.FileName);
        }

            var resp = await Http.PostAsync("https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/SocialApi/subir", content);
            if (resp.IsSuccessStatusCode)
            {
                await CargarFeed();
                previewLocal = null;
                descripcion = "";
            }
        }
        catch (Exception ex) { await App.Current.MainPage.DisplayAlert("Error", ex.Message, "OK"); }
        finally { subiendo = false; }
    }

    private async Task DarLike(FotoFeedDto foto)
    {
        if (foto.YaDiLike) return;
        foto.YaDiLike = true;
        foto.Likes++;

        try
        {
            var req = new LikeRequest { FotoID = foto.FotoDiaID, LikerID = Sesion.Usuario.UsuarioID };
            var resp = await Http.PostAsJsonAsync("https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/SocialApi/darlike", req);

            if (!resp.IsSuccessStatusCode)
            {
                foto.YaDiLike = false;
                foto.Likes--;
            }
        }
        catch { foto.YaDiLike = false; foto.Likes--; }
    }

    private void Volver() => Nav.NavigateTo("/home");

    public class FeedResponse { public bool yaSubi { get; set; } public List<FotoFeedDto> lista { get; set; } }
    public class LikeRequest { public Guid FotoID { get; set; } public Guid LikerID { get; set; } }
}