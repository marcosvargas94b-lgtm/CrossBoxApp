@page "/evaluaciones/{UsuarioId:guid}/{NombreAtleta}"
@using CrossBoxApp.Models
@using CrossBoxApp.Models.Services
@inject NavigationManager Nav
@inject HttpClient Http
@inject SesionService Sesion

<div class="top-navbar">
    <div class="nav-left" @onclick="Volver"><i class="fas fa-arrow-left"></i> VOLVER</div>
    <div class="nav-title">@NombreAtleta.ToUpper()</div>
    <div class="nav-right"></div>
</div>

<div class="eval-container">
    @if (cargando)
    {
        <div class="text-center mt-5"><div class="spinner-border text-warning"></div></div>
    }
    else
    {
        @foreach (var item in listaEvaluaciones)
        {
            <div class="eval-card">
                <div class="card-header-yellow">
                    <span class="test-cat">@item.Categoria.ToUpper()</span>
                    <span class="test-unit">@item.Medida</span>
                </div>

                <div class="card-body-dark">
                    <div class="test-name">@item.NombreTest</div>

                    <div class="result-area">
                        @if (item.Valor.HasValue)
                        {
                            <div class="result-display">
                                <div class="value-row">
                                    <span class="result-value">@item.Valor</span>
                                    <span class="result-unit">@item.Medida</span>
                                </div>

                                <span class="result-date">@item.Fecha?.ToShortDateString()</span>
                            </div>
                            <div class="action-buttons">

                                <button class="btn-icon edit" @onclick="() => AbrirModal(item, esNuevaMarca: false)">
                                    <i class="fas fa-edit"></i>
                                </button>

                                <button class="btn-icon new-record" @onclick="() => AbrirModal(item, esNuevaMarca: true)">
                                    <i class="fas fa-plus-circle"></i> NUEVA MARCA
                                </button>

                                <button class="btn-icon delete" @onclick="() => EliminarResultado(item)">
                                    <i class="fas fa-trash"></i>
                                </button>

                            </div>
                        }
                        else
                        {
                            <button class="btn btn-outline-warning btn-sm w-100" @onclick="() => AbrirModal(item, esNuevaMarca: true)">
                                <i class="fas fa-plus"></i> INGRESAR DATOS
                            </button>
                        }
                    </div>
                </div>
            </div>
        }
    }
</div>

@if (mostrarModal)
{
    <div class="modal fade show" style="display: block; background-color: rgba(0,0,0,0.9); z-index: 2000;" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="background-color: #222; border: 1px solid #F8C545; color: white;">

                <div class="modal-header">
                    <h5 class="modal-title" style="color:#F8C545;">
                        @(testSeleccionado.Valor.HasValue ? "EDITAR" : "NUEVO") REGISTRO
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="() => mostrarModal = false"></button>
                </div>

                <div class="modal-body text-center">

                    <h4 style="color: white; font-family: 'Oswald'; margin-bottom: 20px;">
                        @testSeleccionado.NombreTest
                    </h4>

                    <label style="color: #aaa; margin-bottom: 10px; display: block;">Ingresa tu récord en:</label>

                    <div class="input-with-unit">
                        <input type="number" @bind="valorInput" class="form-control input-dark big-input" placeholder="0" />
                        <span class="unit-label">@testSeleccionado.Medida</span>
                    </div>

                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="() => mostrarModal = false">Cancelar</button>
                    <button class="btn btn-warning" @onclick="GuardarDatos">Guardar</button>
                </div>

            </div>
        </div>
    </div>
}

<style>

    .input-with-unit {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px; /* Espacio entre el numero y la letra */
    }

    .big-input {
        background: #333 !important;
        color: white !important;
        border: 1px solid #F8C545;
        text-align: center;
        font-size: 2rem; /* Número bien grande */
        font-weight: bold;
        width: 120px; /* Ancho fijo para que no se estire demasiado */
        padding: 10px;
        border-radius: 10px;
    }

        .big-input:focus {
            background-color: #444 !important;
            box-shadow: 0 0 10px rgba(248, 197, 69, 0.5); /* Brillo amarillo al escribir */
        }

    /* La etiqueta de la unidad (LB, REPS) */
    .unit-label {
        color: #F8C545;
        font-size: 1.5rem;
        font-family: 'Oswald', sans-serif;
        font-weight: bold;
        text-transform: uppercase;
    }

    .value-row {
        display: flex;
        align-items: baseline; /* Alinea la base del texto */
        gap: 5px; /* Espacio entre número y medida */
    }

    /* El número grande */
    .result-value {
        color: #F8C545;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1;
    }

    /* La medida (LB, Reps) un poco más chica */
    .result-unit {
        color: #F8C545;
        font-size: 1rem; /* Más pequeño que el valor */
        font-weight: bold;
        text-transform: uppercase;
    }

    .result-date {
        color: #666;
        font-size: 0.7rem;
        margin-top: 2px;
    }

    .top-navbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background: #1a1a1a;
        border-bottom: 2px solid #F8C545;
        color: white;
        font-family: 'Oswald';
    }

    .nav-left {
        color: #F8C545;
        cursor: pointer;
    }

    .eval-container {
        padding: 15px;
        background: #0d0d0d;
        min-height: 100vh;
    }

    .eval-card {
        border: 1px solid #333;
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 15px;
    }

    .card-header-yellow {
        background-color: #F8C545;
        padding: 5px 10px;
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
        font-weight: bold;
        color: black;
    }

    .card-body-dark {
        background-color: #1a1a1a;
        padding: 15px;
    }

    .test-name {
        color: white;
        font-family: 'Oswald';
        font-size: 1.2rem;
        margin-bottom: 10px;
    }

    .result-area {
        display: flex;
        justify-content: space-between;
        align-items: center;
        min-height: 40px;
    }

    .result-display {
        display: flex;
        flex-direction: column;
    }

    .result-value {
        color: #F8C545;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1;
    }

    .result-date {
        color: #666;
        font-size: 0.7rem;
    }

    .action-buttons {
        display: flex;
        gap: 10px;
    }

    .btn-icon {
        background: transparent;
        border: 1px solid #444;
        color: #aaa;
        border-radius: 5px;
        padding: 5px 10px;
    }

        .btn-icon.edit:hover {
            color: #F8C545;
            border-color: #F8C545;
        }

        .btn-icon.delete:hover {
            color: #d9534f;
            border-color: #d9534f;
        }

    .input-dark {
        background: #333 !important;
        color: white !important;
        border: 1px solid #F8C545;
        text-align: center;
        font-size: 1.5rem;
    }

    .btn-icon.new-record {
        color: #28a745; /* Verde */
        border-color: #28a745;
        font-weight: bold;
        font-family: 'Oswald';
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        gap: 5px;
        width: auto; /* Que se adapte al texto */
    }

        .btn-icon.new-record:hover {
            background-color: #28a745;
            color: white;
        }
</style>

@code {
    [Parameter] public Guid UsuarioId { get; set; }
    [Parameter] public string NombreAtleta { get; set; }
    private bool esModoNuevaMarca = false;
    private List<EvaluacionVisualDto> listaEvaluaciones = new List<EvaluacionVisualDto>();
    private bool cargando = true;

    // Variables Modal
    private bool mostrarModal = false;
    private EvaluacionVisualDto testSeleccionado;
    private float valorInput;

    protected override async Task OnInitializedAsync()
    {
        await CargarDatos();
    }

    private async Task CargarDatos()
    {
        try
        {
            cargando = true;
            if (Sesion.Usuario == null) return;

            var boxId = Sesion.Usuario.BoxID;
            var response = await Http.GetAsync($"api/evaluaciones/usuario/{boxId}/{UsuarioId}"); // Usamos el ID del parámetro

            if (response.IsSuccessStatusCode)
            {
                listaEvaluaciones = await response.Content.ReadFromJsonAsync<List<EvaluacionVisualDto>>();
            }
        }
        finally { cargando = false; }
    }

    private void AbrirModal(EvaluacionVisualDto item, bool esNuevaMarca)
    {
        testSeleccionado = item;
        esModoNuevaMarca = esNuevaMarca;

        if (esNuevaMarca)
        {           
            valorInput = 0;
        }
        else
        {           
            valorInput = item.Valor ?? 0;
        }

        mostrarModal = true;
    }

    private async Task GuardarDatos()
    {
        try
        {
            var dto = new GuardarResultadoDto
            {
                TestUsuarioId = testSeleccionado.TestUsuarioId,
                TestBoxId = testSeleccionado.TestBoxId,
                UsuarioId = this.UsuarioId,
                Valor = valorInput,
                EsNuevaMarca = esModoNuevaMarca // <--- ENVIAMOS LA BANDERA
            };
            var response = await Http.PostAsJsonAsync("api/evaluaciones/guardar", dto);
            

            if (response.IsSuccessStatusCode)
            {
                mostrarModal = false;
                await CargarDatos(); // Refrescar para ver el cambio
            }
            else
            {
                await App.Current.MainPage.DisplayAlert("Error", "No se pudo guardar", "OK");
            }
        }
        catch (Exception ex)
        {
            await App.Current.MainPage.DisplayAlert("Error", ex.Message, "OK");
        }
    }

    private async Task EliminarResultado(EvaluacionVisualDto item)
    {
        bool confirm = await App.Current.MainPage.DisplayAlert("Eliminar", "¿Borrar este registro?", "Sí", "No");
        if (!confirm || item.TestUsuarioId == null) return;

        var response = await Http.DeleteAsync($"api/evaluaciones/eliminar/{item.TestUsuarioId}");
        if (response.IsSuccessStatusCode) await CargarDatos();
    }

    private void Volver() => Nav.NavigateTo("/usuarios-view");
}