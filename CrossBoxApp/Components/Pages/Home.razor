@page "/home"
@using System.Net.Http.Json
@using CrossBoxApp.Models
@using CrossBoxApp.Models.Social
@using Microsoft.Maui.Devices
@inject NavigationManager Nav
@inject HttpClient Http
@inject CrossBoxApp.Models.Services.SesionService Sesion
@inject IJSRuntime JS

<div class="main-layout">

    @* --- MARCA DE AGUA (FONDO LOGO) --- *@
    @if (LogoBoxId != null)
    {
        <div class="watermark" style="background-image: url('@UrlLogo');"></div>
    }

    @* --- CAPA INVISIBLE PARA CERRAR MENÚS --- *@
    @if (mostrarMenuPrincipal || mostrarNotis)
    {
        <div class="menu-overlay" @onclick="CerrarTodosLosMenus"></div>
    }

    <div class="navbar-container">
        
        @* BRAND: LOGO + NOMBRE *@
        <div class="brand">
            @if (LogoBoxId != null)
            {
                <img src="@UrlLogo" class="nav-logo" />
            }
            <span>@NombreBox</span>
        </div>

        <div class="right-actions">
            
            @* NOTIFICACIONES *@
            <div class="noti-wrapper" @onclick="ToggleNotificaciones">
                <i class="fas fa-bell noti-icon @(hayNuevas ? "bell-ring" : "")"></i>
                @if (hayNuevas) { <span class="noti-dot"></span> }
                
                @if (mostrarNotis)
                {
                    <div class="noti-dropdown" @onclick:stopPropagation="true">
                        @if (misNotificaciones == null || misNotificaciones.Count == 0)
                        {
                            <div class="noti-item empty">Sin novedades...</div>
                        }
                        else
                        {
                            @foreach (var n in misNotificaciones)
                            {
                                <div class="noti-item @(n.Leido ? "" : "unread")">
                                    <i class="@GetIcono(n.Tipo)"></i>
                                    <span class="noti-text">@n.Mensaje</span>
                                </div>
                            }
                        }
                    </div>
                }
            </div>

            @* MENÚ PRINCIPAL *@
            <div class="main-menu-wrapper" @onclick="ToggleMainMenu">
                <span class="user-name">Hola, @(Sesion.Usuario?.Nombre ?? "Atleta")</span>
                <i class="fas fa-bars menu-burger"></i>

                @if (mostrarMenuPrincipal)
                {
                    <div class="main-dropdown" @onclick:stopPropagation="true">
                        <div class="dropdown-header">GENERAL</div>
                        <div class="dropdown-item" @onclick="IrAPerfil">
                            <i class="fas fa-user-edit"></i> Modificar Perfil
                        </div>
                        <div class="dropdown-item" @onclick="AbrirModalPassword">
                            <i class="fas fa-key"></i> Cambiar Contraseña
                        </div>

                        @if (Sesion.Usuario != null && (Sesion.Usuario.TipoUsuarioID == 1 || Sesion.Usuario.TipoUsuarioID == 3))
                        {
                            <div class="dropdown-divider"></div>
                            <div class="dropdown-header admin-header">ADMINISTRACIÓN</div>

                            <div class="dropdown-item" style="color:#d9534f !important;" @onclick='() => Nav.NavigateTo("/live-lobby")'>
                                <i class="fas fa-stopwatch" style="color:#d9534f"></i> LIVE
                            </div>

                            @if (Sesion.TienePermiso("MANAGE_WOD"))
                            {
                                <div class="dropdown-item" @onclick="AbrirModalWod">
                                    <i class="fas fa-hammer"></i> Programar WOD
                                </div>
                                <div class="dropdown-item" @onclick='() => NavegarA("test")'>
                                    <i class="fas fa-flask"></i> Configurar Tests
                                </div>
                                <div class="dropdown-item" @onclick="AbrirModalHorarios">
                                    <i class="fas fa-clock"></i> Gestionar Horarios
                                </div>
                            }

                            @if (Sesion.TienePermiso("MANAGE_USERS"))
                            {
                                <div class="dropdown-item" @onclick='() => NavegarA("usuarios")'>
                                    <i class="fas fa-users"></i> Gestionar Usuarios
                                </div>
                                <div class="dropdown-item" @onclick='() => Nav.NavigateTo("/solicitudes")'>
                                    <i class="fas fa-user-check"></i> Solicitudes de Acceso
                                </div>
                            }

                            @if (Sesion.TienePermiso("MANAGE_AVISOS"))
                            {
                                <div class="dropdown-item" @onclick="AbrirCrearAviso">
                                    <i class="fas fa-bullhorn"></i> Publicar Avisos
                                </div>
                            }

                            @if (EsAdmin)
                            {
                                <div class="dropdown-divider" style="opacity: 0.3;"></div>
                                <div class="dropdown-header" style="color:#F8C545; font-size:0.6rem;">DUEÑO</div>

                                <div class="dropdown-item" @onclick='() => Nav.NavigateTo("/staff-config")'>
                                    <i class="fas fa-id-badge"></i> Gestión de Equipo
                                </div>

                                <div class="dropdown-item" @onclick="AbrirGestionModulos">
                                    <i class="fas fa-toggle-on"></i> Módulos del Box
                                </div>

                                <div class="dropdown-item" @onclick='() => Nav.NavigateTo("/admin/whatsapp")'>
                                    <i class="fas fa-comment-dots"></i> Configurar WhatsApp
                                </div>

                                <div class="dropdown-item" @onclick='() => Nav.NavigateTo("/admin/config-box")'>
                                    <i class="fas fa-cogs"></i> Configurar Box y Pagos
                                </div>
                            }
                        }

                        <div class="dropdown-divider"></div>
                        <div class="dropdown-item text-muted" @onclick="CerrarSesion" style="color: #888 !important;">
                            <i class="fas fa-sign-out-alt" style="color: #888;"></i> Cerrar Sesión
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>

    <div class="scrollable-content">

        @if (diasRestantes <= 3)
        {
            <div class="payment-alert @(diasRestantes <= 0 ? "expired" : "warning")" @onclick="IrAPagar">
                <div class="alert-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="alert-text">
                    @if (diasRestantes > 0)
                    {
                        <strong>¡ATENCIÓN!</strong>
                        <span>Tu plan vence en @diasRestantes días.</span>
                    }
                    else
                    {
                        <strong>¡SERVICIO VENCIDO!</strong>
                        @if (Sesion.Usuario != null && Sesion.Usuario.TipoUsuarioID == 2 && Sesion.Usuario.BoxID != IdCanaHueca)
                        {
                            @if (boxTieneMP)
                            {
                                <span>Toca aquí para pagar en línea o pasar a recepción</span>
                            }
                            else
                            {
                                <span>Acude a tu recepción para pagar.</span>
                            }
                        }
                        else
                        {
                            <span>Toca aquí para pagar en línea.</span>
                        }
                    }
                </div>
            </div>
        }

        <div class="welcome-section">
            <h1>BIENVENIDO @(Sesion.Usuario?.Nombre?.ToUpper() ?? "ATLETA")</h1>
        </div>

        <div class="cards-grid">
            @if (EstaActivo("AGENDA"))
            {
                <div class="menu-card" @onclick="IrAAgenda">
                    <i class="fas fa-dumbbell card-icon"></i>
                    <h3>AGENDA TU CLASE</h3><p>Elige tu horario...</p>
                </div>
            }

            @if (EstaActivo("WOD"))
            {
                <div class="menu-card" @onclick="IrAWodView">
                    <i class="fas fa-chalkboard-teacher card-icon"></i>
                    <h3>WOD</h3><p>@DateTime.Now.ToString("dd/MM/yyyy")</p>
                </div>
            }

            @if (EstaActivo("PROGRESO"))
            {
                <div class="menu-card" @onclick="IrAProgreso">
                    <i class="fas fa-clipboard-list card-icon"></i>
                    <h3>PROGRESO</h3><p>Consulta tus datos</p>
                </div>
            }

            @if (EstaActivo("FOTO"))
            {
                <div class="menu-card" @onclick="IrASeEntreno">
                    <i class="fas fa-fire-alt card-icon" style="color:#d9534f;"></i>
                    <h3>SE ENTRENÓ</h3><p>Sube tu foto</p>
                </div>
            }

            @if (EstaActivo("SOCIAL"))
            {
                <div class="menu-card" @onclick="IrACompaneros">
                    <i class="fas fa-users card-icon" style="color:#00BFFF;"></i>
                    <h3>¡HEY! HOLA</h3><p>Compañeros y MATCHES</p>
                </div>
            }

            @if (EstaActivo("RANKING"))
            {
                <div class="menu-card" @onclick="IrARanking">
                    <i class="fas fa-trophy card-icon" style="color:#FFD700;"></i>
                    <h3>LIKES</h3><p>Líderes</p>
                </div>
            }

            @if (EstaActivo("LEADERBOARD_HOY"))
            {
                <div class="menu-card yellow-highlight" @onclick='() => Nav.NavigateTo("/leaderboard-hoy")'>
                    <i class="fas fa-trophy card-icon"></i>
                    <h3>RESULTADOS</h3>
                    <p>Leaderboard de Hoy</p>
                    <div class="live-badge">HOY</div>
                </div>
            }
            @if (EstaActivo("RUNNING") && tieneRunning)
            {
                <div class="menu-card" @onclick='() => Nav.NavigateTo("/mi-running")'>
                    <i class="fas fa-running card-icon"></i>
                    <h3>MI PLAN RUNNING</h3>
                    <p>Bitácora</p>
                </div>
            }

            @if (tieneRutina)
            {
                <div class="menu-card" @onclick='() => Nav.NavigateTo("/rutina-cliente")'>
                    <i class="fas fa-dumbbell card-icon"></i>
                    <h3>RUTINA PRO</h3>
                    <p>Tu plan personalizado</p>
                </div>
            }

            @if (EstaActivo("IAFUERZA"))
            {
                <div class="menu-card yellow-highlight" @onclick='() => Nav.NavigateTo("/rutina-ia")'>
                    <i class="fas fa-robot card-icon"></i>
                    <h3>ENTRENADOR IA</h3>
                    <p>Crea tu rutina perfecta</p>
                    <div class="live-badge" style="background-color: black; color: #F8C545;">NUEVO</div>
                </div>
            }

            @if (EstaActivo("PROPOSITOS"))
            {
                <div class="menu-card" @onclick='() => Nav.NavigateTo("/mis-propositos")'>
                    <i class="fas fa-bullseye card-icon"></i>
                    <h3>MIS RETOS</h3>
                    <p>Propósitos @DateTime.Now.Year</p>
                </div>
            }

            @if (EstaActivo("QRCLASE"))
            {
                <div class="menu-card yellow-highlight" @onclick="AbrirEscanerParaEntrar" style="position: relative;">
                    @if (abriendoCamara)
                    {
                        <div class="spinner-border text-dark" role="status" style="width: 3rem; height: 3rem;"></div>
                        <p style="margin-top: 10px; font-weight: bold;">Abriendo...</p>
                    }
                    else
                    {
                        <i class="fas fa-qrcode card-icon"></i>
                        <h3>ENTRAR A CLASE</h3>
                        <p>Escanear Pantalla</p>
                    }
                </div>
            }
            @if (EstaActivo("RACHA"))
            {
                <div class="menu-card" @onclick='() => Nav.NavigateTo("/ranking-asistencia")'>
                    <i class="fas fa-calendar-check card-icon" style="color:#FFF;"></i>
                    <h3>ASISTENCIA</h3>
                    <p>Top Anual @DateTime.Now.Year</p>
                </div>
            }
        </div>

        <div class="footer-brand">@NombreBox</div>

        <div class="delete-account-container">
            <button class="btn-delete-account" @onclick="ConfirmarEliminarCuenta">
                Eliminar mi cuenta
            </button>
        </div>

        <div style="height: 40px;"></div>
    </div>
</div>

@* --- MODAL CAMBIAR PASSWORD --- *@
@if (mostrarModalPassword)
{
    <div class="modal-overlay">
        <div class="modal-content custom-modal">
            <div class="modal-header">
                <h5 style="margin:0; color:#F8C545; font-weight:bold; font-family:'Oswald';">
                    <i class="fas fa-lock" style="margin-right:8px;"></i> CAMBIAR CONTRASEÑA
                </h5>
                <button class="btn-close-custom" @onclick="() => mostrarModalPassword = false"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <label class="lbl-input">Contraseña Actual:</label>
                <div class="input-group mb-3">
                    <input type="@tipoInputOld" @bind="passOld" class="form-control input-dark" placeholder="******" />
                    <button class="btn btn-outline-secondary btn-eye" @onclick="() => ToggleVerPass(1)"><i class="fas fa-eye"></i></button>
                </div>

                <label class="lbl-input">Nueva Contraseña:</label>
                <div class="input-group mb-3">
                    <input type="@tipoInputNew" @bind="passNew" class="form-control input-dark" placeholder="******" />
                    <button class="btn btn-outline-secondary btn-eye" @onclick="() => ToggleVerPass(2)"><i class="fas fa-eye"></i></button>
                </div>

                <label class="lbl-input">Confirmar Nueva:</label>
                <div class="input-group mb-3">
                    <input type="@tipoInputConfirm" @bind="passConfirm" class="form-control input-dark" placeholder="******" />
                    <button class="btn btn-outline-secondary btn-eye" @onclick="() => ToggleVerPass(3)"><i class="fas fa-eye"></i></button>
                </div>

                @if (!string.IsNullOrEmpty(msgErrorPass))
                {
                    <div class="alert alert-danger p-2" style="font-size:0.8rem;">@msgErrorPass</div>
                }
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" @onclick="() => mostrarModalPassword = false">Cancelar</button>
                <button class="btn-confirm" @onclick="GuardarNuevaPassword" disabled="@procesandoPass">
                    @if (procesandoPass)
                    {
                        <span><i class="fas fa-spinner fa-spin"></i> Guardando...</span>
                    }
                    else
                    {

                        <span>GUARDAR</span>
                    }
                </button>
            </div>
        </div>
    </div>
}

@* --- MODAL PLANES (ADMIN) --- *@
@if (mostrarModalPlanesAdmin)
{
    <div class="modal-overlay">
        <div class="modal-content custom-modal">
            <div class="modal-header">
                <h5 style="color:#F8C545; margin:0; font-family:'Oswald'; letter-spacing:1px;">ELIGE TU PLAN</h5>
                <button class="btn-close-custom" @onclick="() => mostrarModalPlanesAdmin = false"><i class="fas fa-times"></i></button>
            </div>

            <div class="modal-body text-center">
                <p style="color:#ccc; font-size:0.9rem; margin-bottom:20px;">Selecciona cómo quieres renovar tu servicio:</p>

                <div class="planes-selection-grid">
                    @{
                        var planMes = listaPlanes.FirstOrDefault(p => p.PlanID == 1);
                    }
                    @if (planMes != null)
                    {
                        <div class="plan-option-card" @onclick='() => ProcesarPago("Renta Mensual", planMes.Precio)'>
                            <div class="plan-title">MENSUAL</div>
                            <div class="plan-price">$@planMes.Precio</div>
                            <div class="plan-note">Pago único por 30 días</div>
                        </div>
                    }

                    @{
                        var planAnio = listaPlanes.FirstOrDefault(p => p.PlanID == 2);
                    }
                    @if (planAnio != null)
                    {
                        <div class="plan-option-card recommended" @onclick='() => ProcesarPago("Renta Anual (Ahorro)", planAnio.Precio)'>
                            <div class="badge-save">AHORRA MÁS</div>
                            <div class="plan-title">ANUAL</div>
                            <div class="plan-price">$@planAnio.Precio</div>
                            <div class="plan-note">12 Meses de servicio completo</div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}

@* --- MODAL MODULOS --- *@
@if (mostrarModalModulos)
{
    <div class="modal-overlay">
        <div class="modal-content custom-modal" style="max-height: 80vh;">
            <div class="modal-header">
                <h5 style="margin:0; color:#F8C545; font-weight:bold;">CONFIGURAR MÓDULOS</h5>
                <button class="btn-close-custom" @onclick="() => mostrarModalModulos = false"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" style="overflow-y:auto;">
                <p style="color:#ccc; font-size:0.8rem; margin-bottom:15px;">Apaga los módulos que no quieras que vean tus atletas.</p>
                @if (listaConfiguracion != null)
                {
                    @foreach (var mod in listaConfiguracion)
                    {
                        <div class="module-row" @onclick="() => ToggleModulo(mod)">
                            <span class="mod-name">@mod.NombreVisible</span>
                            <div class="switch-track @(mod.Activo ? "on" : "off")">
                                <div class="switch-thumb"></div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="text-center text-warning">Cargando...</div>
                }
            </div>
            <div class="modal-footer">
                <button class="btn-confirm" @onclick="() => mostrarModalModulos = false">LISTO</button>
            </div>
        </div>
    </div>
}

@* --- MODAL WOD PRINCIPAL --- *@
@if (mostrarModalWod)
{
    <div class="modal-overlay">
        <div class="modal-content custom-modal">

            <div class="modal-header">
                <h5 style="margin:0; color:#F8C545; font-family:'Oswald'">PROGRAMACIÓN WOD</h5>
                <button class="btn-close-custom" @onclick="() => mostrarModalWod = false"><i class="fas fa-times"></i></button>
            </div>

            <div class="modal-body" style="padding-bottom: 50px;">
                <div class="mb-4">
                    <label style="color:#aaa; font-size:0.8rem;">Fecha del WOD:</label>
                    <input type="date" value="@nuevoWod.FechaProgramacion.ToString("yyyy-MM-dd")" @onchange="AlCambiarFechaWod" class="form-control input-dark" />
                </div>

                @if (cargandoOperacionWod)
                {
                    <div class="text-center py-5">
                        <div class="spinner-border text-warning" role="status"></div>
                        <p class="mt-2 text-muted">Verificando...</p>
                    </div>
                }
                else if (wodExiste)
                {
                    <div class="alert-conflict fade-in">
                        <i class="fas fa-exclamation-triangle conflict-icon"></i>
                        <h4>¡YA EXISTE UN WOD!</h4>
                        <p>Hay una rutina programada para esta fecha.</p>
                        <div class="d-grid gap-2 mt-4">
                            <button class="btn btn-outline-warning" @onclick="CargarWodParaEditar"><i class="fas fa-edit"></i> EDITAR EXISTENTE</button>
                            <button class="btn btn-outline-danger" @onclick="EliminarWodActual"><i class="fas fa-trash"></i> ELIMINAR TODO</button>
                        </div>
                    </div>
                }
                else
                {
                    <div class="fade-in">
                        @foreach (var bloque in listaBloquesEditor)
                        {
                            <div class="card p-2 mb-3" style="background-color: #252525; border: 1px solid #444;">

                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span style="color:#F8C545; font-weight:bold; font-family:'Oswald'">BLOQUE</span>
                                    <button class="btn-icon delete-btn" @onclick="() => EliminarBloque(bloque)"><i class="fas fa-trash"></i></button>
                                </div>

                                <select @bind="bloque.SegmentoClaseID" class="form-control input-dark mb-2">
                                    <option value="@Guid.Empty" selected disabled>-- Selecciona Segmento --</option>
                                    @foreach (var seg in listaSegmentos)
                                    {
                                        <option value="@seg.Id">@seg.Nombre</option>
                                    }
                                </select>

                                @foreach (var ejercicio in bloque.Ejercicios)
                                {
                                    <div class="ejercicio-row fade-in">

                                        @* 1. REPS *@
                                        <div class="input-group-reps">
                                            <input type="text" @bind="ejercicio.Reps" class="form-control input-dark text-center" placeholder="Reps" />
                                        </div>

                                        @* 2. NOMBRE *@
                                        <div class="input-group-name">
                                            <input type="text" @bind="ejercicio.NombreBase" class="form-control input-dark" placeholder="Ejercicio" />
                                        </div>

                                        @* 3. BOTÓN PESOS (ABRE EL BOTTOM SHEET) *@
                                        <div>
                                            <button class="btn-icon weight-btn @(ejercicio.TienePesos ? "active" : "")"
                                                    @onclick="() => AbrirEditorPeso(ejercicio)">
                                                <i class="fas fa-dumbbell"></i>
                                                @if (ejercicio.TienePesos)
                                                {
                                                    <span class="dot-indicator"></span>
                                                }
                                            </button>
                                        </div>

                                        @* 4. ELIMINAR *@
                                        <button class="btn-icon delete-btn" @onclick="() => EliminarEjercicio(bloque, ejercicio)">
                                            <i class="fas fa-times"></i>
                                        </button>

                                    </div>
                                }

                                <button class="btn-add-ejercicio" @onclick="() => AgregarEjercicio(bloque)">
                                    <i class="fas fa-plus"></i> Ejercicio
                                </button>
                            </div>
                        }

                        <button class="btn btn-outline-warning w-100 py-2" @onclick="AgregarBloque">+ Bloque</button>
                    </div>
                }
            </div>

            @if (!wodExiste && !cargandoOperacionWod)
            {
                <div class="modal-footer">
                    <button class="btn btn-warning w-100" style="background-color:#F8C545; font-weight:bold;" @onclick="GuardarProgramacion">GUARDAR WOD</button>
                </div>
            }
        </div>
    </div>
}

@* --- BOTTOM SHEET (EDITOR DE PESOS) --- *@
@if (mostrarModalPeso && ejercicioEnEdicion != null)
{
    @* Fondo oscuro (Backdrop) *@
    <div class="sheet-backdrop visible" @onclick="CerrarEditorPeso"></div>

    @* El Panel Deslizante *@
    <div class="bottom-sheet slide-in-bottom">
        
        <div class="sheet-handle"></div>

        <div class="text-center mb-4">
            <h5 style="color:#F8C545; font-family:'Oswald'; margin:0;">PESOS (Rx)</h5>
            <p style="color:#888; font-size:0.8rem; margin-top:5px;">
                @(string.IsNullOrEmpty(ejercicioEnEdicion.NombreBase) ? "Ejercicio" : ejercicioEnEdicion.NombreBase)
            </p>
        </div>

        <div class="row">
            <div class="col-6">
                <label style="color:white; font-size:0.8rem; display:block; text-align:center;">HOMBRE</label>
                <div class="input-group-animated">
                    <input type="text" @bind="ejercicioEnEdicion.PesoH" 
                           class="form-control input-dark text-center" 
                           style="font-size:1.5rem; color:#F8C545; font-weight:bold; border: 1px solid #333;" 
                           placeholder="--" />
                </div>
            </div>
            <div class="col-6">
                <label style="color:white; font-size:0.8rem; display:block; text-align:center;">MUJER</label>
                <div class="input-group-animated">
                    <input type="text" @bind="ejercicioEnEdicion.PesoM" 
                           class="form-control input-dark text-center" 
                           style="font-size:1.5rem; color:#F8C545; font-weight:bold; border: 1px solid #333;" 
                           placeholder="--" />
                </div>
            </div>
        </div>

        <button class="btn btn-warning w-100 mt-4 py-3" 
                style="background:#F8C545; font-weight:bold; border-radius:50px;" 
                @onclick="CerrarEditorPeso">
            GUARDAR <i class="fas fa-check"></i>
        </button>
    </div>
}

@* --- RESTO DE MODALES (Avisos, Horarios) --- *@
@if (mostrarModalCrearAviso)
{
    <div class="modal-overlay">
        <div class="modal-content custom-modal">
            <div class="modal-header">
                <h5 style="margin:0; color: #F8C545; font-weight:bold; font-family:'Oswald';"><i class="fas fa-bullhorn" style="margin-right:8px;"></i> NUEVO AVISO</h5>
                <button class="btn-close-custom" @onclick="() => mostrarModalCrearAviso = false"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <label style="color: white !important; font-weight: bold; margin-bottom: 5px; display: block;">Título:</label>
                <input type="text" @bind="nuevoAviso.Titulo" class="form-control input-dark mb-3" placeholder="Ej: Horario Festivo" style="color: white;" />
                <label style="color: white !important; font-weight: bold; margin-bottom: 5px; display: block;">Mensaje:</label>
                <textarea @bind="nuevoAviso.Mensaje" class="form-control input-dark mb-3" rows="5" placeholder="Escribe aquí la información..." style="color: white;"></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" @onclick="() => mostrarModalCrearAviso = false">Cancelar</button>
                <button class="btn-confirm" @onclick="PublicarAviso">PUBLICAR</button>
            </div>
        </div>
    </div>
}

@if (mostrarAvisoPopUp && ultimoAviso != null)
{
    <div class="modal-overlay pop-up-effect">
        <div class="modal-content aviso-content">
            <div class="aviso-icon"><i class="fas fa-bullhorn"></i></div>
            <h3 class="aviso-title">@ultimoAviso.Titulo</h3>
            <div class="aviso-date">@ultimoAviso.FechaCreacion.GetValueOrDefault().ToString("dd/MM/yyyy")</div>
            <div class="aviso-body">@ultimoAviso.Mensaje</div>
            <button class="btn-ok" @onclick="CerrarAviso">ENTERADO</button>
        </div>
    </div>
}

@if (mostrarModalHorarios)
{
    <div class="modal-overlay">
        <div class="modal-content custom-modal">
            <div class="modal-header">
                <h5 style="margin:0; color:#F8C545; font-weight:bold;">
                    <i class="fas fa-clock"></i> HORARIOS DEL BOX
                </h5>
                <button class="btn-close-custom" @onclick="() => mostrarModalHorarios = false"><i class="fas fa-times"></i></button>
            </div>

            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">

                <div class="add-section mb-4">
                    <label class="lbl-input">Nuevo Horario (Ej: 7:00 AM)</label>
                    <div class="input-group">
                        <input type="text" @bind="nuevoHorarioTexto" class="form-control input-dark" placeholder="Escribe el horario..." />
                        <button class="btn btn-warning" @onclick="AgregarHorario" style="background-color:#F8C545; color:black; font-weight:bold;">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>

                <hr style="border-color:#333;" />

                <h6 style="color:white; margin-bottom:15px;">Horarios Activos:</h6>

                @if (listaHorariosAdmin == null)
                {
                    <div class="text-center text-muted">Cargando...</div>
                }
                else if (listaHorariosAdmin.Count == 0)
                {
                    <div class="text-center text-muted">No hay horarios registrados.</div>
                }
                else
                {
                    <div class="horarios-list">
                        @foreach (var h in listaHorariosAdmin)
                        {
                            <div class="horario-row">
                                <span class="horario-text">@h.Descripcion</span>
                                <button class="btn-delete-mini" @onclick="() => EliminarHorario(h.HorarioID)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
}

<style>
    /* --- Z-INDEX CORREGIDO (IMPORTANTÍSIMO) --- */
    .menu-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 90; background: transparent; }
    .navbar-container { position: relative; flex-shrink: 0; padding-top: calc(env(safe-area-inset-top) + 5px); padding-bottom: 10px; padding-left: 20px; padding-right: 20px; background-color: #0d0d0d; border-bottom: 1px solid #F8C545; color: white; display: flex; justify-content: space-between; align-items: center; z-index: 100; font-family: 'Oswald'; height: auto; min-height: 60px; }
    
    /* --- ESTILOS MARCA DE AGUA (NUEVO) --- */
    .watermark {
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        width: 70%; max-width: 500px; aspect-ratio: 1/1;
        background-repeat: no-repeat; background-position: center; background-size: contain;
        opacity: 0.35; /* Muy sutil */
        z-index: 0; pointer-events: none;
    }
    
    /* --- LOGO EN NAVBAR (NUEVO) --- */
    .nav-logo { height: 40px; width: 40px; border-radius: 50%; object-fit: cover; margin-right: 10px; border: 1px solid #F8C545; }
    .brand { display: flex; align-items: center; font-size: 1.3rem; font-weight: bold; }

    /* Aseguramos que el contenido vaya encima de la marca de agua */
    .scrollable-content { flex-grow: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; align-items: center; -webkit-overflow-scrolling: touch; padding-bottom: 40px; z-index: 10; position: relative; }

    /* RESTO DE ESTILOS (Sin cambios que rompan) */
    .sheet-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 4000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease; }
    .sheet-backdrop.visible { opacity: 1; visibility: visible; }
    .bottom-sheet { position: fixed; bottom: 0; left: 0; width: 100%; background: #1a1a1a; border-top-left-radius: 25px; border-top-right-radius: 25px; border-top: 3px solid #F8C545; padding: 25px 20px 40px 20px; z-index: 4001; box-shadow: 0 -5px 25px rgba(0,0,0,0.8); }
    .slide-in-bottom { animation: slideInBottom 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    @@keyframes slideInBottom { from { bottom: -100%; } to { bottom: 0; } }
    .sheet-handle { width: 50px; height: 5px; background: #444; border-radius: 10px; margin: 0 auto 20px auto; }
    .main-dropdown { position: absolute; top: 45px; right: 0; width: 260px; background: #1a1a1a; border: 1px solid #F8C545; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.9); overflow-y: auto; -webkit-overflow-scrolling: touch; max-height: calc(100vh - 80px); z-index: 2000; padding-bottom: 5px; animation: slideDown 0.2s ease-out; }
    
    .ejercicio-row { display: flex; align-items: center; gap: 8px; background: #1f1f1f; padding: 8px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #333; }
    .input-group-reps { flex: 0 0 70px; }
    .input-group-name { flex: 1; }
    .input-dark { background: #121212 !important; border: 1px solid #444; color: white !important; font-size: 0.9rem; height: 38px; }
    .input-dark:focus { border-color: #F8C545; box-shadow: 0 0 5px rgba(248, 197, 69, 0.3); }
    .btn-icon { width: 38px; height: 38px; border: none; border-radius: 6px; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: all 0.2s; position: relative; }
    .weight-btn { background: #333; color: #888; }
    .weight-btn:hover { background: #444; color: #F8C545; }
    .weight-btn.active { color: #F8C545; border: 1px solid #F8C545; background: rgba(248, 197, 69, 0.1); }
    .dot-indicator { position: absolute; top: 4px; right: 4px; width: 6px; height: 6px; background: #F8C545; border-radius: 50%; }
    .delete-btn { background: transparent; color: #666; }
    .delete-btn:hover { background: rgba(220, 53, 69, 0.2); color: #dc3545; }
    .btn-add-ejercicio { width: 100%; background: transparent; border: 1px dashed #555; color: #888; padding: 8px; border-radius: 8px; margin-top: 5px; transition: 0.2s; }
    .btn-add-ejercicio:hover { border-color: #F8C545; color: #F8C545; background: rgba(248, 197, 69, 0.05); }
    .planes-selection-grid { display: flex; flex-direction: column; gap: 15px; width: 100%; }
    @@media (min-width: 400px) { .planes-selection-grid { flex-direction: row; } }
    .plan-option-card { background: #2a2a2a; border: 1px solid #444; border-radius: 12px; padding: 20px; flex: 1; cursor: pointer; transition: all 0.2s ease; position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .plan-option-card:hover { background: #333; border-color: #F8C545; transform: translateY(-3px); box-shadow: 0 5px 15px rgba(248, 197, 69, 0.2); }
    .plan-option-card.recommended { border: 2px solid #F8C545; background: rgba(248, 197, 69, 0.05); }
    .badge-save { position: absolute; top: -10px; background: #F8C545; color: black; font-size: 0.65rem; font-weight: bold; padding: 4px 10px; border-radius: 10px; text-transform: uppercase; font-family: 'Oswald'; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
    .plan-title { font-family: 'Oswald'; font-size: 1.1rem; color: #ddd; margin-bottom: 5px; letter-spacing: 1px; }
    .plan-price { font-family: 'Oswald'; font-size: 1.8rem; color: white; font-weight: bold; margin-bottom: 5px; }
    .plan-note { font-size: 0.75rem; color: #888; font-family: 'Roboto'; }
    .main-layout { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: #0d0d0d; display: flex; flex-direction: column; z-index: 1; }
    .right-actions { display: flex; align-items: center; gap: 15px; }
    .welcome-section h1 { font-family: 'Oswald'; color: #F8C545; font-size: 1.8rem; margin-bottom: 20px; text-align: center; margin-top: 10px; }
    .cards-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; width: 100%; max-width: 1000px; }
    .menu-card { background-color: #F8C545; color: black; width: 46%; max-width: 160px; height: 150px; border-radius: 15px; padding: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; box-shadow: 0 4px 10px rgba(248, 215, 131, 0.2); cursor: pointer; transition: transform 0.2s; }
    .menu-card:active { transform: scale(0.95); }
    .menu-card h3 { font-family: 'Oswald'; font-size: 0.9rem; font-weight: bold; margin: 0; line-height: 1.2; }
    .menu-card p { font-size: 0.65rem; font-family: 'Roboto'; line-height: 1.1; margin-top: 4px; }
    .card-icon { font-size: 2rem; margin-bottom: 8px; }
    .yellow-highlight { background: #F8C545 !important; color: black !important; border: 2px solid white; animation: pulseBorder 2s infinite; position: relative; }
    .yellow-highlight h3, .yellow-highlight p, .yellow-highlight i { color: black !important; }
    .live-badge { position: absolute; top: 8px; right: 8px; background: red; color: white; font-size: 0.55rem; padding: 2px 5px; border-radius: 4px; font-weight: bold; }
    .footer-brand { margin-top: auto; padding: 20px; color: #F8C545; font-family: 'Oswald'; }
    .payment-alert { margin-bottom: 15px; padding: 12px; border-radius: 10px; display: flex; align-items: center; gap: 10px; width: 100%; max-width: 600px; }
    .payment-alert.warning { background: linear-gradient(90deg, #ffc107 0%, #ff9800 100%); color: black; }
    .payment-alert.expired { background: linear-gradient(90deg, #dc3545 0%, #c82333 100%); color: white; }
    .alert-icon { font-size: 1.2rem; }
    .alert-text { flex: 1; display: flex; flex-direction: column; font-size: 0.8rem; }
    .main-menu-wrapper { position: relative; cursor: pointer; display: flex; align-items: center; gap: 10px; }
    .user-name { font-size: 0.9rem; font-weight: bold; display: none; }
    @@media(min-width: 768px) { .user-name { display: block; } }
    .menu-burger { font-size: 1.5rem; color: #F8C545; }
    .dropdown-header { font-size: 0.7rem; color: #888; padding: 10px 15px 5px 15px; font-weight: bold; letter-spacing: 1px; }
    .admin-header { color: #F8C545; text-transform: uppercase; border-top: 1px solid #333; margin-top: 5px; }
    .dropdown-item { padding: 12px 20px; color: #ffffff !important; cursor: pointer; font-family: 'Roboto', sans-serif; font-size: 0.9rem; display: flex; align-items: center; gap: 12px; transition: background 0.2s; }
    .dropdown-item:hover { background-color: #333; color: #F8C545 !important; }
    .dropdown-divider { height: 1px; background: #333; margin: 5px 0; }
    .noti-wrapper { position: relative; cursor: pointer; }
    .noti-icon { font-size: 1.3rem; color: white; }
    .noti-dot { position: absolute; top: -2px; right: -2px; width: 8px; height: 8px; background: red; border-radius: 50%; border: 2px solid #0d0d0d; }
    .bell-ring { animation: ring 4s .7s ease-in-out infinite; color: #F8C545; }
    .noti-dropdown { position: absolute; top: 35px; right: -50px; width: 280px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); overflow: hidden; z-index: 1000; max-height: 300px; overflow-y: auto; }
    .noti-item { padding: 12px; border-bottom: 1px solid #333; font-size: 0.8rem; display: flex; align-items: center; gap: 10px; color: #ccc; }
    .noti-item.unread { background: #2a2a2a; color: white; border-left: 3px solid #F8C545; }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 3000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(4px); padding: 20px; }
    .custom-modal { background: #1a1a1a; width: 100%; max-width: 400px; border-radius: 12px; border: 1px solid #F8C545; display: flex; flex-direction: column; color: white; max-height: 85vh; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    .modal-header { padding: 15px; background: #222; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
    .modal-body { padding: 20px; overflow-y: auto; flex-grow: 1; -webkit-overflow-scrolling: touch; padding-bottom: 100px; }
    .modal-footer { padding: 15px; background: #222; border-top: 1px solid #333; display: flex; gap: 10px; flex-shrink: 0; }
    .btn-close-custom { background: none; border: none; color: white; font-size: 1.2rem; }
    .btn-confirm { background: #F8C545; color: black; border: none; padding: 10px; font-weight: bold; flex: 1; border-radius: 5px; }
    .btn-cancel { background: #333; color: white; border: none; padding: 10px; font-weight: bold; flex: 1; border-radius: 5px; }
    .delete-account-container { width: 100%; max-width: 1000px; display: flex; justify-content: center; margin-top: 30px; margin-bottom: 10px; padding: 0 20px; }
    .btn-delete-account { background: transparent; border: 1px solid #ff4444; color: #ff4444; font-family: 'Oswald', sans-serif; font-size: 0.8rem; font-weight: bold; text-transform: uppercase; padding: 8px 20px; border-radius: 50px; cursor: pointer; transition: all 0.3s ease; letter-spacing: 1px; opacity: 0.8; }
    @@keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    @@keyframes ring { 0% { transform: rotate(0); } 5% { transform: rotate(30deg); } 10% { transform: rotate(-28deg); } 15% { transform: rotate(34deg); } 20% { transform: rotate(-32deg); } 25% { transform: rotate(30deg); } 30% { transform: rotate(-28deg); } 35% { transform: rotate(26deg); } 40% { transform: rotate(-24deg); } 45% { transform: rotate(22deg); } 50% { transform: rotate(-20deg); } 100% { transform: rotate(0); } }
    @@keyframes bounceIn { 0% { transform: scale(0.3); opacity: 0; } 50% { transform: scale(1.05); } 100% { transform: scale(1); opacity: 1; } }
    @@keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    @@keyframes pulseBorder { 0% { box-shadow: 0 0 0 0 rgba(248, 197, 69, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(248, 197, 69, 0); } 100% { box-shadow: 0 0 0 0 rgba(248, 197, 69, 0); } }
    .alert-conflict { background: #111; border: 2px solid #dc3545; border-radius: 10px; padding: 30px 20px; text-align: center; animation: fadeIn 0.3s ease-in; }
    .conflict-icon { font-size: 3rem; color: #dc3545; margin-bottom: 15px; animation: pulse 2s infinite; }
    .alert-conflict h4 { color: white; font-family: 'Oswald'; letter-spacing: 1px; margin-bottom: 10px; }
    .alert-conflict p { color: #ccc; margin-bottom: 5px; }
    .fade-in { animation: fadeIn 0.3s ease-in; }
    .modal-dialog-centered { display: flex; align-items: center; min-height: calc(100% - 1rem); }
    .horario-row { display: flex; justify-content: space-between; align-items: center; background-color: #222; padding: 12px 15px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #333; }
    .horario-text { color: white; font-weight: bold; font-family: 'Oswald'; }
    .btn-delete-mini { background: none; border: none; color: #dc3545; cursor: pointer; padding: 5px; }
    .aviso-content { width: 90%; max-width: 400px; background: #1a1a1a; border-radius: 12px; text-align: center; border: 2px solid #F8C545; padding-bottom: 20px; box-shadow: 0 0 20px rgba(248, 197, 69, 0.3); animation: bounceIn 0.6s; overflow: hidden; }
    .aviso-icon { font-size: 3rem; color: #F8C545; margin-top: 20px; animation: pulse 2s infinite; }
    .aviso-title { font-family: 'Oswald'; color: white; font-size: 1.5rem; margin: 10px 20px; text-transform: uppercase; }
    .aviso-date { color: #888; font-size: 0.8rem; margin-bottom: 15px; }
    .aviso-body { padding: 0 25px 20px 25px; color: #ddd; }
    .btn-ok { width: 80%; margin: 0 auto 25px auto; background: linear-gradient(45deg, #F8C545, #ffb300); border: none; padding: 12px; font-weight: bold; border-radius: 30px; color: black; }
</style>

@code {

    // --- CLASES AUXILIARES ---
    public class EjercicioEditorViewModel
    {
        public string Reps { get; set; }
        public string NombreBase { get; set; }
        public string PesoH { get; set; }
        public string PesoM { get; set; }
        public bool TienePesos => !string.IsNullOrEmpty(PesoH) || !string.IsNullOrEmpty(PesoM);
    }

    public class BloqueEditorViewModel
    {
        public Guid SegmentoClaseID { get; set; }
        public string NombreSegmento { get; set; } 
        public List<EjercicioEditorViewModel> Ejercicios { get; set; } = new List<EjercicioEditorViewModel>();
    }

    // --- VARIABLES DE ESTADO ---
    private bool abriendoCamara = false;
    private bool procesandoLectura = false;
    private bool mostrarMenuPrincipal = false;
    private bool EsAdmin = false;
    private string NombreBox = "MVAPP";
    // --- NUEVO: GUARDAR ID DEL LOGO ---
    private Guid? LogoBoxId; 
    // Generar URL (igual que en ConfigBox)
    private string UrlLogo => LogoBoxId.HasValue ? $"https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/Imagenes/Logos/{LogoBoxId}.jpg" : "";

    private bool tieneRutina = false;
    private bool mostrarNotis = false;
    private bool hayNuevas = false;
    private List<NotificacionDto> misNotificaciones;
    private bool tieneRunning = false;
    private int diasRestantes = 99;
    private readonly Guid IdCanaHueca = Guid.Parse("39BE552A-4A34-4EF5-9351-193F1D0B1340");

    private bool wodExiste = false;
    private bool cargandoOperacionWod = false;
    private bool mostrarModalWod = false;

    // --- VARIABLES NUEVAS PARA EL EDITOR DE PESOS ---
    private bool mostrarModalPeso = false;
    private EjercicioEditorViewModel ejercicioEnEdicion;

    // Usamos esto para la fecha
    private ProgramacionWodViewModel nuevoWod = new ProgramacionWodViewModel();
    // Usamos esto para la UI del editor
    private List<BloqueEditorViewModel> listaBloquesEditor = new List<BloqueEditorViewModel>();

    private List<SegmentoDto> listaSegmentos = new List<SegmentoDto>();

    private bool boxTieneMP = false;
    public class PlanDto { public int PlanID { get; set; } public string Nombre { get; set; } public decimal Precio { get; set; } }
    private List<PlanDto> listaPlanes = new List<PlanDto>();
    private bool mostrarModalPlanesAdmin = false;

    private bool mostrarModalCrearAviso = false;
    private bool mostrarAvisoPopUp = false;
    private Avisos nuevoAviso = new Avisos();
    private Avisos ultimoAviso;
    private static bool avisoVistoEnSesion = false;

    private bool mostrarModalModulos = false;
    public class BoxConfigDTO { public bool EstaVinculadoMP { get; set; } }
    private List<ModuloConfig> listaConfiguracion = new List<ModuloConfig>();

    private bool mostrarModalPassword = false;
    private bool procesandoPass = false;
    private string passOld = "";
    private string passNew = "";
    private string passConfirm = "";
    private string msgErrorPass = "";
    private string tipoInputOld = "password";
    private string tipoInputNew = "password";
    private string tipoInputConfirm = "password";

    private bool mostrarModalHorarios = false;
    private string nuevoHorarioTexto = "";
    private List<HorarioDto> listaHorariosAdmin;
    public class HorarioDto { public Guid HorarioID { get; set; } public string Descripcion { get; set; } public Guid BoxID { get; set; } }

    protected override async Task OnInitializedAsync()
    {
        if (Sesion.Usuario == null) { Nav.NavigateTo("/"); return; }
        EsAdmin = Sesion.Usuario.TipoUsuarioID == 1;
        await CargarNombreBox();
        await CargarNotificaciones();
        await CargarSegmentos();
        await CargarConfiguracionModulos();
        if (!avisoVistoEnSesion) await CargarUltimoAviso();
        try { tieneRutina = await Http.GetFromJsonAsync<bool>($"https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/rutinasapi/tiene-rutina/{Sesion.Usuario.UsuarioID}"); } catch { tieneRutina = false; }
        try { tieneRunning = await Http.GetFromJsonAsync<bool>($"https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/runningapi/tiene-plan/{Sesion.Usuario.UsuarioID}"); } catch { tieneRunning = false; }
        if (Sesion.Usuario != null)
        {
            try
            {
                var estado = await Http.GetFromJsonAsync<int>($"https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/pagosapi/dias-restantes/{Sesion.Usuario.UsuarioID}");
                diasRestantes = estado;
            }
            catch { }
            try
            {
                var configBox = await Http.GetFromJsonAsync<BoxConfigDTO>($"https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/boxesAPI/config/{Sesion.Usuario.BoxID}");
                if (configBox != null) boxTieneMP = configBox.EstaVinculadoMP;
            }
            catch { boxTieneMP = false; }
        }
        try { listaPlanes = await Http.GetFromJsonAsync<List<PlanDto>>("https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/pagosapi/planes"); } catch { }
    }

    // --- FUNCIONES MENÚS Y OVERLAY ---
    private void CerrarTodosLosMenus()
    {
        mostrarMenuPrincipal = false;
        mostrarNotis = false;
    }

    private void ToggleMainMenu()
    {
        mostrarMenuPrincipal = !mostrarMenuPrincipal;
        if (mostrarMenuPrincipal) mostrarNotis = false;
    }

    private void ToggleNotificaciones()
    {
        mostrarNotis = !mostrarNotis;
        if (mostrarNotis)
        {
            mostrarMenuPrincipal = false;
            if (hayNuevas)
            {
                hayNuevas = false;
                _ = Http.PostAsync($"https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/SocialApi/notificaciones/leer/{Sesion.Usuario.UsuarioID}", null);
            }
        }
    }

    // --- LOGICA MODAL WOD ---
    private async void AbrirModalWod()
    {
        CerrarTodosLosMenus();
        nuevoWod = new ProgramacionWodViewModel { FechaProgramacion = DateTime.Today };
        mostrarModalWod = true;
        await VerificarWodExistente(DateTime.Today);
    }

    private async Task AlCambiarFechaWod(ChangeEventArgs e)
    {
        if (DateTime.TryParse(e.Value.ToString(), out DateTime fecha))
        {
            nuevoWod.FechaProgramacion = fecha;
            await VerificarWodExistente(fecha);
        }
    }

    private async Task VerificarWodExistente(DateTime fecha)
    {
        cargandoOperacionWod = true; wodExiste = false; StateHasChanged();
        try
        {
            var fechaStr = fecha.ToString("yyyy-MM-dd");
            wodExiste = await Http.GetFromJsonAsync<bool>($"https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/wodapi/existe/{Sesion.Usuario.BoxID}/{fechaStr}");

            if (!wodExiste)
            {
                listaBloquesEditor = new List<BloqueEditorViewModel>();
                AgregarBloque();
            }
        }
        catch
        {
            wodExiste = false;
            listaBloquesEditor = new List<BloqueEditorViewModel>();
            AgregarBloque();
        }
        finally
        {
            cargandoOperacionWod = false;
            StateHasChanged();
        }
    }

    private async Task CargarWodParaEditar()
    {
        cargandoOperacionWod = true;
        try
        {
            var fechaStr = nuevoWod.FechaProgramacion.ToString("yyyy-MM-dd");
            var wodExistente = await Http.GetFromJsonAsync<ProgramacionWodViewModel>($"https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/wodapi/obtener/{Sesion.Usuario.BoxID}/{fechaStr}");

            if (wodExistente != null)
            {
                nuevoWod = wodExistente;
                wodExiste = false;

                listaBloquesEditor = new List<BloqueEditorViewModel>();
                foreach (var b in wodExistente.Bloques)
                {
                    var bloqueEdit = new BloqueEditorViewModel
                    {
                        SegmentoClaseID = b.SegmentoClaseID,
                        NombreSegmento = b.NombreSegmento,
                        Ejercicios = new List<EjercicioEditorViewModel>()
                    };

                    foreach (var ej in b.Ejercicios)
                    {
                        bloqueEdit.Ejercicios.Add(new EjercicioEditorViewModel
                        {
                            Reps = ej.PesoRepeticiones,
                            NombreBase = ej.Descripcion
                        });
                    }
                    listaBloquesEditor.Add(bloqueEdit);
                }
            }
        }
        catch (Exception ex)
        {
            await App.Current.MainPage.DisplayAlert("Error", "No se pudo cargar el WOD: " + ex.Message, "OK");
        }
        finally
        {
            cargandoOperacionWod = false;
        }
    }

    private async Task EliminarWodActual()
    {
        bool confirmar = await App.Current.MainPage.DisplayAlert("Confirmar", "¿Eliminar WOD completo?", "Sí", "No");
        if (confirmar)
        {
            cargandoOperacionWod = true;
            try
            {
                var fechaStr = nuevoWod.FechaProgramacion.ToString("yyyy-MM-dd");
                var response = await Http.PostAsync($"https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/wodapi/eliminar-dia/{Sesion.Usuario.BoxID}/{fechaStr}", null);
                if (response.IsSuccessStatusCode)
                {
                    await App.Current.MainPage.DisplayAlert("Éxito", "WOD eliminado.", "OK");
                    wodExiste = false;
                    listaBloquesEditor = new List<BloqueEditorViewModel>();
                    AgregarBloque();
                }
                else
                {
                    string error = await response.Content.ReadAsStringAsync();
                    await App.Current.MainPage.DisplayAlert("Error", error, "OK");
                }
            }
            catch (Exception ex)
            {
                await App.Current.MainPage.DisplayAlert("Excepción", ex.Message, "OK");
            }
            finally
            {
                cargandoOperacionWod = false;
            }
        }
    }

    // --- LOGICA EDITOR ---
    private void AgregarBloque() => listaBloquesEditor.Add(new BloqueEditorViewModel { Ejercicios = new List<EjercicioEditorViewModel> { new EjercicioEditorViewModel() } });
    private void EliminarBloque(BloqueEditorViewModel b) => listaBloquesEditor.Remove(b);
    private void AgregarEjercicio(BloqueEditorViewModel b) => b.Ejercicios.Add(new EjercicioEditorViewModel());
    private void EliminarEjercicio(BloqueEditorViewModel b, EjercicioEditorViewModel e) => b.Ejercicios.Remove(e);

    // --- NUEVA LÓGICA DE EDITOR DE PESOS ---
    private void AbrirEditorPeso(EjercicioEditorViewModel ej)
    {
        ejercicioEnEdicion = ej;
        mostrarModalPeso = true;
    }
    private void CerrarEditorPeso()
    {
        mostrarModalPeso = false;
        ejercicioEnEdicion = null;
    }

    private async Task GuardarProgramacion()
    {
        if (listaBloquesEditor.Count == 0)
        {
            await App.Current.MainPage.DisplayAlert("Faltan datos", "Agrega al menos un bloque.", "OK");
            return;
        }

        if (listaBloquesEditor.Any(b => b.SegmentoClaseID == Guid.Empty))
        {
            await App.Current.MainPage.DisplayAlert("Faltan datos", "Selecciona el TIPO DE SEGMENTO en todos los bloques.", "OK");
            return;
        }

        nuevoWod.Bloques = new List<BloqueWodViewModel>();

        foreach (var bEdit in listaBloquesEditor)
        {
            var bloqueApi = new BloqueWodViewModel
            {
                SegmentoClaseID = bEdit.SegmentoClaseID,
                Ejercicios = new List<EjercicioViewModel>()
            };

            var infoSegmento = listaSegmentos.FirstOrDefault(s => s.Id == bEdit.SegmentoClaseID);
            bloqueApi.NombreSegmento = infoSegmento != null ? infoSegmento.Nombre : "General";

            foreach (var ejEdit in bEdit.Ejercicios)
            {
                string descFinal = ejEdit.NombreBase;
                if (ejEdit.TienePesos)
                {
                    descFinal += $" ({ejEdit.PesoH}/{ejEdit.PesoM})";
                }

                bloqueApi.Ejercicios.Add(new EjercicioViewModel
                {
                    PesoRepeticiones = ejEdit.Reps,
                    Descripcion = descFinal
                });
            }
            nuevoWod.Bloques.Add(bloqueApi);
        }

        cargandoOperacionWod = true;
        StateHasChanged();

        try
        {
            nuevoWod.BoxID = Sesion.Usuario.BoxID;
            var r = await Http.PostAsJsonAsync("https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/wodapi/guardar", nuevoWod);

            if (r.IsSuccessStatusCode)
            {
                mostrarModalWod = false;
                await App.Current.MainPage.DisplayAlert("¡Éxito!", "WOD Guardado correctamente.", "OK");
                nuevoWod = new ProgramacionWodViewModel { FechaProgramacion = DateTime.Today };
                listaBloquesEditor = new List<BloqueEditorViewModel>();
                AgregarBloque();
            }
            else
            {
                var errorMsg = await r.Content.ReadAsStringAsync();
                await App.Current.MainPage.DisplayAlert("Error del Servidor", errorMsg, "OK");
            }
        }
        catch (Exception ex)
        {
            await App.Current.MainPage.DisplayAlert("Error de App", ex.Message, "OK");
        }
        finally
        {
            cargandoOperacionWod = false;
            StateHasChanged();
        }
    }

    // --- RESTO DE FUNCIONES ---
    private async Task AbrirModalHorarios() { CerrarTodosLosMenus(); mostrarModalHorarios = true; await CargarHorariosAdmin(); }
    private async Task CargarHorariosAdmin() { try { listaHorariosAdmin = await Http.GetFromJsonAsync<List<HorarioDto>>($"https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/AgendaApi/lista-horarios/{Sesion.Usuario.BoxID}"); } catch { listaHorariosAdmin = new List<HorarioDto>(); } }
    private async Task AgregarHorario() { if (string.IsNullOrWhiteSpace(nuevoHorarioTexto)) return; try { var nuevo = new HorarioDto { BoxID = Sesion.Usuario.BoxID, Descripcion = nuevoHorarioTexto }; var response = await Http.PostAsJsonAsync("https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/AgendaApi/crear-horario", nuevo); if (response.IsSuccessStatusCode) { nuevoHorarioTexto = ""; await CargarHorariosAdmin(); } else await App.Current.MainPage.DisplayAlert("Error", "No se pudo guardar.", "OK"); } catch (Exception ex) { await App.Current.MainPage.DisplayAlert("Error", ex.Message, "OK"); } }
    private async Task EliminarHorario(Guid id) { bool confirmar = await App.Current.MainPage.DisplayAlert("Eliminar", "¿Seguro?", "Sí", "No"); if (!confirmar) return; try { var response = await Http.DeleteAsync($"https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/AgendaApi/eliminar-horario/{id}"); if (response.IsSuccessStatusCode) { await CargarHorariosAdmin(); } else await App.Current.MainPage.DisplayAlert("Error", "No se pudo eliminar.", "OK"); } catch (Exception ex) { await App.Current.MainPage.DisplayAlert("Error", ex.Message, "OK"); } }
    private async Task ConfirmarEliminarCuenta() { bool confirmacion = await App.Current.MainPage.DisplayAlert("⚠️ Eliminar Cuenta", "¿Estás seguro de que quieres eliminar tu cuenta permanentemente? Perderás todo tu historial, fotos y pagos. Esta acción NO se puede deshacer.", "Sí, Eliminar", "Cancelar"); if (confirmacion) { try { var response = await Http.PostAsync($"https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/authapi/eliminar-definitivo/{Sesion.Usuario.UsuarioID}", null); if (response.IsSuccessStatusCode) { await App.Current.MainPage.DisplayAlert("Cuenta Eliminada", "Lamentamos que te vayas. Tu cuenta ha sido borrada.", "Adiós"); CerrarSesion(); } else { string mensajeError = await response.Content.ReadAsStringAsync(); await App.Current.MainPage.DisplayAlert("Error", $"No se pudo eliminar: {mensajeError}", "OK"); } } catch (Exception ex) { await App.Current.MainPage.DisplayAlert("Error de Conexión", ex.Message, "OK"); } } }
    private void AbrirModalPassword() { CerrarTodosLosMenus(); passOld = ""; passNew = ""; passConfirm = ""; msgErrorPass = ""; procesandoPass = false; mostrarModalPassword = true; }
    private void ToggleVerPass(int campo) { if (campo == 1) tipoInputOld = tipoInputOld == "password" ? "text" : "password"; if (campo == 2) tipoInputNew = tipoInputNew == "password" ? "text" : "password"; if (campo == 3) tipoInputConfirm = tipoInputConfirm == "password" ? "text" : "password"; }
    private async Task GuardarNuevaPassword() { if (string.IsNullOrWhiteSpace(passOld) || string.IsNullOrWhiteSpace(passNew) || string.IsNullOrWhiteSpace(passConfirm)) { msgErrorPass = "Todos los campos son obligatorios"; return; } if (passNew != passConfirm) { msgErrorPass = "La contraseña nueva y la confirmación no coinciden"; return; } procesandoPass = true; msgErrorPass = ""; try { var req = new { UsuarioID = Sesion.Usuario.UsuarioID, OldPassword = passOld, NewPassword = passNew, ConfirmPassword = passConfirm }; var response = await Http.PostAsJsonAsync("https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/authapi/cambiar-password", req); if (response.IsSuccessStatusCode) { await App.Current.MainPage.DisplayAlert("¡Éxito!", "Tu contraseña ha sido actualizada.", "OK"); mostrarModalPassword = false; } else { var errorJson = await response.Content.ReadFromJsonAsync<System.Text.Json.JsonElement>(); if (errorJson.TryGetProperty("mensaje", out var msg)) msgErrorPass = msg.GetString(); else msgErrorPass = "Error al actualizar la contraseña"; } } catch (Exception ex) { msgErrorPass = "Error de conexión: " + ex.Message; } finally { procesandoPass = false; } }
    
    // --- ACTUALIZADO PARA CARGAR EL LOGO ---
    private async Task CargarNombreBox()
    {
        try
        {
            var response = await Http.GetFromJsonAsync<Boxes>($"https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/configapi/nombre-box/{Sesion.Usuario.BoxID}");
            if (response != null)
            {
                if (!string.IsNullOrEmpty(response.Nombre))
                {
                    NombreBox = response.Nombre.ToUpper();
                }
                // Guardamos el Logo ID
                LogoBoxId = response.Logo;
            }
        }
        catch { }
    }

    private void AbrirGestionModulos() { CerrarTodosLosMenus(); mostrarModalModulos = true; }
    private async Task CargarConfiguracionModulos() { try { listaConfiguracion = await Http.GetFromJsonAsync<List<ModuloConfig>>($"https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/configapi/modulos/{Sesion.Usuario.BoxID}"); } catch { } }
    private async Task ToggleModulo(ModuloConfig mod) { mod.Activo = !mod.Activo; try { await Http.PostAsJsonAsync("https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/configapi/actualizar", mod); } catch { } }
    private bool EstaActivo(string clave) { if (listaConfiguracion == null || listaConfiguracion.Count == 0) return true; var mod = listaConfiguracion.FirstOrDefault(m => m.ModuloClave == clave); return mod == null ? true : mod.Activo; }
    
    private void CerrarSesion() { diasRestantes = 99; SecureStorage.Default.Remove("auth_token"); Sesion.Usuario = null; Nav.NavigateTo("/"); }
    private void IrAPerfil() => Nav.NavigateTo("/mi-perfil");
    private void IrAAgenda() => Nav.NavigateTo("/agenda-view");
    private void IrAWodView() => Nav.NavigateTo("/wod-view");
    private void IrAProgreso() => Nav.NavigateTo("/progreso-view");
    private void IrASeEntreno() => Nav.NavigateTo("/se-entreno");
    private void IrACompaneros() => Nav.NavigateTo("/entrenamos-juntos");
    private void IrARanking() => Nav.NavigateTo("/ranking");
    private void NavegarA(string destino) { CerrarTodosLosMenus(); switch (destino) { case "test": Nav.NavigateTo("/test-config"); break; case "usuarios": Nav.NavigateTo("/usuarios-view"); break; case "avisos": AbrirCrearAviso(); break; } }

    private async Task IrAPagar()
    {
        if (Sesion.Usuario == null) return;
        if (Sesion.Usuario.TipoUsuarioID == 2 && Sesion.Usuario.BoxID != IdCanaHueca)
        {
            if (boxTieneMP) { await ProcesarPago("Mensualidad", 0); }
            else { await App.Current.MainPage.DisplayAlert("Pago Presencial", "Tu box no ha configurado pagos en línea. Pasa a recepción.", "Entendido"); }
            return;
        }
        if (Sesion.Usuario.BoxID == IdCanaHueca)
        {
            var planPublico = listaPlanes.FirstOrDefault(p => p.PlanID == 3);
            if (planPublico != null) await ProcesarPago(planPublico.Nombre, planPublico.Precio);
            return;
        }
        if (Sesion.Usuario.TipoUsuarioID == 1)
        {
            if (DeviceInfo.Platform == DevicePlatform.iOS)
            {
                await App.Current.MainPage.DisplayAlert("Renovación", "Para renovar tu suscripción, por favor visita ontrackcrew.com desde tu navegador.", "Entendido");
                await Browser.OpenAsync("https://ontrackcrew.com.mx", BrowserLaunchMode.SystemPreferred);
            }
            else
            {
                mostrarModalPlanesAdmin = true;
            }
        }
    }

    private async Task ProcesarPago(string titulo, decimal precio) { try { var datosPago = new { Titulo = titulo, Precio = precio, UsuarioID = Sesion.Usuario.UsuarioID }; var response = await Http.PostAsJsonAsync("https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/mercadopago/crear-preferencia", datosPago); if (response.IsSuccessStatusCode) { var resultado = await response.Content.ReadFromJsonAsync<RespuestaMercadoPago>(); if (resultado != null && !string.IsNullOrEmpty(resultado.url)) { await Browser.Default.OpenAsync(resultado.url, BrowserLaunchMode.SystemPreferred); mostrarModalPlanesAdmin = false; } } else { string errorMsg = await response.Content.ReadAsStringAsync(); if (errorMsg.Contains("error")) { errorMsg = errorMsg.Replace("{", "").Replace("}", "").Replace("\"", "").Replace("error:", ""); } await App.Current.MainPage.DisplayAlert("Error en Pago", errorMsg, "OK"); } } catch (Exception ex) { await App.Current.MainPage.DisplayAlert("Error de Conexión", ex.Message, "OK"); } }
    private void AbrirCrearAviso() { CerrarTodosLosMenus(); nuevoAviso = new Avisos(); mostrarModalCrearAviso = true; }
    private async Task PublicarAviso() { if (string.IsNullOrEmpty(nuevoAviso.Titulo)) return; try { nuevoAviso.BoxID = Sesion.Usuario.BoxID; var r = await Http.PostAsJsonAsync("https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/avisosapi/crear", nuevoAviso); if (r.IsSuccessStatusCode) { mostrarModalCrearAviso = false; await App.Current.MainPage.DisplayAlert("Éxito", "Publicado", "OK"); } } catch { } }
    private async Task CargarUltimoAviso() { try { var r = await Http.GetAsync($"https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/avisosapi/ultimo/{Sesion.Usuario.BoxID}"); if (r.StatusCode == System.Net.HttpStatusCode.NoContent) return; if (r.IsSuccessStatusCode) { ultimoAviso = await r.Content.ReadFromJsonAsync<Avisos>(); if (ultimoAviso != null) { var idVisto = await JS.InvokeAsync<string>("localStorage.getItem", "ultimoAvisoVisto"); if (idVisto != ultimoAviso.AvisoID.ToString()) mostrarAvisoPopUp = true; } } } catch { } }
    private async Task CerrarAviso() { if (ultimoAviso != null) await JS.InvokeVoidAsync("localStorage.setItem", "ultimoAvisoVisto", ultimoAviso.AvisoID.ToString()); mostrarAvisoPopUp = false; }
    private async Task AbrirEscanerParaEntrar() { if (abriendoCamara) return; abriendoCamara = true; StateHasChanged(); await Task.Delay(100); try { var scannerPage = new EscanerPage(); Action<string> escanearHandler = null; escanearHandler = async (resultadoQr) => { scannerPage.OnScanResult -= escanearHandler; await Application.Current.Dispatcher.DispatchAsync(async () => { try { await Application.Current.MainPage.Navigation.PopModalAsync(); await Task.Delay(400); await ProcesarCheckIn(resultadoQr); } catch (Exception ex) { Console.WriteLine("Error cerrando cámara: " + ex.Message); } }); }; scannerPage.OnScanResult += escanearHandler; if (Application.Current.MainPage != null) { await Application.Current.MainPage.Navigation.PushModalAsync(scannerPage); } } catch (Exception ex) { await App.Current.MainPage.DisplayAlert("Error", "No se pudo iniciar la cámara.", "OK"); } finally { abriendoCamara = false; StateHasChanged(); } }
    private async Task ProcesarCheckIn(string boxIdLeido) { if (string.IsNullOrWhiteSpace(boxIdLeido)) { await App.Current.MainPage.DisplayAlert("QR Inválido", "No se detectó información en el código.", "OK"); return; } try { var request = new { UsuarioId = Sesion.Usuario.UsuarioID, QrData = boxIdLeido }; var response = await Http.PostAsJsonAsync("https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/liveapi/checkin-qr", request); if (response.IsSuccessStatusCode) { await App.Current.MainPage.DisplayAlert("¡Bienvenido! 💪", "Has entrado a la clase correctamente.", "A ENTRENAR"); } else { string msg = await response.Content.ReadAsStringAsync(); await App.Current.MainPage.DisplayAlert("Ups", "No se pudo registrar entrada: " + msg, "Intentar de nuevo"); } } catch (Exception ex) { await App.Current.MainPage.DisplayAlert("Error de Conexión", "Revisa tu internet.", "OK"); } }
    private async Task CargarSegmentos() { try { var r = await Http.GetAsync("https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/wodapi/segmentos"); if (r.IsSuccessStatusCode) listaSegmentos = await r.Content.ReadFromJsonAsync<List<SegmentoDto>>(); } catch { } }
    private async Task CargarNotificaciones() { try { misNotificaciones = await Http.GetFromJsonAsync<List<NotificacionDto>>($"https://apitcb.pladse.dsistemas.educacionchiapas.gob.mx/api/SocialApi/notificaciones/{Sesion.Usuario.UsuarioID}"); hayNuevas = misNotificaciones.Any(n => !n.Leido); } catch { } }
    private string GetIcono(string t) => t == "MATCH_MUTUO" ? "fas fa-heart text-danger" : "fas fa-bell";
    public class RespuestaMercadoPago { public string url { get; set; } }
}